"use strict";define(["ol","moment","sidebar","layermanager","query","search","permalink","measure","bootstrap","api","drag","compositions","pilsentraffic","calendar","ngtimeline"],function(ol,e){var a=angular.module("hs",["hs.layermanager","hs.query","hs.permalink","hs.api","hs.sidebar","hs.drag","hs.compositions","hs.pilsentraffic","hs.calendar","ngTimeline"]);return a.directive("hs",["hs.map.service","Core",function(e,a){return{templateUrl:hsl_path+"hslayers.html",link:function(e,t){a.fullScreenMap(t)}}}]),a.directive("hs.advancedInfopanelDirective",["$compile",function(e){return{templateUrl:"./partials/advanced_info.html?bust="+gitsha,link:function(a,t,i){var n=.85*$(window).height();$("#advanced-info-dialog .modal-body").css("overflow-y","auto"),$("#advanced-info-dialog .modal-body").css("max-height",n),$("timeline").attr("height",n),$("#advanced-info-dialog").modal("show"),t.find(".modal-body").append('<timeline control="timeline" height="'+(n-50)+'" options="options"></timeline>'),e(t.contents())(a)}}}]),a.directive("hs.topmenu",function(){return{templateUrl:"./partials/top-menu.html?bust="+gitsha}}),a.directive("hs.basemapmenu",["hs.layermanager.service",function(e){return{templateUrl:"./partials/basemap-menu.html?bust="+gitsha,link:function(a,t,i){a.data=e.data,a.changeBaseLayerVisibility=function(a,t){var i=$("#content-wrapper");"Satellite (ČUZK)"==t.title?i.addClass("air"):i.removeClass("air"),e.changeBaseLayerVisibility(a,t)}}}}]),a.directive("hs.trafficmenu",function(){return{restrict:"A",controller:["$scope",function(e){function a(e){}e.trafficLayerChanged=function(e,t){"INPUT"==t.target.tagName&&a()},e.items=[{label:"Události"},{label:"Uzavírky"},{label:"Stupně provozu"}],e.items.forEach(function(e){angular.isUndefined(e.check)&&(e.check=!1)}),e.setAll=function(t){e.items.forEach(function(e){e.check=t,a()})},e.isAll=function(a){for(var t=0;t<e.items.length;t++)if(e.items[t].check!=a)return!1;return!0}}],templateUrl:"./partials/traffic-menu.html?bust="+gitsha}}),a.value("config",{default_layers:[new ol.layer.Tile({source:new ol.source.OSM,title:"Grayscale (OSM)",base:!0,visible:!0}),new ol.layer.Tile({source:new ol.source.OSM,title:"Standard (OSM)",base:!0,visible:!1}),new ol.layer.Tile({source:new ol.source.OSM,title:"Base (ČUZK)",base:!0,visible:!1}),new ol.layer.Tile({source:new ol.source.OSM,title:"Satellite (ČUZK)",base:!0,visible:!1}),new ol.layer.Image({title:"Intenzita dopravy v Plzni - květen 2017",source:new ol.source.ImageWMS({url:"https://intenzitadopravy.plzen.eu/wms-t",params:{LAYERS:"may",INFO_FORMAT:"text/html",FORMAT:"image/png",TIME:"2017-05-01T00:00:00.000Z"},crossOrigin:"anonymous"}),dimensions:{time:{name:"time",units:"ISO8601",unitSymbol:null,default:"2017-05-01T00:00:00",nearestValue:!1,values:"2017-01-01T00:00:00/2099-12-31T00:00:00/PT1H"}},visible:!0,popupClass:"popup-headline",queryFilter:function(e,a,t){var i=!1;return e.forEachLayerAtPixel(t,function(e,t){a==e&&(i=!0)},void 0,function(e){return e instanceof ol.layer.Image}),i},featureInfoLang:{en:"http://gis.lesprojekt.cz/wms/transport/plzen_traffic_volumes"}})],default_view:new ol.View({center:[1488449.247038074,6404351.20261046],zoom:13,units:"m"}),showQueryPoint:!1}),a.controller("mapReset",["$scope","hs.map.service",function(e,a){e.resetView=function(){a.resetView()}}]),a.controller("Main",["$scope","Core","$compile","hs.map.service","$timeout","$http","hs.utils.service","hs.pilsentraffic.service","$rootScope","hs.layermanager.service",function(a,t,i,n,r,o,l,s,c,d){function u(){n.map.removeLayer(n.findLayerByTitle("Grayscale (OSM)"));for(var e,a=0;a<d.data.baselayers.length;a++)"Standard (OSM)"==d.data.baselayers[a].title&&(e=d.data.baselayers[a]);d.changeBaseLayerVisibility(!0,e)}function p(){var e=angular.element("<div hs.topmenu></div>");angular.element(".gui-overlay").append(e),i(e)(a)}a.hsl_path=hsl_path,a.Core=t,t.classicSidebar=!1,a.$on("scope_loaded",function(e,r){if("Map"==r){var o=n.map,l=new ol.format.WMTSCapabilities;o.getControls().forEach(function(e){e instanceof ol.control.Attribution&&e.setCollapsible(!1)});var s="http:";window.location.protocol&&(s=window.location.protocol),[{capUrl:s+"//geoportal.cuzk.cz/WMTS_ZM/WMTService.aspx?service=WMTS&request=GetCapabilities",layer:"zm",matrixSet:"wgs84:pseudomercator:epsg:3857",title:"Base (ČUZK)"},{capUrl:s+"//geoportal.cuzk.cz/WMTS_ORTOFOTO/WMTService.aspx?service=WMTS&request=GetCapabilities",layer:"orto",matrixSet:"wgs84:pseudomercator:epsg:3857",title:"Satellite (ČUZK)"}].forEach(function(e){$.ajax({url:e.capUrl}).done(function(a){try{for(var t=l.read(a),i=ol.source.WMTS.optionsFromCapabilities(t,{layer:e.layer,matrixSet:e.matrixSet,projection:"EPSG:3857"}),r=0;r<i.urls.length;r++)i.crossOrigin="anonymous",i.attributions="Podkladová data © ČÚZK";var o=n.findLayerByTitle(e.title),s=new ol.source.WMTS(i);o.setSource(s)}catch(e){console&&console.log("Some invalid capabilities received",a,e)}})});var c=o.getTarget(),d="string"==typeof c?$("#"+c):$(c);o.on("pointermove",function(e){var a=!1;o.forEachLayerAtPixel(e.pixel,function(e,t){a=!0},void 0,function(e){return e instanceof ol.layer.Image}),a?d.css("cursor","pointer"):d.css("cursor","")})}if("Sidebar"==r){var u=angular.element('<div id="test3" hs.pilsentraffic.directive ng-controller="hs.pilsentraffic.controller" ng-if="Core.exists(\'hs.pilsentraffic.controller\')" ng-show="Core.panelVisible(\'pilsentraffic\', this)"></div>');angular.element("#panelplace").append(u),i(u)(a);var p=angular.element("<div hs.pilsentraffic.toolbar_button_directive></div>");angular.element(".sidebar-list").append(p),i(p)(e.targetScope),t.setMainPanel("pilsentraffic")}}),a.$on("layermanager.updated",function(e,a){if(1==a.get("base")&&"Grayscale (OSM)"==a.get("title")){if(-1!==navigator.appVersion.indexOf("MSIE 10")||-1!==navigator.appVersion.indexOf("MSIE 9"))return void r(u,200);a.on("postcompose",function(e){for(var a=e.context,t=a.canvas,i=a.getImageData(0,0,t.width,t.height),n=i.data,r=0,o=n.length;r<o;r+=4)n[r]=n[r+1]=n[r+2]=(3*n[r]+4*n[r+1]+n[r+2])/8;a.putImageData(i,0,0)})}}),angular.element(document).ready(function(){p()}),a.showDeveloperInfo=function(){function e(){function e(e){s.day.set("month",e.date.data.date_obj.getMonth()),s.day.set("date",e.date.data.date_obj.getDate()),s.day.set("year",e.date.data.date_obj.getFullYear()),c.$broadcast("date_changed"),$("#advanced-info-dialog").modal("hide")}angular.forEach(a.timeline._timenav.timeaxis.minor_ticks,function(a){$(a.tick).click(function(){e(a)}),(a.date.data.date_obj>new Date("2018-11-30")||a.date.data.date_obj<new Date("2017-04-01"))&&$(a.tick).hide()}),angular.forEach(a.timeline._timenav.timeaxis.major_ticks,function(t){$.isNumeric($("span",$(t.tick)).html())&&$("span",$(t.tick)).html(a.timeline._timenav.options.language.date.month_abbr[0]+"<br/>"+$(t.tick).html()),$(t.tick).click(function(){e(t)}),(t.date.data.date_obj>new Date("2018-11-30")||t.date.data.date_obj<new Date("2017-04-01"))&&$(t.tick).hide()}),$(".tl-timeaxis-tick-hidden").removeClass("tl-timeaxis-tick-hidden")}$("#hs-dialog-area #advanced-info-dialog").remove();var t=angular.element("<div hs.advanced_infopanel_directive></div>");$("#hs-dialog-area").append(t),i(t)(a),r(function(){a.timeline.setData(m),a.timeline.goTo(1),$(".tl-slide-content").width(870),$(".tl-menubar-button").click(function(){r(function(){e()},500)}),e()},200)};var m={title:{text:{headline:"Časová osa dopravních staveb v Plzni",text:""}},events:[]};a.min_date=e("2017-05-01"),a.max_date=e("2018-11-30"),o({method:"GET",url:l.proxify("http://gis.lesprojekt.cz/get_roadworks.json"),cache:!1}).then(function(t){t.data.forEach(function(t){var i=t.dates[0].split("."),n=t.dates[1].split(".");e(n[2]+"-"+n[1]+"-"+n[0]).isSameOrAfter(a.max_date)&&(a.max_date=e(n[2]+"-"+n[1]+"-"+n[0])),m.events.push({start_date:{year:i[2],month:i[1],day:i[0]},end_date:{year:n[2],month:n[1],day:n[0]},text:{headline:t.name,text:t.description}})})}),a.options={debug:!1,timenav_position:"top",timenav_height_percentage:70,timenav_mobile_height_percentage:80,language:"cz",dragging:!0,start_at_slide:1,data:m},a.$on("layermanager.layer_time_changed",function(e,a,t){angular.forEach(n.map.getLayers(),function(e){e.getSource().updateParams&&e.getSource().updateParams({TIME:t})})}),t.panelEnabled("compositions",!1),t.panelEnabled("status_creator",!1),t.panelEnabled("permalink",!1),t.panelEnabled("layermanager",!1),a.$on("infopanel.updated",function(e){})}]),a});