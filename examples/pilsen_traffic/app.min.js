"use strict";define(["ol","moment","sidebar","layermanager","query","search","permalink","measure","bootstrap","api","drag","compositions","pilsentraffic","calendar","ngtimeline"],function(ol,e){var t=angular.module("hs",["hs.layermanager","hs.query","hs.permalink","hs.api","hs.sidebar","hs.drag","hs.compositions","hs.pilsentraffic","hs.calendar","ngTimeline"]);return t.directive("hs",["hs.map.service","Core",function(e,t){return{templateUrl:hsl_path+"hslayers.html",link:function(e,a){t.fullScreenMap(a)}}}]),t.directive("hs.advancedInfopanelDirective",["$compile",function(e){return{templateUrl:"./partials/advanced_info.html?bust="+gitsha,link:function(t,a,i){var n=.85*$(window).height();$("#advanced-info-dialog .modal-body").css("overflow-y","auto"),$("#advanced-info-dialog .modal-body").css("max-height",n),$("timeline").attr("height",n),$("#advanced-info-dialog").modal("show"),a.find(".modal-body").append('<timeline control="timeline" height="'+(n-50)+'" options="options"></timeline>'),e(a.contents())(t)}}}]),t.directive("hs.topmenu",function(){return{templateUrl:"./partials/top-menu.html?bust="+gitsha}}),t.directive("hs.basemapmenu",["hs.layermanager.service",function(e){return{templateUrl:"./partials/basemap-menu.html?bust="+gitsha,link:function(t,a,i){t.data=e.data,t.changeBaseLayerVisibility=function(t,a){var i=$("#content-wrapper");"Satellite (ČUZK)"==a.title?i.addClass("air"):i.removeClass("air"),e.changeBaseLayerVisibility(t,a)}}}}]),t.directive("hs.trafficmenu",function(){return{restrict:"A",controller:["$scope",function(e){function t(e){}e.trafficLayerChanged=function(e,a){"INPUT"==a.target.tagName&&t(e)},e.items=[{label:"Události"},{label:"Uzavírky"},{label:"Stupně provozu"}],e.items.forEach(function(e){angular.isUndefined(e.check)&&(e.check=!1)}),e.setAll=function(a){e.items.forEach(function(e){e.check=a,t(e)})},e.isAll=function(t){for(var a=0;a<e.items.length;a++)if(e.items[a].check!=t)return!1;return!0}}],templateUrl:"./partials/traffic-menu.html?bust="+gitsha}}),t.value("config",{default_layers:[new ol.layer.Tile({source:new ol.source.OSM,title:"Grayscale (OSM)",base:!0,visible:!0}),new ol.layer.Tile({source:new ol.source.OSM,title:"Standard (OSM)",base:!0,visible:!1}),new ol.layer.Tile({source:new ol.source.OSM,title:"Base (ČUZK)",base:!0,visible:!1}),new ol.layer.Tile({source:new ol.source.OSM,title:"Satellite (ČUZK)",base:!0,visible:!1}),new ol.layer.Image({title:"Intenzita dopravy v Plzni - květen 2017",source:new ol.source.ImageWMS({url:"https://intenzitadopravy.plzen.eu/wms-t",params:{LAYERS:"may",INFO_FORMAT:"text/html",FORMAT:"image/png",TIME:"2017-05-01T00:00:00.000Z"},crossOrigin:"anonymous"}),dimensions:{time:{name:"time",units:"ISO8601",unitSymbol:null,default:"2017-05-01T00:00:00",nearestValue:!1,values:"2017-01-01T00:00:00/2099-12-31T00:00:00/PT1H"}},visible:!0,popupClass:"popup-headline",queryFilter:function(e,t,a){var i=!1;return e.forEachLayerAtPixel(a,function(e,a){t==e&&(i=!0)},void 0,function(e){return e instanceof ol.layer.Image}),i},featureInfoLang:{en:"http://gis.lesprojekt.cz/wms/transport/plzen_traffic_volumes"}})],default_view:new ol.View({center:[1488449.247038074,6404351.20261046],zoom:13,units:"m"}),showQueryPoint:!1}),t.controller("mapReset",["$scope","hs.map.service",function(e,t){e.resetView=function(){t.resetView()}}]),t.controller("Main",["$scope","Core","$compile","hs.map.service","$timeout","$http","hs.utils.service","hs.pilsentraffic.service","$rootScope",function(t,a,i,n,r,o,l,s,c){function d(){var e=angular.element("<div hs.topmenu></div>");angular.element(".gui-overlay").append(e),i(e)(t)}t.hsl_path=hsl_path,t.Core=a,a.classicSidebar=!1,t.$on("scope_loaded",function(e,r){if("Map"==r){var o=n.map,l=new ol.format.WMTSCapabilities;o.getControls().forEach(function(e){e instanceof ol.control.Attribution&&e.setCollapsible(!1)});var s="http:";window.location.protocol&&(s=window.location.protocol),[{capUrl:s+"//geoportal.cuzk.cz/WMTS_ZM/WMTService.aspx?service=WMTS&request=GetCapabilities",layer:"zm",matrixSet:"wgs84:pseudomercator:epsg:3857",title:"Base (ČUZK)"},{capUrl:s+"//geoportal.cuzk.cz/WMTS_ORTOFOTO/WMTService.aspx?service=WMTS&request=GetCapabilities",layer:"orto",matrixSet:"wgs84:pseudomercator:epsg:3857",title:"Satellite (ČUZK)"}].forEach(function(e){$.ajax({url:e.capUrl}).done(function(t){try{for(var a=l.read(t),i=ol.source.WMTS.optionsFromCapabilities(a,{layer:e.layer,matrixSet:e.matrixSet,projection:"EPSG:3857"}),r=0;r<i.urls.length;r++)i.crossOrigin="anonymous",i.attributions="Podkladová data © ČÚZK";var o=n.findLayerByTitle(e.title),s=new ol.source.WMTS(i);o.setSource(s)}catch(e){console&&console.log("Some invalid capabilities received",t,e)}})});var c=o.getTarget(),d="string"==typeof c?$("#"+c):$(c);o.on("pointermove",function(e){var t=!1;o.forEachLayerAtPixel(e.pixel,function(e,a){t=!0},void 0,function(e){return e instanceof ol.layer.Image}),t?d.css("cursor","pointer"):d.css("cursor","")})}if("Sidebar"==r){var u=angular.element('<div id="test3" hs.pilsentraffic.directive ng-controller="hs.pilsentraffic.controller" ng-if="Core.exists(\'hs.pilsentraffic.controller\')" ng-show="Core.panelVisible(\'pilsentraffic\', this)"></div>');angular.element("#panelplace").append(u),i(u)(t);var m=angular.element("<div hs.pilsentraffic.toolbar_button_directive></div>");angular.element(".sidebar-list").append(m),i(m)(e.targetScope),a.setMainPanel("pilsentraffic")}}),t.$on("layermanager.updated",function(e,t){1==t.get("base")&&"Grayscale (OSM)"==t.get("title")&&t.on("postcompose",function(e){for(var t=e.context,a=t.canvas,i=t.getImageData(0,0,a.width,a.height),n=i.data,r=0,o=n.length;r<o;r+=4)n[r]=n[r+1]=n[r+2]=(3*n[r]+4*n[r+1]+n[r+2])/8;t.putImageData(i,0,0)})}),angular.element(document).ready(function(){d()}),t.showDeveloperInfo=function(){function e(){function e(e){s.day.set("month",e.date.data.date_obj.getMonth()),s.day.set("date",e.date.data.date_obj.getDate()),s.day.set("year",e.date.data.date_obj.getFullYear()),c.$broadcast("date_changed"),$("#advanced-info-dialog").modal("hide")}angular.forEach(t.timeline._timenav.timeaxis.minor_ticks,function(t){$(t.tick).click(function(){e(t)}),(t.date.data.date_obj>new Date("2018-11-30")||t.date.data.date_obj<new Date("2017-04-01"))&&$(t.tick).hide()}),angular.forEach(t.timeline._timenav.timeaxis.major_ticks,function(a){$.isNumeric($("span",$(a.tick)).html())&&$("span",$(a.tick)).html(t.timeline._timenav.options.language.date.month_abbr[0]+"<br/>"+$(a.tick).html()),$(a.tick).click(function(){e(a)}),(a.date.data.date_obj>new Date("2018-11-30")||a.date.data.date_obj<new Date("2017-04-01"))&&$(a.tick).hide()}),$(".tl-timeaxis-tick-hidden").removeClass("tl-timeaxis-tick-hidden")}$("#hs-dialog-area #advanced-info-dialog").remove();var a=angular.element("<div hs.advanced_infopanel_directive></div>");$("#hs-dialog-area").append(a),i(a)(t),r(function(){t.timeline.setData(u),t.timeline.goTo(1),$(".tl-slide-content").width(870),$(".tl-menubar-button").click(function(){r(function(){e()},500)}),e()},200)};var u={title:{text:{headline:"Časová osa dopravních staveb v Plzni",text:""}},events:[]};t.min_date=e("2017-05-01"),t.max_date=e("2018-11-30"),o({method:"GET",url:l.proxify("http://otn-caramba.rhcloud.com/get_roadworks/"),cache:!1}).then(function(a){a.data.forEach(function(a){var i=a.dates[0].split("."),n=a.dates[1].split(".");e(n[2]+"-"+n[1]+"-"+n[0]).isSameOrAfter(t.max_date)&&(t.max_date=e(n[2]+"-"+n[1]+"-"+n[0])),u.events.push({start_date:{year:i[2],month:i[1],day:i[0]},end_date:{year:n[2],month:n[1],day:n[0]},text:{headline:a.name,text:a.description}})})}),t.options={debug:!1,timenav_position:"top",timenav_height_percentage:70,timenav_mobile_height_percentage:80,language:"cz",dragging:!0,start_at_slide:1,data:u},t.$on("layermanager.layer_time_changed",function(e,t,a){angular.forEach(n.map.getLayers(),function(e){e.getSource().updateParams&&e.getSource().updateParams({TIME:a})})}),a.panelEnabled("compositions",!1),a.panelEnabled("status_creator",!1),a.panelEnabled("permalink",!1),a.panelEnabled("layermanager",!1),t.$on("infopanel.updated",function(e){})}]),t});