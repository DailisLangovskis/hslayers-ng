define(["angular","ol","moment","map","core","styles","angularjs-socialshare","permalink","lazyimage"],function(angular,ol,e){var t="Intenzita dopravy v Plzni - květen 2017";angular.module("hs.pilsentraffic",["hs.core","hs.map","hs.styles","720kb.socialshare","hs.permalink","afkl.lazyImage"]).directive("hs.pilsentraffic.directive",function(){return{templateUrl:"./partials/directive.html?bust="+gitsha}}).directive("hs.pilsentraffic.toolbarButtonDirective",function(){return{templateUrl:"./partials/toolbar_button_directive.html?bust="+gitsha}}).directive("hs.pilsentraffic.roadworkInfoDirective",function(){return{templateUrl:"./partials/roadwork_info.html?bust="+gitsha,link:function(e,t,a){$("#roadwork-info-dialog").modal("show")}}}).directive("hs.pilsentraffic.legend",["hs.pilsentraffic.service","gettext",function(e,t){return{templateUrl:"./partials/legend.html?bust="+gitsha,link:function(a,n,r){a.data=e.data,a.toggleLegend=function(e){a.data.legendVisible=e,e&&(a.data.helpVisible=!1)},a.legendContent=[t("1 - fluent traffic, individual vehicles passing"),t("2 - fluent traffic, small groups of vehicles passing"),t("3 - continuous traffic, the circulation speed lower than the allowed maximum"),t("4 - traffic jams emerging, circulation speed significantly decreased"),t("5 - traffic jam, the vehicles do not move at all or only slowly"),t("amount of vehicles on the road segment per hour"),t("road closed"),t("partial road closure")]}}}]).directive("hs.pilsentraffic.helppanel",function(){return{templateUrl:"./partials/help-panel.html?bust="+gitsha,link:function(e,t,a){e.page="about",e.hideHelpPanel=function(){t.children().first().addClass("panel-help-hidden")},e.showHelpPanel=function(a){angular.isDefined(a)&&(e.page=a),t.children().first().removeClass("panel-help-hidden")},e.setPage=function(t){e.page=t},e.hideHelpPanel()}}}).service("hs.pilsentraffic.service",["Core","hs.utils.service","$http",function(t,a,n){var r={};return r.data={},r.data.legendVisible=!1,r.data.helpVisible=!1,r.roadworksData=[],r.getRoadworksData=function(){n({method:"GET",url:a.proxify("http://otn-caramba.rhcloud.com/get_roadworks/"),cache:!1}).then(function(e){e.data.forEach(function(e){var t=e.dates[0].split("."),a=e.dates[1].split(".");r.roadworksData.push({startDate:new Date(t[2],t[1]-1,t[0]),endDate:new Date(a[2],a[1]-1,a[0]),headline:e.name,description:e.description,location:e.location,detour:e.detour,coordinate:e.geom.coordinates,id:e.id})})})},r.getDayData=function(e){if(r.roadworksData.length<1)return!1;var t=[];return r.roadworksData.forEach(function(a){e>=a.startDate&&e<=a.endDate&&t.push(a)}),t},r.day=e(),r.getRoadworksData(),r}]).controller("hs.pilsentraffic.controller",["$scope","hs.map.service","$http","Core","config","hs.pilsentraffic.service","hs.styles.service","$timeout","$rootScope","hs.layermanager.WMSTservice","hs.layermanager.service","Socialshare","hs.permalink.service_url","$compile",function(a,n,r,i,o,l,s,c,u,d,f,h,g,p){function m(){a.current_date.setYear(l.day.year()),a.current_date.setMonth(l.day.month()),a.current_date.setDate(l.day.date()),a.current_date.getMonth()!=l.day.month()&&a.current_date.setMonth(l.day.month()),console&&console.log(l.day,l.current_date),a.current_date.setHours(a.current_hour),k(),a.$broadcast("day.changed",l.day),a.updateWorklist()}function v(t){var n=e(l.day);n.date(n.date()+t),a.$broadcast("day.changed",n)}function y(){l.day.year(a.current_date.getFullYear()),l.day.month(a.current_date.getMonth()),l.day.date(a.current_date.getDate())}function _(){C=f.getLayerByTitle(t),a.current_date=new Date(C.min_time),a.current_hour=8;var e=(new Date).getHours();a.setCurrentTime(e)}function w(){var e={};e.year=a.current_date.getFullYear(),e.month=a.current_date.getMonth(),e.date=a.current_date.getDate(),e.hour=a.current_hour,g.updateCustomParams(e)}function k(){C.date_increment=a.current_date.getTime()-6e4*a.current_date.getTimezoneOffset(),d.setLayerTime(C,-2),w()}function D(){a.current_date.setHours(parseInt(a.current_hour)+1),C.date_increment=a.current_date.getTime()-6e4*a.current_date.getTimezoneOffset(),d.setLayerTime(C,-2)}function b(){function e(){clearInterval(t),a.setCurrentTime(parseInt(a.current_hour)+1),setTimeout(function(){b()},2500)}if(a.current_hour>=23&&(a.animating=!1,a.$$phase||a.$digest()),a.animating){D();var t=null;t=setInterval(function(){0==a.layers_loading&&e()},100)}}function P(){return"Předpokládaná dopravní situace v Plzni dne "+T(l.day.date())+"."+T(l.day.month()+1)+"."+l.day.year()+" v "+T(a.current_hour)+":00."}function T(e){return("0"+e).slice(-2)}function S(e){return P()+"%0D%0A"+encodeURIComponent(e)}function x(e){angular.isUndefined(z)&&L(),z.show(ol.proj.transform(e.coordinate,"EPSG:4326","EPSG:3857"),$("#roadwork-info-offline").html()),u.$broadcast("popupOpened","inside")}function L(){z=new ol.Overlay.Popup,n.map.addOverlay(z),z.getElement().className+=" popup-headline"}function H(){var e=angular.element("<div hs.pilsentraffic.legend></div>");$("#hs-dialog-area").append(e),p(e)(a)}function U(){var e=angular.element("<div hs.pilsentraffic.helppanel></div>");$(".gui-overlay").append(e),p(e)(a)}a.units=[];n.map,o.default_layers[4];var C=null;a.animating=!1,a.current_date=new Date,a.service=l,a.roadworklist=[],a.roadwork,u.$on("date_changed",function(){m()}),a.rangeContains=function(e){return e.isSameOrAfter(a.$parent.min_date)&&e.isSameOrBefore(a.$parent.max_date)};var R=!1;a.$watch(function(){return l.day},m),a.setCurrentTime=function(e){a.current_hour=e,a.current_date.setHours(a.current_hour),k()},a.nextDay=function(){v(1)},a.previousDay=function(){v(-1)},a.nextHour=function(){a.current_date.setHours(a.current_date.getHours()+1),a.current_hour=a.current_date.getHours(),k(),y(),v(0)},a.previousHour=function(){a.current_date.setHours(a.current_date.getHours()-1),a.current_hour=a.current_date.getHours(),k(),y(),v(0)},angular.isUndefined(f.getLayerByTitle(t))?u.$on("layermanager.updated",function(e,a){null==C&&a.get("title")==t&&_()}):_(),a.toggleAnimation=function(){a.current_hour>=23||(a.animating=!a.animating,b())},a.updateWorklist=function(){var e=l.getDayData(a.current_date);e?(a.roadworklist=e,a.$$phase||a.$digest()):c(function(){a.updateWorklist()},500)},a.showRoadworkInfo=function(e){a.roadwork=e,setTimeout(function(){x(e)},100)},a.updateWorklist(),a.permalink_visible=!1,u.$on("layermanager.layer_loading",function(e,n){n.get("title")==t&&(a.layers_loading=n.getSource().loadCounter)}),u.$on("layermanager.layer_loaded",function(e,n){n.get("title")==t&&(a.layers_loading=n.getSource().loadCounter)}),a.printPdf=function(){var e=new jsPDF({orientation:"landscape"}),t="";n.map.once("postcompose",function(e){var a=e.context.canvas,n=document.createElement("canvas"),r=700,i=500,o=n.getContext("2d"),l=(window.devicePixelRatio||1)/(o.webkitBackingStorePixelRatio||o.mozBackingStorePixelRatio||o.msBackingStorePixelRatio||o.oBackingStorePixelRatio||o.backingStorePixelRatio||1);n.style.width=r*l+"px",n.style.height=i*l+"px",n.width=r*l,n.height=i*l,o.scale(1/l,1/l),o.imageSmoothingEnabled=!1,r*=l,i*=l,o.fillStyle="#ffffff",o.fillRect(0,0,r,i),o.drawImage(a,a.width/2-r/2,a.height/2-i/2,r,i,40,0,r,i),t=n.toDataURL("image/png",1)},a),n.map.renderSync();var r=document.createElement("canvas");r.style.width="1000px",r.style.height="1000px",r.width=1e3,r.height=1e3;var i=r.getContext("2d");i.fillStyle="black",i.font="22pt Verdana",i.fillText(P(),40,30);var o=r.toDataURL("image/png",1);e.addImage(o,"PNG",0,20);var l=25;i.clearRect(0,0,1e3,1e3),i.fillStyle="black",i.font="14pt Verdana",i.fillText("Probíhající dopravní stavby:",735,l),l+=40,i.font="12pt Verdana",angular.forEach(a.roadworklist,function(e){i.fillText(e.headline,735,l),l+=37}),o=r.toDataURL("image/png",1),e.addImage(o,"PNG",0,40),e.addImage(t,"png",0,40),e.save("a4.pdf")},a.shareSocial=function(e){var t=g.getPermalinkUrl();r.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:t}).success(function(t,n,r,i){a.share_url=t.id,h.share({provider:e,attrs:{socialshareText:"Mapa intenzity dopravy v Plzni",socialshareSubject:"Mapa intenzity dopravy v Plzni",socialshareBody:S(a.share_url),socialshareUrl:a.share_url,socialsharePopupHeight:600,socialsharePopupWidth:500}})}).error(function(e,t,a,n){console&&console.log("Error creating short Url")})},a.showPermalink=function(){var e=g.getPermalinkUrl();r.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:e}).success(function(e,t,n,r){a.share_url=e.id,a.permalink_visible=!a.permalink_visible,setTimeout(function(){$("#hs-permalink").focus(function(){$(this).select()}),$("#hs-permalink").focus()},400)})},g.getParamValue("year")&&function(){R=!0,setTimeout(function(){R=!1},2e3);e(l.day);l.day.year(g.getParamValue("year")),l.day.month(g.getParamValue("month")),l.day.date(g.getParamValue("date")),m(),a.setCurrentTime(g.getParamValue("hour"));var t=g.getParamValue("visible_layers");t?(t=t.split(";")).forEach(function(e){"Satellite (ČUZK)"==e&&$("#content-wrapper").addClass("air")}):console&&console.log("Strange!. visible_layers was not available!")}(),function(){var e=angular.element("<div hs.pilsentraffic.roadwork-info-directive></div>");$("#hs-dialog-area").append(e),p(e)(a)}();var z;a.$on("popupOpened",function(e,t){angular.isDefined(t)&&"inside"!=t&&angular.isDefined(z)&&z.hide()}),c(function(){H(),U()},500),a.currentLanguage="cs",pilsenSite&&(a.hideLanguage=!0),a.setLanguage=function(e,t){$("#language-title").html(e),i.setLanguage(t);var n={cs:"cz",en:"en"};a.$parent.options.language=n[t],a.currentLanguage=t,a.$broadcast("language.changed",t)},a.setLanguage("Čeština",a.currentLanguage),a.$emit("scope_loaded","PilsenTraffic")}])});