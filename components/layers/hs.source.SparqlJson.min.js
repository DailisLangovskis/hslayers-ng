define(["ol"],function(ol){function e(e,o,t){var i,a,n,r=o/(1.00000001*e),s=~~(4*r),l=4*r-s,g=1-l;switch(s%4){case 2:i=l,a=1,n=0;break;case 0:i=0,a=l,n=1;break;case 3:i=1,a=g,n=0;break;case 1:i=0,a=1,n=g}return"rgba("+~~(235*i)+","+~~(235*a)+","+~~(235*n)+", "+t+")"}function o(e,o,t,i,a){e[o.category_field]&&(void 0===i[e[o.category_field]]&&(i[e[o.category_field]]={id:a,name:e[o.category_field]},a++),t.category_id=i[e[o.category_field]].id)}function t(t,i,a,n,r,s){var l=[],g=0,d=new ol.format.WKT;for(var u in t){if(g++,t[u]["http://www.w3.org/2003/01/geo/wgs84_pos#lat"]&&t[u]["http://www.w3.org/2003/01/geo/wgs84_pos#long"]&&""!=t[u]["http://www.w3.org/2003/01/geo/wgs84_pos#lat"]&&""!=t[u]["http://www.w3.org/2003/01/geo/wgs84_pos#long"]){var c=parseFloat(t[u]["http://www.w3.org/2003/01/geo/wgs84_pos#long"]),p=parseFloat(t[u]["http://www.w3.org/2003/01/geo/wgs84_pos#lat"]);if(!isNaN(c)&&!isNaN(p)){if(void 0!==n[v=ol.proj.transform([c,p],"EPSG:4326","EPSG:3857")])continue;t[u].geometry=new ol.geom.Point(v);f=new ol.Feature(t[u]);o(t[u],a,f,r,s),n[v]=!0,l.push(f)}}if(t[u]["http://www.opengis.net/ont/geosparql#asWKT"]){var h=d.readFeature(t[u]["http://www.opengis.net/ont/geosparql#asWKT"].toUpperCase());t[u].geometry=h.getGeometry(),t[u].geometry.transform("EPSG:4326",a.projection),delete t[u]["http://www.opengis.net/ont/geosparql#asWKT"];var v=t[u].geometry.getCoordinates();if(void 0!==n[v])continue;var f=new ol.Feature(t[u]);o(t[u],a,f,r,s),n[v]=!0,l.push(f)}}for(var w in r)r[w].color=e(s,r[w].id,.7);i.legend_categories=r;for(g=0;g<l.length;g++)l[g].category_id&&(l[g].color=e(s,l[g].category_id,.7));return l}function i(e,o){if(void 0!==e.extend_with_attribs)for(var t in e.extend_with_attribs)for(var i in o)void 0===o[i][e.extend_with_attribs[t]]&&(o[i][e.extend_with_attribs[t]]="")}return function(e){var o={},a={},n=new ol.source.Vector({format:new ol.format.GeoJSON,loader:function(r,s,l){if(this.set("loaded",!1),void 0!==this.options.clear_on_move&&this.options.clear_on_move&&this.clear(),void 0===e.hsproxy&&(e.hsproxy=!1),void 0===e.geom_attribute&&(e.geom_attribute="bif:st_point(xsd:decimal(?lon), xsd:decimal(?lat))"),""!=this.options.url){var g=this.options.url,d=[r[0],r[1]],u=[r[2],r[3]];d=ol.proj.transform(d,"EPSG:3857","EPSG:4326"),u=ol.proj.transform(u,"EPSG:3857","EPSG:4326");var c='FILTER(bif:st_intersects(bif:st_geomfromtext("BOX('+(r=[d[0],d[1],u[0],u[1]])[0]+" "+r[1]+", "+r[2]+" "+r[3]+')"), '+e.geom_attribute+")).";g=g.replace("<extent>",c),e.hsproxy&&(g="/cgi-bin/hsproxy.cgi?toEncoding=utf-8&url="+encodeURIComponent(g)),console&&void 0!==n.get("geoname")&&console.log("Get ",n.get("geoname")),console&&console.log(c),this.loadCounter+=1,this.loadTotal+=1,$.ajax({url:g,context:this}).done(function(r){if(console&&console.log("Finish ",this.get("geoname"),r.results.bindings.length),n.loadCounter-=1,this.options.updates_url){var s=this.options.updates_url;s=s.replace("<extent>",c),n.loadCounter+=1,n.loadTotal+=1,$.ajax({url:s,context:this}).done(function(s){console&&void 0!==this.get("geoname")&&console.log("Finish updates ",this.get("geoname"),r.results.bindings.length,s.results.bindings.length);for(var l={},g=0;g<r.results.bindings.length;g++)void 0===l[(d=r.results.bindings[g]).o.value]&&(l[d.o.value]={poi_id:d.o.value}),l[d.o.value][d.p.value]=d.s.value;for(g=0;g<s.results.bindings.length;g++){var d=s.results.bindings[g],u=d.attr.value;if(void 0!==l[d.o.value][u]&&"http://xmlns.com/foaf/0.1/depiction"==u)for(var c=1;c<20;c++)if(void 0===l[d.o.value][u+c]){u+=c;break}l[d.o.value][u]=d.value.value}if(void 0!==e.category)for(var g in l)l[g]["http://www.sdi4apps.eu/poi/#mainCategory"]=e.category;i(e,l),console&&console.log("Add features",l),this.addFeatures(t(l,this,e,a,o,0)),n.loadCounter-=1,this.set("last_feature_count",Object.keys(l).length),0==n.loadCounter&&(this.set("loaded",!0),this.dispatchEvent("imageloadend"))})}else{for(var l={},g=0;g<r.results.bindings.length;g++){var d=r.results.bindings[g];void 0===l[d.o.value]&&(l[d.o.value]={poi_id:d.o.value}),l[d.o.value][d.p.value]=d.s.value}if(void 0!==e.category)for(var g in l)l[g]["http://www.sdi4apps.eu/poi/#mainCategory"]=e.category;i(e,l),this.addFeatures(t(l,this,e,a,o,0)),this.styleAble=!0,this.hasPoint=!0,n.loadCounter-=1,this.set("last_feature_count",Object.keys(l).length),0==n.loadCounter&&(this.set("loaded",!0),this.dispatchEvent("imageloadend"))}})}},strategy:function(e,o){var t=[e[0],e[1],e[2],e[3]];return e[2]-e[0]>65735&&(t[0]=(e[2]+e[0])/2-32867.5,t[2]=(e[2]+e[0])/2+32867.5,t[1]=(e[3]+e[1])/2-17500,t[3]=(e[3]+e[1])/2+17500),[t]},projection:e.projection});return n.loadCounter=0,n.loadTotal=0,n.options=e,n.legend_categories=o,n}});