define(["angular","ol","app","map"],function(angular,ol,e,t){angular.module("hs.panoramio",["hs","hs.map"]).directive("hs.panoramio.directive",["hs.panoramio.service",function(e){return{link:function(t,a,o){if(o.value)if("photo_file_url"==o.attribute){a.html(angular.element("<img>").attr({src:o.value}));var r=angular.element("<button>").attr({class:"btn btn-default"}).css("float","right"),i=function(){e.source.forEachFeature(function(t){t.get("photo_file_url")==o.value&&(e.saved_items[o.value]={},t.getKeys().forEach(function(a){if("gid"!=a)if("geometry"!=a)e.saved_items[o.value][a]=t.get(a);else{var r=new ol.format.WKT;e.saved_items[o.value][a]=r.writeFeature(t)}}),t.set("popularity",1e5),localStorage.setItem("saved_panoramio_features",JSON.stringify(e.saved_items)),e.loadIntoLocalStorage(o.value),r.html("Remove").off("click").on("click",n))})},n=function(){e.source.forEachFeature(function(t){t.get("photo_file_url")==o.value&&(delete e.saved_items[o.value],localStorage.setItem("saved_panoramio_features",JSON.stringify(e.saved_items)),localStorage.removeItem("saved_panoramio_image_"+o.value),r.html("Save").off("click").on("click",i))})};void 0===e.saved_items[o.value]?r.html("Save").click(i):r.html("Remove").click(n),a.append(r)}else if(0==o.value.indexOf("http")){var l=angular.element("<a>").attr({target:"_blank",href:o.value}).html(o.value);a.html(l)}else a.html(o.value.toString());else"photo_file_url"!=o.attribute&&a.html(o.attribute)}}}]).service("hs.panoramio.service",["hs.map.service","config","$rootScope",function(e,a,o){var r=new ol.source.Vector,i=new ol.source.Cluster({distance:90,source:r}),n=null,l=this,s=new ol.format.WKT;this.getSavedItems=function(){var e=localStorage.getItem("saved_panoramio_features");return null==e?{}:JSON.parse(e)};var u=function(e,t){try{var a=s.readFeature(e.geometry);return angular.forEach(e,function(e,t){"geometry"!=t&&a.set(t,e)}),a.set("popularity",1e5),a.setStyle([new ol.style.Style({image:new ol.style.Icon({src:localStorage.getItem("saved_panoramio_image_"+e.photo_file_url)})})]),a}catch(e){return null}};this.featuresReceived=function(e){for(var a=[],o=0;o<e.photos.length;o++){var i=e.photos[o],n={geometry:new ol.geom.Point(ol.proj.transform([i.longitude,i.latitude],"EPSG:4326",t.getView().getProjection())),photo_file_url:i.photo_file_url,Title:i.photo_title,Uploaded:i.upload_date,Link:i.photo_url,"Lon, Lat":i.longitude.toFixed(4)+" "+i.latitude.toFixed(4),Author:i.owner_name,Owner:i.owner_url,popularity:o,hstemplate:"hs.panoramio.directive"},s=new ol.Feature(n);s.setStyle([new ol.style.Style({image:new ol.style.Icon({src:s.get("photo_file_url"),crossOrigin:"anonymous"})})]),a.push(s)}angular.forEach(l.saved_items,function(e,t){var o=u(e);o&&a.push(o)}),r.clear(),r.addFeatures(a)},this.update=function(){var t=e.map;if(void 0!==t.getSize()){var a=ol.proj.transformExtent(t.getView().calculateExtent(t.getSize()),t.getView().getProjection(),"EPSG:4326"),o=Math.floor($(t.getViewport()).width()*$(t.getViewport()).height()/22280*1.2),r="";r="undefined"==typeof use_proxy||!0===use_proxy?"/cgi-bin/hsproxy.cgi?toEncoding=utf-8&url="+window.escape("http://www.panoramio.com/map/get_panoramas.php?order=popularity&set=full&from=0&to="+o+"&minx="+a[0]+"&miny="+a[1]+"&maxx="+a[2]+"&maxy="+a[3]+"&size=thumbnail"):"http://www.panoramio.com/map/get_panoramas.php?order=popularity&set=full&from=0&to="+o+"&minx="+a[0]+"&miny="+a[1]+"&maxx="+a[2]+"&maxy="+a[3]+"&size=thumbnail",$.ajax({url:r,cache:!1,success:l.featuresReceived})}},this.loadIntoLocalStorage=function(e){var t,a=new XMLHttpRequest,o=new FileReader;a.open("GET",e,!0),a.responseType="arraybuffer",a.addEventListener("load",function(){200===a.status&&(t=new Blob([a.response],{type:"image/png"}),o.onload=function(t){var a=t.target.result;try{localStorage.setItem("saved_panoramio_image_"+e,a)}catch(e){console.log("Storage failed: "+e)}},o.readAsDataURL(t))},!1),a.send()},this.init=function(){l.saved_items=l.getSavedItems(),l.lyr=n=new ol.layer.Vector({title:"Panoramio pictures",show_in_manager:!0,source:i,visible:!1,style:function(e,t){var a=null;e.get("features").length>1&&(a=new ol.style.Text({text:e.get("features").length.toString(),fill:new ol.style.Fill({color:"#fff"}),stroke:new ol.style.Stroke({color:"#000"})}));for(var o=0,r=0,i=0;i<e.get("features").length;i++){var n=e.get("features")[i].get("popularity");n>o&&(o=n,r=i)}var l=[new ol.style.Style({image:e.get("features")[r].getStyle()[0].getImage(),text:a})];return 1e5==o&&l.push(new ol.style.Style({image:new ol.style.RegularShape({fill:new ol.style.Fill({color:[242,242,0,.7]}),stroke:new ol.style.Stroke({color:[119,119,0,.9]}),radius1:17,radius2:7,points:5})})),l}}),angular.isUndefined(a.default_layers)&&(a.default_layers=[]),a.default_layers.push(n);var e=[];angular.forEach(l.saved_items,function(t,a){var o=u(t);o&&e.push(o)}),r.addFeatures(e),l.source=r,o.$on("map.extent_changed",function(e,t,a){l.update()}),l.update()},o.$on("map.loaded",function(){e.map;l.init()})}]).run(["hs.panoramio.service",function(e){console&&console.log("Panoramio loaded")}])});