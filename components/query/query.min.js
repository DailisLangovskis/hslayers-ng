define(["angular","ol","map","core","angular-sanitize","olPopup"],function(angular,ol){angular.module("hs.query",["hs.map","hs.core","ngSanitize"]).directive("hs.query.directiveInfopanel",["config",function(e){return{templateUrl:e.infopanel_template||hsl_path+"components/query/partials/infopanel.html?bust="+gitsha}}]).directive("hs.query.infovalue",["$compile",function(e){return{link:function(t,n,r){if("hstemplate"!=r.attribute)if(r.template)(a=angular.element("<span "+r.template+"></span>")).attr({attribute:r.attribute,value:r.value}),n.append(a),e(a)(t);else if(r.value)if(0==r.value.indexOf("http")){var a=angular.element("<a>");a.attr({target:"_blank",href:r.value}),a.html(r.value),n.html(a)}else n.html(r.value);else n.html(r.attribute)}}}]).service("hs.query.service_getwmsfeatureinfo",["hs.utils.service",function(e){this.request=function(t,n,r,a){var i=e.proxify(t,!0),o=this;$.ajax({url:i,cache:!1,success:function(e){o.featureInfoReceived(e,n,t,r,a)},error:function(){o.featureInfoError()}})}}]).service("hs.query.service_infopanel",["$rootScope",function(e){var t={attributes:[],groups:[],coordinates:[],setAttributes:function(n){t.attributes=n,e.$broadcast("infopanel.updated")},setGroups:function(n){t.groups=n,e.$broadcast("infopanel.updated")},setCoordinates:function(n){t.coordinates=n,e.$broadcast("infopanel.updated")},enabled:!0};return t}]).controller("hs.query.controller",["$scope","$compile","hs.map.service","hs.query.service_getwmsfeatureinfo","hs.query.service_infopanel","Core","$sce","$rootScope","config",function(e,t,n,r,a,i,o,u,s){function l(e,t,n){n?e.contents().find("body").append(t):e.contents().find("body").html(t);var r=e.contents().innerWidth();r>$("#map").width()-60&&(r=$("#map").width()-60),e.width(r);var a=e.contents().innerHeight();a>700&&(a=700),e.height(a)}ol.Feature.prototype.getLayer=function(e){var t,n=this,r=[],a=function(e){var t=e.getSource();if(t instanceof ol.source.Vector){var n=t.getFeatures();n.length>0&&r.push({layer:e,features:n})}};return e.getLayers().forEach(function(e){e instanceof ol.layer.Group?e.getLayers().forEach(a):a(e)}),r.forEach(function(e){e.features.some(function(e){return n===e})&&(t=e.layer)}),t};var c=n.map,f=new ol.geom.Point([0,0]),p=null;e.showQueryPoint=!angular.isDefined(s.showQueryPoint)||s.showQueryPoint;var d=new ol.interaction.Select({condition:ol.events.condition.click}),g=!1,h=new ol.Overlay.Popup;c.addOverlay(h),e.$on("map.loaded",e.addPopupToMap),d.getFeatures().on("add",function(e){a.groups=[],i.current_panel_queryable&&a.enabled&&(u.$broadcast("infopanel.feature_selected",e.element,d),e.element.get("hs_notqueryable")||m(e.element))}),d.getFeatures().on("remove",function(e){i.current_panel_queryable&&a.enabled&&(a.setAttributes([]),g=!1,u.$broadcast("infopanel.feature_deselected",e.element))});var m=function(t){if(i.current_panel_queryable){var n=[],r=!1;t.getKeys().forEach(function(e){if("gid"!=e&&"geometry"!=e)if("features"==e)for(var i in t.get("features")){var u=null;t.get("features")[i].get("hstemplate")&&(u=t.get("features")[i].get("hstemplate"));var s={name:"Feature",attributes:[],hstemplate:u};t.get("features")[i].getKeys().forEach(function(e){"gid"!=e&&"geometry"!=e&&("string"==(typeof t.get("features")[i].get(e)).toLowerCase()?s.attributes.push({name:e,value:o.trustAsHtml(t.get("features")[i].get(e))}):s.attributes.push({name:e,value:t.get("features")[i].get(e)}))}),r=!0,a.groups.push(s)}else{var l;l="string"==(typeof t.get(e)).toLowerCase()?{name:e,value:o.trustAsHtml(t.get(e))}:{name:e,value:t.get(e)},n.push(l)}});var u=t.getLayer(c),s=u.get("title")||u.get("name");r&&a.setGroups(a.groups),u instanceof ol.layer.Vector&&n.length>-1?e.displayGroupWithAttributes({name:s,attributes:n}):a.setAttributes(n),a.feature=t,c.removeLayer(p),c.addLayer(p),g=!0}};r.featureInfoError=function(){v--},r.featureInfoReceived=function(t,n,r,o,s){v--;var c=!1;if((n.indexOf("xml")>0||n.indexOf("gml")>0)&&($("featureMember",t).each(function(){var e=$(this)[0].firstChild,t={name:"Feature",attributes:[]};for(var n in e.children)0==e.children[n].childElementCount&&(t.attributes.push({name:e.children[n].localName,value:e.children[n].innerHTML}),c=!0);c&&a.groups.push(t)}),$("msGMLOutput",t).each(function(){for(var e in $(this)[0].children){var t=$(this)[0].children[e],n="";if(void 0!==t.children)for(var r=0;r<t.children.length;r++){var i=t.children[r];if("gml:name"==i.nodeName)n=i.innerHTML;else{var o={name:n+" Feature",attributes:[]};for(var u in i.children)0==i.children[u].childElementCount&&(o.attributes.push({name:i.children[u].localName,value:i.children[u].innerHTML}),c=!0);c&&a.groups.push(o)}}}}),c&&(a.setGroups(a.groups),i.setMainPanel("info"))),n.indexOf("html")>0){if(t.length<=1)return;l($("#invisible_popup"),t,!0)}if(0===v){if($("#invisible_popup").contents().find("body").html().length<30)return h.hide(),!1;e.$apply(function(){void 0!=s.get("popupClass")?h.getElement().className="ol-popup "+s.get("popupClass"):h.getElement().className="ol-popup",h.show(o,$("#invisible_popup").contents().find("body").html()),u.$broadcast("popupOpened","hs.query")})}};var v=0;e.InfoPanelService=a,e.displayGroupWithAttributes=function(t){a.groups.push(t),e.$$phase||e.$digest()},e.showCoordinate=function(e){f.setCoordinates(e,"XY");var t={name:"Coordinates",projections:[{name:"EPSG:4326",value:ol.coordinate.toStringHDMS(ol.proj.transform(e,"EPSG:3857","EPSG:4326"))},{name:"EPSG:3857",value:ol.coordinate.createStringXY(7)(e)}]};a.setCoordinates(t)};var y=function(e){return!!(e instanceof ol.layer.Tile&&e.getSource()instanceof ol.source.TileWMS&&e.getSource().getParams().INFO_FORMAT)||!!(e instanceof ol.layer.Image&&e.getSource()instanceof ol.source.ImageWMS&&e.getSource().getParams().INFO_FORMAT)};e.queryWmsLayer=function(e,t){if(y(e)){var n=e.getSource(),a=c.getView().getResolution(),o=n.getGetFeatureInfoUrl(t,a,n.getProjection()?n.getProjection():c.getView().getProjection(),{INFO_FORMAT:n.getParams().INFO_FORMAT});void 0!==e.get("featureInfoLang")[i.language]&&(o=o.replace(n.getUrl(),e.get("featureInfoLang")[i.language])),o&&(console&&console.log(o),(n.getParams().INFO_FORMAT.indexOf("xml")>0||n.getParams().INFO_FORMAT.indexOf("html")>0||n.getParams().INFO_FORMAT.indexOf("gml")>0)&&(v++,r.request(o,n.getParams().INFO_FORMAT,t,e)))}},e.activateFeatureQueries=function(){c.addInteraction(d)},e.clearInfoPanel=function(){a.attributes=[],a.setGroups([]),a.setCoordinates([])},e.activateFeatureQueries(),e.$on("infopanel.updated",function(t){e.$$phase||e.$digest()}),e.createCurrentPointLayer=function(){p&&c.getLayers().remove(p),(p=new ol.layer.Vector({title:"Point clicked",source:new ol.source.Vector({features:[new ol.Feature({geometry:f})]}),show_in_manager:!1})).setVisible(e.showQueryPoint)},e.$on("layermanager.updated",function(t,n){n!=p&&e.createCurrentPointLayer()}),e.$on("infopanel.feature_select",function(e,t){d.getFeatures().clear(),d.getFeatures().push(t)}),e.$on("core.mainpanel_changed",function(e,t){angular.isDefined(t)&&"info"==t.panel_name&&(h.hide(),d.getFeatures().clear(),p&&c.getLayers().remove(p))}),e.createCurrentPointLayer(),c.on("singleclick",function(t){e.$emit("map_clicked",t),i.current_panel_queryable&&a.enabled&&($("#invisible_popup").contents().find("body").html(""),$("#invisible_popup").height(0).width(0),g||(e.clearInfoPanel(),c.removeLayer(p),c.addLayer(p)),h.hide(),e.showCoordinate(t.coordinate),(["layermanager","","permalink"].indexOf(i.mainpanel)>=0||"info"==i.mainpanel&&0==i.sidebarExpanded)&&i.setMainPanel("info"),v=0,c.getLayers().forEach(function(n){void 0!=n.get("queryFilter")?n.get("queryFilter")(c,n,t.pixel)&&e.queryWmsLayer(n,t.coordinate):e.queryWmsLayer(n,t.coordinate)}))}),e.$on("popupOpened",function(e,t){angular.isDefined(t)&&"hs.query"!=t&&angular.isDefined(h)&&h.hide()}),e.$emit("scope_loaded","Query")}])});