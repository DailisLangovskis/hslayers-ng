define(["angular","ol","map","core","angular-sanitize","olPopup"],function(angular,ol){angular.module("hs.query",["hs.map","hs.core","ngSanitize"]).directive("hs.query.directiveInfopanel",["config",function(e){return{templateUrl:e.infopanel_template||hsl_path+"components/query/partials/infopanel.html?bust="+gitsha}}]).directive("hs.query.infovalue",["$compile",function(e){return{link:function(t,a,r){if("hstemplate"!=r.attribute)if(r.template)(n=angular.element("<span "+r.template+"></span>")).attr({attribute:r.attribute,value:r.value}),a.append(n),e(n)(t);else if(r.value)if(0==r.value.indexOf("http")){var n=angular.element("<a>");n.attr({target:"_blank",href:r.value}),n.html(r.value),a.html(n)}else a.html(r.value);else a.html(r.attribute)}}}]).service("hs.query.baseService",["$rootScope","hs.map.service","Core","$sce","config",function(e,t,a,r,n){function i(){(s=t.map).on("singleclick",function(t){u.queryActive&&(u.popupClassname="",c||u.clearData(),c=!1,u.currentQuery=(Math.random()+1).toString(36).substring(7),o(t.coordinate),u.last_coordinate_clicked=t.coordinate,e.$broadcast("queryClicked",t))})}function o(t){u.queryPoint.setCoordinates(t,"XY");var a={name:"Coordinates",projections:[{name:"EPSG:4326",value:ol.coordinate.toStringHDMS(ol.proj.transform(t,"EPSG:3857","EPSG:4326"))},{name:"EPSG:3857",value:ol.coordinate.createStringXY(7)(t)}]};u.setData(a,"coordinates",!0),e.$$phase||e.$digest()}var s,u=this;this.queryPoint=new ol.geom.Point([0,0]),this.queryLayer=new ol.layer.Vector({title:"Point clicked",source:new ol.source.Vector({features:[new ol.Feature({geometry:u.queryPoint})]}),show_in_manager:!1,removable:!1,style:function(e){var t=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"rgba(255, 156, 156, 0.4)"}),stroke:new ol.style.Stroke({color:"#cc3333",width:1}),radius:5})});return angular.isDefined(n.queryPoint)&&("hidden"==n.queryPoint?t.getImage().setRadius(0):"notWithin"==n.queryPoint&&u.selector.getFeatures().getLength()>0&&t.getImage().setRadius(0)),t}}),this.data={},this.data.attributes=[],this.data.groups=[],this.data.coordinates=[],this.queryActive=!1,this.popupClassname="",this.selector,this.currentQuery;var c=!0;angular.isDefined(t.map)?i():e.$on("map.loaded",i),this.setData=function(t,a,r){angular.isDefined(a)?(angular.isDefined(r)&&r&&(u.data[a].length=0),u.data[a].push(t),e.$broadcast("infopanel.updated"),e.$broadcast("query.dataUpdated")):console&&console.log("Query.BaseService.setData type not passed")},this.clearData=function(){u.data.attributes.length=0,u.data.groups.length=0,u.data.coordinates.length=0,$("#invisible_popup").contents().find("body").html(""),$("#invisible_popup").height(0).width(0),c=!0},this.fillIframeAndResize=function(e,t,a){a?e.contents().find("body").append(t):e.contents().find("body").html(t);var r=e.contents().innerWidth();r>$("#map").width()-60&&(r=$("#map").width()-60),e.width(r);var n=e.contents().innerHeight();n>700&&(n=700),e.height(n)},this.activateQueries=function(){u.queryActive=!0,s.addLayer(u.queryLayer),e.$broadcast("queryStatusChanged")},this.deactivateQueries=function(){u.queryActive=!1,s.removeLayer(u.queryLayer),e.$broadcast("queryStatusChanged")},e.$on("vectorSelectorCreated",function(e,t){u.selector=t})}]).service("hs.query.wmsService",["$rootScope","$sce","hs.query.baseService","hs.map.service","hs.utils.service",function(e,t,a,r,n){function i(t){(a.data.groups.length>0||$("#invisible_popup").contents().find("body").html().length>30)&&e.$broadcast("queryWmsResult",t)}function o(e){return!!(e instanceof ol.layer.Tile&&e.getSource()instanceof ol.source.TileWMS&&e.getSource().getParams().INFO_FORMAT)||!!(e instanceof ol.layer.Image&&e.getSource()instanceof ol.source.ImageWMS&&e.getSource().getParams().INFO_FORMAT)}var s=this;this.request=function(e,t,r,i){var o=n.proxify(e,!0),u=a.currentQuery;$.ajax({url:o,cache:!1,success:function(n){u==a.currentQuery&&s.featureInfoReceived(n,t,e,r,i)},error:function(){u==a.currentQuery&&s.featureInfoError(r)}})},this.featureInfoError=function(e){0==--infoCounter&&i(e)},this.featureInfoReceived=function(e,t,r,n,o){var s=!1;if(t.indexOf("xml")>0||t.indexOf("gml")>0){var u=e.getElementsByTagName("gml:featureMember")||e.getElementsByTagName("featureMember");angular.forEach(u,function(e){var t=o.get("title")||o.get("name"),r=e.getElementsByTagName("Layer");angular.forEach(r,function(e){var r=e.attributes[0].nodeValue,n=e.getElementsByTagName("Attribute"),i=[];angular.forEach(n,function(e){i.push({name:e.attributes[0].nodeValue,value:e.innerHTML}),s=!0});var o={layer:t,name:r,attributes:i};a.setData(o,"groups")})}),$("featureMember",e).each(function(){var e=$(this)[0].firstChild,t={name:"Feature",attributes:[]};for(var r in e.children)0==e.children[r].childElementCount&&(t.attributes.push({name:e.children[r].localName,value:e.children[r].innerHTML}),s=!0);s&&a.setData(t,"groups")}),$("msGMLOutput",e).each(function(){for(var e in $(this)[0].children){var t=$(this)[0].children[e],r="";if(void 0!==t.children)for(var n=0;n<t.children.length;n++){var i=t.children[n];if("gml:name"==i.nodeName)r=i.innerHTML;else{var o={name:r+" Feature",attributes:[]};for(var u in i.children)0==i.children[u].childElementCount&&(o.attributes.push({name:i.children[u].localName,value:i.children[u].innerHTML}),s=!0);s&&a.setData(o,"groups")}}}})}if(t.indexOf("html")>0){if(e.length<=1)return;a.fillIframeAndResize($("#invisible_popup"),e,!0),void 0!=o.get("popupClass")&&(a.popupClassname="ol-popup "+o.get("popupClass"))}0==--infoCounter&&i(n)},this.queryWmsLayer=function(e,t){if(o(e)){var a=e.getSource(),n=r.map,i=n.getView().getResolution(),u=a.getGetFeatureInfoUrl(t,i,a.getProjection()?a.getProjection():n.getView().getProjection(),{INFO_FORMAT:a.getParams().INFO_FORMAT});angular.isDefined(e.get("featureInfoLang"))&&angular.isDefined(e.get("featureInfoLang")[Core.language])&&(u=u.replace(a.getUrl(),e.get("featureInfoLang")[Core.language])),u&&(console&&console.log(u),(a.getParams().INFO_FORMAT.indexOf("xml")>0||a.getParams().INFO_FORMAT.indexOf("html")>0||a.getParams().INFO_FORMAT.indexOf("gml")>0)&&(infoCounter++,s.request(u,a.getParams().INFO_FORMAT,t,e)))}},e.$on("queryClicked",function(e,t){infoCounter=0,r.map.getLayers().forEach(function(e){void 0!=e.get("queryFilter")?e.get("queryFilter")(r.map,e,t.pixel)&&s.queryWmsLayer(e,t.coordinate):s.queryWmsLayer(e,t.coordinate)})})}]).service("hs.query.vectorService",["$rootScope","hs.query.baseService","$sce","hs.map.service","config",function(e,t,a,r,n){function i(n){var i=[];n.getKeys().forEach(function(e){if("gid"!=e&&"geometry"!=e)if("features"==e)for(var r in n.get("features")){var o=null;n.get("features")[r].get("hstemplate")&&(o=n.get("features")[r].get("hstemplate"));var s={name:"Feature",attributes:[],hstemplate:o};n.get("features")[r].getKeys().forEach(function(e){"gid"!=e&&"geometry"!=e&&("string"==(typeof n.get("features")[r].get(e)).toLowerCase()?s.attributes.push({name:e,value:a.trustAsHtml(n.get("features")[r].get(e))}):s.attributes.push({name:e,value:n.get("features")[r].get(e)}))}),t.setData(s,"groups")}else{var u;u="string"==(typeof n.get(e)).toLowerCase()?{name:e,value:a.trustAsHtml(n.get(e))}:{name:e,value:n.get(e)},i.push(u)}});var o=n.getLayer(r.map);if(!(angular.isUndefined(o)||angular.isDefined(o.get("show_in_manager"))&&!1===o.get("show_in_manager"))){var s={layer:o.get("title")||o.get("name"),name:"Feature",attributes:i};t.setData(s,"groups"),e.$broadcast("queryVectorResult")}}var o=this;this.selector=new ol.interaction.Select({condition:ol.events.condition.click,multi:!(!angular.isDefined(n.query)||!n.query.multi)&&n.query.multi}),e.$broadcast("vectorSelectorCreated",o.selector),t.queryActive&&r.map.addInteraction(o.selector),e.$on("queryStatusChanged",function(){t.queryActive?r.map.addInteraction(o.selector):r.map.removeInteraction(o.selector)}),o.selector.getFeatures().on("add",function(a){if(t.clearData(),t.queryActive&&!a.element.get("hs_notqueryable")){e.$broadcast("vectorQuery.featureSelected",a.element,o.selector),e.$broadcast("infopanel.feature_selected",a.element,o.selector);var r=o.selector.getFeatures().getArray();angular.forEach(r,function(e){i(e)})}}),o.selector.getFeatures().on("remove",function(a){if(t.clearData(),t.queryActive){t.data.attributes.length=0,e.$broadcast("vectorQuery.featureDelected",a.element),e.$broadcast("infopanel.feature_deselected",a.element);var r=o.selector.getFeatures().getArray();angular.forEach(r,function(e){i(e)})}})}]).controller("hs.query.controller",["$scope","$rootScope","hs.map.service","hs.query.baseService","hs.query.wmsService","hs.query.vectorService","Core",function(e,t,a,r,n,i,o){var s=new ol.Overlay.Popup;a.map?a.map.addOverlay(s):t.$on("map.loaded",function(){a.map.addOverlay(s)}),e.data=r.data,o.current_panel_queryable?r.queryActive||r.activateQueries():r.queryActive&&r.deactivateQueries(),e.$on("queryClicked",function(){s.hide(),(["layermanager","","permalink"].indexOf(o.mainpanel)>=0||"info"==o.mainpanel&&0==o.sidebarExpanded)&&o.setMainPanel("info")}),e.$on("queryWmsResult",function(a,n){$("#invisible_popup").contents().find("body").children().not("style,title,meta").length>0&&(r.popupClassname.length>0?s.getElement().className=r.popupClassname:s.getElement().className="ol-popup",s.show(n,$("#invisible_popup").contents().find("body").html()),t.$broadcast("popupOpened","hs.query")),e.$$phase||e.$digest()}),e.$on("queryVectorResult",function(){e.$$phase||e.$digest()}),e.$on("core.mainpanel_changed",function(e,t){angular.isDefined(t)&&"info"==t.panel_name?(s.hide(),r.deactivateQueries()):o.current_panel_queryable?r.queryActive||r.activateQueries():r.queryActive&&r.deactivateQueries()}),e.$on("popupOpened",function(e,t){angular.isDefined(t)&&"hs.query"!=t&&angular.isDefined(s)&&s.hide()}),e.$emit("scope_loaded","Query")}])});