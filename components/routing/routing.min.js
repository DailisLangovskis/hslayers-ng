define(["angular","ol","s4a","map","core"],function(angular,ol,e){angular.module("hs.routing",["hs.map","hs.core"]).directive("hs.routing.directive",function(){return{templateUrl:hsl_path+"components/routing/partials/routing.html?bust="+gitsha}}).controller("hs.routing.controller",["$scope","hs.map.service","Core",function(t,a,n){var o,r=e.analytics.Routing,i=a.map,s=new ol.source.Vector,c=new ol.format.GeoJSON,u=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ff0000",width:3}),image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:"#ff0000"})})}),l=new ol.layer.Vector({source:s,style:u}),d=function(e,t){return!0===t?ol.proj.transform(e,"EPSG:3857","EPSG:4326"):ol.proj.transform(e,"EPSG:4326","EPSG:3857")};t.operation="",t.reachableArea={distance:"5000"},t.optimalRoute={isLoop:!0};var p=function(){t.operation="ShortestRoute"};t.searchResults=[],t.wayPoints=[],t.setOperation=function(e){t.clearAll(),t.clearWayPoints(),t.clearSearchResults(),t.operation=e,t.$$phase||t.$digest()},t.clearAll=function(){p(),s.clear()},t.clearWayPoints=function(){t.wayPoints.length=0,s.clear(),t.$$phase||t.$digest()},t.clearSearchResults=function(){t.searchResults.length=0};var h=function(e){"ShortestRoute"===t.operation?f(e):"ReachableArea"===t.operation?m(e):"OptimalRoute"===t.operation&&g(e)},f=function(e){t.wayPoints.length>=2&&t.clearWayPoints(),y(e.coordinate)},g=function(e){y(e.coordinate)};t.optimizeRoute=function(){if(s.clear(),t.wayPoints.length<3)console.log("This does not make sense with less than 3 points");else{var e,a=t.wayPoints.map(function(e){return e.id}),n=t.wayPoints[0].id;e=!0===t.optimalRoute.isLoop?n:t.wayPoints[t.wayPoints.length-1].id;var o=function(e,t,a){if(a!==t){for(var n=e[t],o=a<t?-1:1,r=t;r!=a;r+=o)e[r]=e[r+o];return e[a]=n,e}};t.moveUp=function(e){o(t.wayPoints,e,e-1),t.$$phase||t.$apply()},t.moveDown=function(e){o(t.wayPoints,e,e+1),t.$$phase||t.$apply()},r.getOptimalRoute(a,n,e).then(function(e){var a=e.data;!0===t.optimalRoute.isLoop&&a.push(a[0]);for(var n=0;n<a.length-1;n++)r.getShortestRoute(a[n].id,a[n+1].id).then(function(e){for(var t=0;t<e.data.length;t++){var a=c.readFeature(e.data[t],{featureProjection:"EPSG:3857"});s.addFeature(a)}})})}};var m=function(e){var a=d(e.coordinate,!0);r.getNearestNode(a[0],a[1]).then(function(e){"success"===e.status&&e.count>0&&w(e.data.id,+t.reachableArea.distance)})},y=function(e){var a=d(e,!0);r.getNearestNode(a[0],a[1],100).then(function(e){"success"===e.status&&(s.addFeature(new ol.Feature({geometry:new ol.geom.Point(d([e.data.lon,e.data.lat]))})),t.wayPoints.push(jQuery.extend({},e.data)),"ShortestRoute"===t.operation&&2==t.wayPoints.length&&P(t.wayPoints[0].id,t.wayPoints[1].id),t.$$phase||t.$digest())})},v=function(e){for(var t,a=[],n={streetname:null,distance:0},o=0,r=0;r<e.length;r++){var i=e[r];(i.properties.streetname!==t&&o>0||o===e.length-1)&&a.push(jQuery.extend({},n)),i.properties.streetname!==t?(n.streetname=""!==i.properties.streetname?i.properties.streetname:"<unnamed street>",n.distance=i.properties.distance):n.distance+=+i.properties.distance,t=i.properties.streetname,o++}return a},P=function(e,a){r.getShortestRoute(e,a).then(function(e){if("success"===e.status&&e.count>0){t.clearSearchResults();for(var a=0;a<e.data.length;a++){var n=c.readFeature(e.data[a],{featureProjection:"EPSG:3857"});s.addFeature(n)}t.searchResults.length=0,jQuery.extend(t.searchResults,v(e.data)),t.$$phase||t.$digest()}})},w=function(e,t){r.getReachableArea(e,t).then(function(e){s.clear();var t=c.readFeature(e.feature,{featureProjection:"EPSG:3857"});t.set("hs_notqueryable",!0),s.addFeature(t)})};t.activate=function(){i.addLayer(l),o=i.on("singleclick",h)},t.deactivate=function(){i.removeLayer(l),s.clear(),i.unByKey(o),t.clearAll()},t.$on("core.mainpanel_changed",function(e){"routing"===n.mainpanel?(p(),t.activate()):t.deactivate()}),t.$on("scope_loaded",function(e,a){"routing"===n.mainpanel&&"routing"===a?(p(),t.activate()):t.deactivate()}),t.$emit("scope_loaded","routing")}])});