define(["angular","angularjs-socialshare","map","core","status_creator","compositions"],function(angular,e){angular.module("hs.permalink",["720kb.socialshare","hs.core","hs.map","hs.status_creator","hs.compositions"]).config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1})}]).directive("hs.permalink.directive",function(){return{templateUrl:hsl_path+"components/permalink/partials/directive.html?bust="+gitsha}}).service("hs.permalink.service_url",["$rootScope","$location","$window","hs.map.service","Core","hs.utils.service","hs.status_creator.service","hs.compositions.service_parser","config",function(e,a,r,t,n,o,i,s,l){function m(){if(c){var a=null;e.$on("map.extent_changed",function(a,r,t){u.update(),e.$broadcast("browserurl.updated")}),t.map.getLayers().on("add",function(r){var t=r.element;null!=t.get("show_in_manager")&&0==t.get("show_in_manager")||t.on("change:visible",function(r){null!=a&&clearTimeout(a),a=setTimeout(function(){u.update(),e.$broadcast("browserurl.updated")},1e3)})})}}var c=!0,u={};u.shareId=null,u.current_url="",u.permalinkLayers="",u.added_layers=[],u.params={},u.customParams={},u.update=function(r){var o=t.map.getView();u.id=i.generateUuid();var s=[],l=[];t.map.getLayers().forEach(function(e){angular.isDefined(e.get("show_in_manager"))&&null!=e.get("show_in_manager")&&0==e.get("show_in_manager")||(e.getVisible()&&s.push(e.get("title")),0!=e.manuallyAdded&&l.push(e))}),u.added_layers=i.layers2json(l),n.mainpanel&&("permalink"==n.mainpanel?u.push("hs_panel","layermanager"):u.push("hs_panel",n.mainpanel)),u.push("hs_x",o.getCenter()[0]),u.push("hs_y",o.getCenter()[1]),u.push("hs_z",o.getZoom()),u.push("visible_layers",s.join(";")),n.puremapApp&&u.push("puremap","true");for(var m in u.customParams)u.push(m,u.customParams[m]);a.search(u.params),e.$$phase||e.$digest()},u.getPermalinkUrl=function(){var e=JSON.stringify(u.permalinkLayers);return e=e.substring(1,e.length-1),n.isMobile()&&l.permalinkLocation?(l.permalinkLocation.origin+u.current_url.replace(window.location.pathname,l.permalinkLocation.pathname)+"&permalink="+encodeURIComponent(e)).replace(window.location.pathname,l.permalinkLocation.pathname):window.location.origin+u.current_url+"&permalink="+encodeURIComponent(e)},u.getPureMapUrl=function(){var e={};return e.puremap="true",u.getPermalinkUrl()+"&"+o.paramsToURLWoEncode(e)},u.parse=function(e){return"string"!=typeof e?{}:(e=e.trim().replace(/^\?/,""))?e.trim().split("&").reduce(function(e,a){var r=a.replace(/\+/g," ").split("="),t=r[0],n=r[1];return t=decodeURIComponent(t),n=void 0===n?null:decodeURIComponent(n),e.hasOwnProperty(t)?Array.isArray(e[t])?e[t].push(n):e[t]=[e[t],n]:e[t]=n,e},{}):{}},u.parsePermalinkLayers=function(){var e=o.proxify(u.getParamValue("permalink"));$.ajax({url:e}).done(function(e){if(1==e.success){var a={};a.data={},a.data.layers=e.data,s.removeCompositionLayers(),e.layers=e.data;for(var r=s.jsonToLayers(a),n=0;n<r.length;n++)t.map.addLayer(r[n])}else console&&console.log("Error loading permalink layers")})},u.stringify=function(e){return e?Object.keys(e).map(function(a){var r=e[a];return Array.isArray(r)?r.map(function(e){return encodeURIComponent(a)+"="+encodeURIComponent(e)}).join("&"):encodeURIComponent(a)+"="+encodeURIComponent(r)}).join("&"):""},u.push=function(e,a){u.params[e]=a;var r=u.stringify(u.params);u.param_string=r,u.pathname=window.location.pathname,u.current_url=u.pathname+"?"+r},u.getParamValue=function(e){var a=u.parse(location.search);return a[e]?a[e]:null};var p=null;return u.updateCustomParams=function(e){for(param in e)u.customParams[param]=e[param];null!=p&&clearTimeout(p),p=setTimeout(function(){u.update()},1e3)},angular.isDefined(t.map)?m():e.$on("map.loaded",function(){m()}),u}]).service("hs.permalink.shareService",["$rootScope","$http","Core","config","hs.permalink.service_url","Socialshare","hs.utils.service","hs.map.service","$q",function(e,a,r,t,n,o,i,s,l){function m(){return angular.isDefined(t.hostname)?t.hostname.user?t.hostname.user.url:t.hostname.status_manager?t.hostname.status_manager.url:t.hostname.default.url:""}return me.data={},me.data.pureMapUrl="",me.data.permalinkUrl="",me.data.shareLink="permalink",me.data.embedCode="",me.data.shareUrlValid=!1,me.data.title="",me.data.abstract="",me.getEmbedCode=function(){return me.data.embedCode='<iframe src="'+me.getShareUrl()+'" width="1000" height="700"></iframe>',e.$$phase||e.$digest(),me.data.embedCode},me.getShareUrl=function(){return"permalink"==me.data.shareLink?me.data.permalinkUrl:"puremap"==me.data.shareLink?me.data.pureMapUrl:void 0},me.setShareType=function(e){me.data.shareLink=e,me.getEmbedCode()},me.invalidateShareUrl=function(){me.data.shareUrlValid=!1},me.shareOnSocial=function(e,r){me.data.shareUrlValid?o.share({provider:e,attrs:{socialshareText:me.data.title,socialshareUrl:me.getShareUrl(),socialsharePopupHeight:600,socialsharePopupWidth:500}}):((null==n.shareId||r)&&(n.shareId=i.generateUuid()),$.ajax({url:m()+t.status_manager_url,cache:!1,method:"POST",async:!1,data:JSON.stringify({request:"socialShare",id:n.shareId,url:encodeURIComponent(me.getShareUrl()),title:me.data.title,description:me.data.abstract,image:me.data.thumbnail}),success:function(r){a.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:m()+t.status_manager_url+"?request=socialshare&id="+n.shareId}).success(function(a,r,t,n){var i=a.id;o.share({provider:e,attrs:{socialshareText:me.data.title,socialshareUrl:i,socialsharePopupHeight:600,socialsharePopupWidth:500}}),me.data.shareUrlValid=!0}).error(function(e,a,r,t){console.log("Error creating short Url")})}}))},me.generateThumbnail=function(e){"status_creator"!=r.mainpanel&&"permalink"!=r.mainpanel&&"shareMap"!=r.mainpanel||(e.attr("crossOrigin","Anonymous"),s.map.once("postcompose",function(a){document.getElementById("my_canvas_id");var r=a.context.canvas,t=document.createElement("canvas");t.style.width="256px",t.style.height="256px",t.width=256,t.height=256,t.getContext("2d").drawImage(r,r.width/2-128,r.height/2-128,256,256,0,0,256,256);try{e.attr("src",t.toDataURL("image/png")),this.data.thumbnail=t.toDataURL("image/jpeg",.8)}catch(a){e.attr("src",hsl_path+"components/status_creator/notAvailable.png")}e.width(256).height(256)},me),s.map.renderSync())},e.$on("core.mainpanel_changed",function(a){if("permalink"==r.mainpanel){n.update();var o=m()+(t.status_manager_url||"/wwwlibs/statusmanager2/index.php");n.added_layers.length>0?$.ajax({url:o,cache:!1,method:"POST",dataType:"json",data:JSON.stringify({data:n.added_layers,permalink:!0,id:n.id,project:t.project_name,request:"save"}),success:function(a){n.permalinkLayers=o+"?request=load&id="+n.id,e.$broadcast("browserurl.updated")},error:function(){console.log("Error saving permalink layers.")}}):e.$broadcast("browserurl.updated")}}),e.$on("browserurl.updated",function(){"permalink"!=r.mainpanel&&"shareMap"!=r.mainpanel||(me.data.shareUrlValid=!1,l.all([a.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:n.getPureMapUrl()}).success(function(e,a,r,t){me.data.pureMapUrl=e.id}).error(function(e,a,r,t){console.log("Error creating short Url"),me.data.pureMapUrl=n.getPureMapUrl()}),a.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:n.getPermalinkUrl()}).success(function(e,a,r,t){me.data.permalinkUrl=e.id}).error(function(e,a,r,t){console.log("Error creating short Url"),me.data.permalinkUrl=n.getPermalinkUrl()})]).then(function(){me.getEmbedCode()})),e.$$phase||e.$digest()}),e.$on("core.mainpanel_changed",function(e){"permalink"==r.mainpanel&&s.map.once("postrender",function(){me.generateThumbnail($("#hs-permalink-thumbnail"))})}),e.$on("map.extent_changed",function(e){s.map.once("postrender",function(){me.generateThumbnail($("#hs-permalink-thumbnail"))})}),e.$on("compositions.composition_loaded",function(e,a){angular.isDefined(a.data)&&(a=a.data,me.data.title=a.title,t.social_hashtag&&(me.data.title+=" "+t.social_hashtag),me.data.abstract=a.abstract)}),me}]).controller("hs.permalink.controller",["$scope","hs.permalink.service_url","hs.permalink.shareService",function(e,a,r){e.data=r.data,e.new_share=!1,e.updateEmbedCode=function(){return r.getEmbedCode()},e.getShareUrl=function(){return r.getShareUrl()},e.setShareType=function(e){r.setShareType(e)},e.invalidateShareUrl=function(){r.invalidateShareUrl()},e.shareOnSocial=function(a){r.shareOnSocial(a,e.new_share)},e.$emit("scope_loaded","Permalink")}])});