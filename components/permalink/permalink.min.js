define(["angular","angularjs-socialshare","map","core","status_creator","compositions"],function(angular,e){angular.module("hs.permalink",["720kb.socialshare","hs.core","hs.map","hs.status_creator","hs.compositions"]).config(["$locationProvider",function(e){e.html5Mode({enabled:!0,requireBase:!1})}]).directive("hs.permalink.directive",function(){return{templateUrl:hsl_path+"components/permalink/partials/directive.html?bust="+gitsha}}).service("hs.permalink.service_url",["$rootScope","$location","$window","hs.map.service","Core","hs.utils.service","hs.status_creator.service","hs.compositions.service_parser","config",function(e,a,r,n,t,o,s,i,l){function c(){if(u){var a=null;e.$on("map.extent_changed",function(a,r,n){p.update(),"permalink"==t.mainpanel&&e.$broadcast("browserurl.updated")}),n.map.getLayers().on("add",function(e){var r=e.element;null!=r.get("show_in_manager")&&0==r.get("show_in_manager")||r.on("change:visible",function(e){null!=a&&clearTimeout(a),a=setTimeout(function(){p.update()},1e3)})})}}var u=!0,p={};p.current_url="",p.permalinkLayers="",p.added_layers=[],p.params={},p.customParams={},p.update=function(r){var o=n.map.getView();p.id=s.generateUuid();var i=[],l=[];n.map.getLayers().forEach(function(e){angular.isDefined(e.get("show_in_manager"))&&null!=e.get("show_in_manager")&&0==e.get("show_in_manager")||(e.getVisible()&&i.push(e.get("title")),0!=e.manuallyAdded&&l.push(e))}),p.added_layers=s.layers2json(l),t.mainpanel&&("permalink"==t.mainpanel?p.push("hs_panel","layermanager"):p.push("hs_panel",t.mainpanel)),p.push("hs_x",o.getCenter()[0]),p.push("hs_y",o.getCenter()[1]),p.push("hs_z",o.getZoom()),p.push("visible_layers",i.join(";"));for(var c in p.customParams)p.push(c,p.customParams[c]);a.search(p.params),e.$$phase||e.$digest()},p.getPermalinkUrl=function(){var e=JSON.stringify(p.permalinkLayers);return e=e.substring(1,e.length-1),t.isMobile()&&l.permalinkLocation?(l.permalinkLocation.origin+p.current_url.replace(window.location.pathname,l.permalinkLocation.pathname)+"&permalink="+encodeURIComponent(e)).replace(window.location.pathname,l.permalinkLocation.pathname):window.location.origin+p.current_url+"&permalink="+encodeURIComponent(e)},p.getPureMapUrl=function(){var e={};return e.puremap="true",p.getPermalinkUrl()+"&"+o.paramsToURLWoEncode(e)},p.parse=function(e){return"string"!=typeof e?{}:(e=e.trim().replace(/^\?/,""),e?e.trim().split("&").reduce(function(e,a){var r=a.replace(/\+/g," ").split("="),n=r[0],t=r[1];return n=decodeURIComponent(n),t=void 0===t?null:decodeURIComponent(t),e.hasOwnProperty(n)?Array.isArray(e[n])?e[n].push(t):e[n]=[e[n],t]:e[n]=t,e},{}):{})},p.parsePermalinkLayers=function(){var e=o.proxify(p.getParamValue("permalink"));$.ajax({url:e}).done(function(e){if(1==e.success){var a={};a.data={},a.data.layers=e.data,i.removeCompositionLayers(),e.layers=e.data;for(var r=i.jsonToLayers(a),t=0;t<r.length;t++)n.map.addLayer(r[t])}else console&&console.log("Error loading permalink layers")})},p.stringify=function(e){return e?Object.keys(e).map(function(a){var r=e[a];return Array.isArray(r)?r.map(function(e){return encodeURIComponent(a)+"="+encodeURIComponent(e)}).join("&"):encodeURIComponent(a)+"="+encodeURIComponent(r)}).join("&"):""},p.push=function(e,a){p.params[e]=a;var r=p.stringify(p.params);p.param_string=r,p.pathname=window.location.pathname,p.current_url=p.pathname+"?"+r},p.getParamValue=function(e){var a=p.parse(location.search);return a[e]?a[e]:null};var m=null;return p.updateCustomParams=function(e){for(param in e)p.customParams[param]=e[param];null!=m&&clearTimeout(m),m=setTimeout(function(){p.update()},1e3)},angular.isDefined(n.map)?c():e.$on("map.loaded",function(){c()}),p}]).controller("hs.permalink.controller",["$rootScope","$scope","$http","Core","config","hs.permalink.service_url","Socialshare","hs.utils.service","hs.status_creator.service","$q",function(e,a,r,n,t,o,s,i,l,c){function u(){return angular.isDefined(t.hostname)?t.hostname.user?t.hostname.user.url:t.hostname.status_manager?t.hostname.status_manager.url:t.hostname.default.url:""}a.embedCode="",a.shareUrlValid=!1,o.shareId=null,a.new_share=!1,a.shareLink="permalink",a.updateEmbedCode=function(){a.embedCode='<iframe src="'+a.selectShareUrl()+'" width="1000" height="700"></iframe>'},a.selectShareUrl=function(){return"permalink"==a.shareLink?a.permalinkUrl:a.pureMapUrl},a.invalidateShareUrl=function(){a.shareUrlValid=!1},a.shareOnSocial=function(e){a.shareProvider=e,a.shareUrlValid?s.share({provider:e,attrs:{socialshareText:a.title,socialshareUrl:a.share_url,socialsharePopupHeight:600,socialsharePopupWidth:500}}):((null==o.shareId||a.new_share)&&(o.shareId=i.generateUuid()),$.ajax({url:u()+t.status_manager_url,cache:!1,method:"POST",async:!1,data:JSON.stringify({request:"socialShare",id:o.shareId,url:encodeURIComponent(a.selectShareUrl()),title:a.title,description:a.abstract,image:a.thumbnail}),success:function(e){r.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:u()+t.status_manager_url+"?request=socialshare&id="+o.shareId}).success(function(e,r,n,t){a.share_url=e.id,s.share({provider:a.shareProvider,attrs:{socialshareText:a.title,socialshareUrl:a.share_url,socialsharePopupHeight:600,socialsharePopupWidth:500}}),a.shareUrlValid=!0}).error(function(e,a,r,n){console.log("Error creating short Url")})}}))},a.$on("core.mainpanel_changed",function(r){if("permalink"==n.mainpanel){o.update();var s=u()+(t.status_manager_url||"/wwwlibs/statusmanager2/index.php");o.added_layers.length>0?$.ajax({url:s,cache:!1,method:"POST",dataType:"json",data:JSON.stringify({data:o.added_layers,permalink:!0,id:o.id,project:t.project_name,request:"save"}),success:function(a){o.permalinkLayers=s+"?request=load&id="+o.id,e.$broadcast("browserurl.updated")},error:function(){console.log("Error saving permalink layers."),a.success=!1}}):e.$broadcast("browserurl.updated")}}),a.$on("browserurl.updated",function(){"permalink"==n.mainpanel&&(a.shareUrlValid=!1,c.all([r.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:o.getPureMapUrl()}).success(function(e,r,n,t){a.pureMapUrl=e.id}).error(function(e,r,n,t){console.log("Error creating short Url"),a.pureMapUrl=o.getPureMapUrl()}),r.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:o.getPermalinkUrl()}).success(function(e,r,n,t){a.permalinkUrl=e.id}).error(function(e,r,n,t){console.log("Error creating short Url"),a.permalinkUrl=o.getPermalinkUrl()})]).then(function(){a.updateEmbedCode()})),a.$$phase||a.$digest()}),a.$on("core.mainpanel_changed",function(e){"permalink"==n.mainpanel&&l.generateThumbnail($("#hs-permalink-thumbnail"),a)}),a.$on("map.extent_changed",function(e,r,n){l.generateThumbnail($("#hs-permalink-thumbnail"),a)}),a.$on("compositions.composition_loaded",function(e,r){angular.isDefined(r.data)&&(r=r.data,a.title=r.title,t.social_hashtag&&(a.title+=" "+t.social_hashtag),a.abstract=r.abstract)}),a.$emit("scope_loaded","Permalink")}])});