define(["angular","ol","map","utils"],function(angular,ol){angular.module("hs.legend",["hs.map","hs.utils"]).directive("hs.legend.directive",function(){return{templateUrl:hsl_path+"components/legend/partials/legend.html?bust="+gitsha}}).controller("hs.legend.controller",["$scope","hs.map.service","hs.utils.service",function(e,r,t){function s(e,r){return e.indexOf("proxy4ows")>-1&&(e=t.getParamsFromUrl(e).OWSURL),e+=(e.indexOf("?")>0?"":"?")+"&version=1.3.0&service=WMS&request=GetLegendGraphic&sld_version=1.1.0&layer="+r+"&format=image%2Fpng"}var i=r.map,n=function(r){e.addLayerToLegends(r.element)};e.layers=[],e.addLayerToLegends=function(r){if(r.getSource()instanceof ol.source.TileWMS||r.getSource()instanceof ol.source.ImageWMS){for(var t=r.getSource().getParams().LAYERS.split(","),i=0;i<t.length;i++)r.getSource()instanceof ol.source.TileWMS?t[i]=s(r.getSource().getUrls()[0],t[i]):r.getSource()instanceof ol.source.ImageWMS&&(t[i]=s(r.getSource().getUrl(),t[i]));r.on("change:visible",function(r){for(var t=0;t<e.layers.length;t++)if(e.layers[t].layer==r.target){e.layers[t].visible=r.target.getVisible();break}e.$$phase||e.$digest()}),e.layers.push({title:r.get("title"),lyr:r,type:"wms",sub_layers:t,visible:r.getVisible()})}else r.getSource().legend_categories&&(r.on("change:visible",function(r){for(var t=0;t<e.layers.length;t++)if(e.layers[t].layer==r.target){e.layers[t].visible=r.target.getVisible();break}e.$$phase||e.$digest()}),e.layers.push({title:r.get("title"),lyr:r,type:"vector",visible:r.getVisible()}))},e.getWmsLayerLegendUrl=function(e,r){return e+(e.indexOf("?")>0?"":"?")+"&version=1.3.0&service=WMS&request=GetLegendGraphic&sld_version=1.1.0&layer="+r+"&format=image%2Fpng"},e.removeLayerFromLegends=function(r){for(var t=0;t<e.layers.length;t++)if(e.layers[t].layer==r){e.layers.splice(t,1);break}},e.refresh=function(){e.$$phase||e.$digest()},e.hasLegend=function(e,r){return!(e.type!=r||!e.lyr.getVisible())||!(e.type!=r||!e.lyr.getVisible())},r.map.getLayers().forEach(function(e){n({element:e})}),i.getLayers().on("add",n),i.getLayers().on("remove",function(r){e.removeLayerFromLegends(r.element)}),e.$emit("scope_loaded","Legend")}])});