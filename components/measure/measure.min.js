define(["angular","ol","map","core"],function(angular,ol){angular.module("hs.measure",["hs.map","hs.core"]).directive("hs.measure.directive",function(){return{templateUrl:hsl_path+"components/measure/partials/measure.html?bust="+gitsha}}).service("hs.measure.service",["$rootScope","hs.map.service",function(e,t){function a(t){var a="area"==t?"Polygon":"LineString";n.draw=new ol.interaction.Draw({source:n.measureVector.getSource(),type:a}),r.addInteraction(n.draw),n.draw.on("drawstart",function(t){e.$broadcast("measure.drawStart"),n.data.multipleShapeMode?(Array.isArray(n.sketch)||(n.sketch=[],n.data.measurements.push({size:0,unit:""})),n.sketch.push(t.feature)):(n.sketch=[t.feature],n.data.measurements.push({size:0,unit:""})),n.currentMeasurement=n.data.measurements.length-1}),n.draw.on("drawend",function(t){e.$broadcast("measure.drawEnd")})}var r,n=this;angular.isDefined(t.map)?r=t.map:e.$on("map_loaded",function(){r=t.map}),this.draw,this.measureVector=new ol.layer.Vector({source:new ol.source.Vector,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2})})}),this.data={},this.data.measurements=[],this.data.multipleShapeMode=!1,this.sketch={},this.currentMeasurement,this.switchMultipleMode=function(e){angular.isDefined(e)?n.data.multipleShapeMode=e:n.data.multipleShapeMode=!n.data.multipleShapeMode},this.changeMeasureParams=function(e){r.removeInteraction(n.draw),n.sketch=null,a(e)},this.clearMeasurement=function(){n.draw.setActive(!1),n.data.measurements.length=0,n.measureVector.getSource().clear(),n.sketch=null,n.draw.setActive(!0)},this.activateMeasuring=function(e){r.addLayer(n.measureVector),$(r.getViewport()).on("mousemove",s),a(e)},this.deactivateMeasuring=function(){$(r.getViewport()).off("mousemove"),r.removeInteraction(n.draw),r.removeLayer(n.measureVector)};var s=function(t){if(n.sketch){for(var a,r=0;r<n.sketch.length;r++){var s=n.sketch[r].getGeometry();s instanceof ol.geom.Polygon?a=i(c(s),a):s instanceof ol.geom.LineString&&(a=i(u(s),a))}n.data.measurements[n.currentMeasurement]=a,n.data.measurements[n.currentMeasurement]&&(n.data.measurements[n.currentMeasurement].geom=n.sketch),e.$$phase||e.$digest()}},i=function(e,t){if(void 0==t)return e;var a=e.unit,r=e.type;if(e.unit==t.unit){i=Math.round(100*(e.size+t.size))/100;"m"==a&&"length"==r&&i>1e3?(i=Math.round(i/1e3*100)/100,a="km"):"m"==a&&"area"==r&&i>1e4&&(i=Math.round(i/1e6*100)/100,a="km")}else{for(var n=[e,t],s=0;s<n.length;s++)"m"==n[s].unit&&(n[s].size/="length"==r?1e3:1e6);var i=Math.round(100*(n[0].size+n[1].size))/100;a="km"}return{size:i,type:r,unit:a}},o=new ol.Sphere(6378137),u=function(e){for(var t=0,a=e.getCoordinates(),n=r.getView().getProjection(),s=0,i=a.length-1;s<i;++s){var u=ol.proj.transform(a[s],n,"EPSG:4326"),c=ol.proj.transform(a[s+1],n,"EPSG:4326");t+=o.haversineDistance(u,c)}var m={size:t,type:"length",unit:"m"};return t>100?(m.size=Math.round(t/1e3*100)/100,m.unit="km"):(m.size=Math.round(100*t)/100,m.unit="m"),m},c=function(e){var t=r.getView().getProjection(),a=e.clone().transform(t,"EPSG:4326").getLinearRing(0).getCoordinates();area=Math.abs(o.geodesicArea(a));var n={size:area,type:"area",unit:"m"};return area>1e4?(n.size=Math.round(area/1e6*100)/100,n.unit="km"):(n.size=Math.round(100*area)/100,n.unit="m"),n}}]).controller("hs.measure.controller",["$scope","hs.map.service","Core","hs.measure.service",function(e,t,a,r){e.data=r.data,$(document).keyup(function(t){17==t.which&&(r.switchMultipleMode(),e.$$phase||e.$digest())}),e.$on("measure.drawStart",function(){$("#toolbar").fadeOut()}),e.$on("measure.drawEnd",function(){$("#toolbar").fadeIn()}),e.type="distance",e.setType=function(t){e.type=t,r.switchMeasureType(t),e.$$phase||e.$digest()},e.clearAll=function(){r.clearMeasurement(),e.$$phase||e.$digest()},e.$watch("type",function(){"measure"==a.mainpanel&&r.changeMeasureParams(e.type)}),e.$on("core.mainpanel_changed",function(t){"measure"==a.mainpanel?r.activateMeasuring(e.type):r.deactivateMeasuring()}),"measure"==a.mainpanel&&(a.current_panel_queryable=!1,r.activateMeasuring(e.type)),e.$emit("scope_loaded","Measure")}])});