define(["angular","ol","map","core"],function(angular,ol){angular.module("hs.measure",["hs.map","hs.core"]).directive("hs.measure.directive",function(){return{templateUrl:hsl_path+"components/measure/partials/measure.html?bust="+gitsha}}).controller("hs.measure.controller",["$scope","hs.map.service","Core",function(e,t,n){function r(){var t="area"==e.type?"Polygon":"LineString";l=new ol.interaction.Draw({source:s,type:t}),i.addInteraction(l),l.on("drawstart",function(t){$("#toolbar").fadeOut(),e.multiple_shape_mode?(Array.isArray(e.sketch)||(e.sketch=[],e.measurements.push({size:0,unit:""})),e.sketch.push(t.feature)):(e.sketch=[t.feature],e.measurements.push({size:0,unit:""})),e.current_measurement=e.measurements.length-1,h=!0},this),l.on("drawend",function(e){$("#toolbar").fadeIn(),h=!1},this)}function a(){i.removeInteraction(l),e.sketch=null,r()}var i=t.map,s=new ol.source.Vector({}),o=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ffcc33",width:2})}),u=new ol.layer.Vector({source:s,style:o}),m=function(t){if(e.sketch){for(var n,r=0;r<e.sketch.length;r++){var a=e.sketch[r].getGeometry();a instanceof ol.geom.Polygon?n=c(f(a),n):a instanceof ol.geom.LineString&&(n=c(d(a),n))}e.measurements[e.current_measurement]=n,e.$$phase||e.$digest()}},c=function(e,t){if(void 0==t)return e;var n=e.unit,r=e.type;if(e.unit==t.unit){s=Math.round(100*(e.size+t.size))/100;"m"==n&&"length"==r&&s>1e3?(s=Math.round(s/1e3*100)/100,n="km"):"m"==n&&"area"==r&&s>1e4&&(s=Math.round(s/1e6*100)/100,n="km")}else{for(var a=[e,t],i=0;i<a.length;i++)"m"==a[i].unit&&(a[i].size/="length"==r?1e3:1e6);var s=Math.round(100*(a[0].size+a[1].size))/100;n="km"}return{size:s,type:r,unit:n}};e.multiple_shape_mode=!1,$(document).keyup(function(t){17==t.which&&(1==e.multiple_shape_mode&&a(),e.multiple_shape_mode=!e.multiple_shape_mode,e.$digest())});var l,h,p=new ol.Sphere(6378137),d=function(e){for(var n=0,r=e.getCoordinates(),a=t.map.getView().getProjection(),i=0,s=r.length-1;i<s;++i){var o=ol.proj.transform(r[i],a,"EPSG:4326"),u=ol.proj.transform(r[i+1],a,"EPSG:4326");n+=p.haversineDistance(o,u)}var m={size:n,type:"length",unit:"m"};return n>100?(m.size=Math.round(n/1e3*100)/100,m.unit="km"):(m.size=Math.round(100*n)/100,m.unit="m"),m},f=function(e){var n=t.map.getView().getProjection(),r=e.clone().transform(n,"EPSG:4326").getLinearRing(0).getCoordinates();area=Math.abs(p.geodesicArea(r));var a={size:area,type:"area",unit:"m"};return area>1e4?(a.size=Math.round(area/1e6*100)/100,a.unit="km"):(a.size=Math.round(100*area)/100,a.unit="m"),a};e.measurements=[],e.current_measurement={},e.type="distance",e.setType=function(t){e.type=t,e.$$phase||e.$digest()},e.clearAll=function(){h&&l.finishDrawing(),e.measurements=[],s.clear(),e.sketch=null,e.$$phase||e.$digest()},e.setFeatureStyle=function(e){o=e,u.setStyle(e)},e.$watch("type",function(){"measure"==n.mainpanel&&a()}),e.activateMeasuring=function(){i.addLayer(u),$(i.getViewport()).on("mousemove",m),r()},e.deactivateMeasuring=function(){$(i.getViewport()).off("mousemove"),i.removeInteraction(l),i.removeLayer(u)},e.$on("core.mainpanel_changed",function(t){"measure"==n.mainpanel?e.activateMeasuring():e.deactivateMeasuring()}),"measure"==n.mainpanel&&(n.current_panel_queryable=!1,e.activateMeasuring()),e.$emit("scope_loaded","Measure")}])});