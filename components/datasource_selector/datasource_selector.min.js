define(["angular","ol","map"],function(angular,ol){angular.module("hs.datasource_selector",["hs.map","hs.ows.wms","hs.ows.nonwms"]).directive("hs.datasourceSelector.directive",function(){return{templateUrl:hsl_path+"components/datasource_selector/partials/datasource_selector.html?bust="+gitsha}}).directive("hs.datasourceSelector.metadataDialogDirective",function(){return{templateUrl:hsl_path+"components/datasource_selector/partials/dialog_metadata.html?bust="+gitsha,link:function(e,t,a){$("#datasource_selector-metadata-dialog").modal("show")}}}).directive("hs.datasourceSelector.advancedMickaDialogDirective",function(){return{templateUrl:hsl_path+"components/datasource_selector/partials/dialog_micka_advanced.html?bust="+gitsha,link:function(e,t,a){$("#ds-advanced-micka").modal("show")}}}).directive("hs.datasourceSelector.suggestionsDialogDirective",function(){return{templateUrl:hsl_path+"components/datasource_selector/partials/dialog_micka_suggestions.html?bust="+gitsha,link:function(e,t,a){$("#ds-suggestions-micka").modal("show"),e.suggestion_filter=e.query[e.suggestion_config.input],$("#ds-sug-filter").focus(),e.suggestionFilterChanged()}}}).directive("hs.datasourceSelector.objectDirective",["$compile",function(e){return{templateUrl:hsl_path+"components/datasource_selector/partials/object.html?bust="+gitsha,compile:function(t){var a,s=t.contents().remove();return function(t,i){t.isIteratable=function(e){return"object"==typeof e},null==t.value?t.obj="-":t.obj=t.value,angular.isUndefined(a)&&(a=e(s)),a(t,function(e){i.append(e)})}}}}]).controller("hs.datasource_selector.controller",["$scope","hs.map.service","Core","$compile","config","hs.utils.service","hs.ows.nonwms.service","$http",function(e,t,a,s,i,o,n,r){function c(t){return void 0!==e.query[t]?"type"==t&&"data"==e.query[t]?encodeURIComponent("(type='dataset' OR type='nonGeographicDataset' OR type='series' OR type='tile')"):""!=e.query[t]?encodeURIComponent(t+"='"+e.query[t]+"'"):"":"ServiceType"==t?encodeURIComponent("(ServiceType=view OR ServiceType=download OR ServiceType=WMS OR ServiceType=WFS OR Format like '*KML*' OR Format like '*GeoJSON*' OR Format like '*application/sparql-results+json*')"):""}function l(e){var a={record:e,hs_notqueryable:!0,highlighted:!1},s=e.bbox.split(" "),i=[parseFloat(s[0]),parseFloat(s[1])],o=[parseFloat(s[2]),parseFloat(s[3])],n=t.map.getView().getProjection().getExtent();if(i=ol.proj.transform(i,"EPSG:4326",t.map.getView().getProjection()),o=ol.proj.transform(o,"EPSG:4326",t.map.getView().getProjection()),isFinite(i[0])||(i[0]=n[0]),isFinite(i[1])||(i[1]=n[1]),isFinite(o[0])||(o[0]=n[2]),isFinite(o[1])||(o[1]=n[3]),!(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))){var r=[i[0],i[1],o[0],o[1]];a.geometry=ol.geom.Polygon.fromExtent(r);var c=new ol.Feature(a);e.feature=c,u.getSource().addFeatures([c])}}e.query={text_filter:"",title:"",type:"service",Subject:""},e.config=i,e.dsPaging=e.config.dsPaging||10,e.text_field="AnyText",e.panel_name="datasource_selector",e.selected_layer=null,e.filter={},e.filter.byExtent=!0,e.wms_connecting=!1,e.$on("ows.wms_connecting",function(){e.wms_connecting=!0}),e.datasetSelect=function(){e.wms_connecting=!1},r({method:"GET",url:o.proxify("http://opentransportnet.eu:8082/api/3/action/vocabulary_show?id=36c07014-c461-4f19-b4dc-a38106144e66")}).then(function(t){e.otn_keywords=[{title:"-"}],angular.forEach(t.data.result.tags,function(t){e.otn_keywords.push({title:t.name})})});var d,u=new ol.layer.Vector({title:"Datasources extents",show_in_manager:!1,source:new ol.source.Vector,style:function(e,t){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#005CB6",width:e.get("highlighted")?4:1}),fill:new ol.style.Fill({color:"rgba(0, 0, 255, 0.01)"})})]}}),g=new ol.style.Style({image:new ol.style.Icon({src:"http://ewi.mmlab.be/otn/api/info/../../js/images/marker-icon.png",offset:[0,16]}),fill:new ol.style.Fill({color:"rgba(139, 189, 214, 0.3)"}),stroke:new ol.style.Stroke({color:"#112211",width:1})});e.datasets=null,e.loadDatasets=function(t){e.datasets=t,u.getSource().clear();for(var a in e.datasets)e.datasets[a].start=0,e.loadDataset(e.datasets[a])},e.fillCodesets=function(t){for(var a in t)e.fillCodeset(e.datasets[a])},e.fillCodeset=function(t){switch(t.type){case"micka":var a=t.code_list_url;a=o.proxify(a),void 0===t.code_lists&&(t.code_lists={serviceType:[],applicationType:[],dataType:[],topicCategory:[]}),t.ajax_req_codelists=$.ajax({url:a,cache:!1,success:function(a){$("map serviceType value",a).each(function(){t.code_lists.serviceType.push({value:$(this).attr("name"),name:$(this).html()})}),$("map applicationType value",a).each(function(){t.code_lists.applicationType.push({value:$(this).attr("name"),name:$(this).html()})}),$("map applicationType value",a).each(function(){t.code_lists.applicationType.push({value:$(this).attr("name"),name:$(this).html()})}),$("map topicCategory value",a).each(function(){t.code_lists.topicCategory.push({value:$(this).attr("name"),name:$(this).html()})}),e.advancedMickaTypeChanged()}})}},e.advancedMickaTypeChanged=function(){if(void 0!==e.micka_ds&&void 0!==e.micka_ds.code_lists)switch(e.query.type){case"service":e.micka_ds.level2_types=e.micka_ds.code_lists.serviceType;break;case"application":e.micka_ds.level2_types=e.micka_ds.code_lists.applicationType}},e.openMickaAdvancedSearch=function(){if(0==$("#ds-advanced-micka").length){var t=angular.element("<div hs.datasource_selector.advanced_micka_dialog_directive></div>");$("#hs-dialog-area").append(t),s(t)(e)}else $("#ds-advanced-micka").modal("show");if(angular.isUndefined(e.micka_ds))for(var a in e.datasets)"micka"==e.datasets[a].type&&(e.micka_ds=e.datasets[a]);""!=e.query.title&&(e.query.text_filter=e.query.title)},e.suggestion_config={},e.showSuggestions=function(t,a,i){if(e.suggestion_config={input:t,param:a,field:i},0==$("#ds-suggestions-micka").length){var o=angular.element("<div hs.datasource_selector.suggestions_dialog_directive></span>");$("#hs-dialog-area").append(o),s(o)(e)}else $("#ds-suggestions-micka").modal("show"),$("#ds-sug-filter").val(e.query[t]).focus(),e.suggestionFilterChanged()},e.suggestions=[],e.suggestionFilterChanged=function(){void 0!==e.suggestion_ajax&&e.suggestion_ajax.abort();var t=e.micka_ds.url+"../util/suggest.php?&type="+e.suggestion_config.param+"&query="+e.suggestion_filter;t=o.proxify(t),e.suggestion_ajax=$.ajax({url:t,cache:!1,dataType:"json",success:function(t){e.suggestions=t.records,delete e.suggestion_ajax,e.$$phase||e.$digest()}})},e.addSuggestion=function(t){e.query[e.suggestion_config.input]=t},e.loadDataset=function(a){switch(a.type){case"micka":var s=$("#ds-advanced-micka").is(":visible"),i=ol.proj.transformExtent(t.map.getView().calculateExtent(t.map.getSize()),t.map.getView().getProjection(),"EPSG:4326"),n=e.filter.byExtent?"BBOX='"+i.join(" ")+"'":"",r=encodeURIComponent,d=angular.isUndefined(e.query.text_filter)||!s?e.query.title:e.query.text_filter,g=[""!=d?e.text_field+r(" like '*"+d+"*'"):"",r(n),c("ServiceType"),c("topicCategory"),c("Subject"),c("Denominator"),c("OrganisationName")].filter(function(e){return""!=e}).join("%20AND%20"),p=a.url+"?request=GetRecords&format=application/json&language="+a.language+"&query="+g+(void 0!==e.query.sortby&&""!=e.query.sortby?"&sortby="+e.query.sortby:"&sortby=bbox")+"&limit="+e.dsPaging+"&start="+a.start;p=o.proxify(p),void 0!==a.ajax_req&&a.ajax_req.abort(),a.ajax_req=$.ajax({url:p,cache:!1,dataType:"json",success:function(t){if(angular.forEach(a.layers,function(e){try{void 0!==e.feature&&null!=e.feature&&u.getSource().removeFeature(e.feature)}catch(e){}}),a.layers=[],a.loaded=!0,null==t)a.matched;else{a.matched=t.matched,a.next=t.next;for(var s in t.records)if(t.records[s]){var i=t.records[s];a.layers.push(i),l(i)}}e.$$phase||e.$digest()}}),e.$$phase||e.$digest()}},e.isZoomable=function(e){return angular.isDefined(e.bbox)},e.zoomTo=function(e){if(void 0!==e){var a=e.split(" "),s=[parseFloat(a[0]),parseFloat(a[1])],i=[parseFloat(a[2]),parseFloat(a[3])];if(s=ol.proj.transform(s,"EPSG:4326",t.map.getView().getProjection()),i=ol.proj.transform(i,"EPSG:4326",t.map.getView().getProjection()),!(isNaN(s[0])||isNaN(s[1])||isNaN(i[0])||isNaN(i[1]))){var o=[s[0],s[1],i[0],i[1]];t.map.getView().fit(o,t.map.getSize())}}},e.getPreviousRecords=function(t){t.start-e.dsPaging<0?(t.start=0,t.next=e.dsPaging):(t.start-=e.dsPaging,t.next=t.start+e.dsPaging),e.loadDataset(t)},e.getNextRecords=function(t){0!=t.next&&(t.start=Math.floor(t.next/e.dsPaging)*e.dsPaging,t.next+e.dsPaging>t.matched?t.next=t.matched:t.next+=e.dsPaging,e.loadDataset(t))},e.setDefaultFeatureStyle=function(e){g=e},e.showMetadata=function(t,a){e.selected_layer=a,e.selected_ds=t,e.$$phase||e.$digest(),$("#hs-dialog-area #datasource_selector-metadata-dialog").remove();var i=angular.element("<div hs.datasource_selector.metadata_dialog_directive></span>");$("#hs-dialog-area").append(i),s(i)(e)},e.layerDownload=function(e,t){return 1==e.download&&["kml","geojson","json"].indexOf(t.formats[0].toLowerCase())>-1&&t.url.length>0?t.url:"#"},e.layerRDF=function(e,t){return e.url+"?request=GetRecordById&id="+t.id+"&outputschema=http://www.w3.org/ns/dcat%23"},e.addLayerToMap=function(e,t){if("micka"==e.type)if("service"==t.trida)if("WMS"==t.serviceType||"OGC:WMS"==t.serviceType||"view"==t.serviceType){a.singleDatasources?$('.dss-tabs a[href="#OWS"]').tab("show"):a.setMainPanel("ows");s=t.link;hslayers_api.gui.Ows.setUrlAndConnect(decodeURIComponent(s),"WMS")}else if(t.link.toLowerCase().indexOf("sparql")>-1)n.add("sparql",t.link,t.title||"Layer",t.abstract,!0,"EPSG:4326");else if("WFS"==t.serviceType||"OGC:WFS"==t.serviceType||"download"==t.serviceType){a.singleDatasources?$('.dss-tabs a[href="#OWS"]').tab("show"):a.setMainPanel("ows");var s=t.link;hslayers_api.gui.Ows.setUrlAndConnect(decodeURIComponent(s),"WFS")}else if(t.formats&&["kml","geojson","json"].indexOf(t.formats[0].toLowerCase())>-1){switch(t.formats[0].toLowerCase()){case"kml":n.add("kml",t.link,t.title||"Layer",t.abstract,!0,"EPSG:4326");break;case"json":case"geojson":n.add("geojson",t.link,t.title||"Layer",t.abstract,!1,"EPSG:4326")}a.setMainPanel("layermanager")}else alert('Service type "'+t.serviceType+'" not supported.');else if("dataset"==t.trida){if(["kml","geojson","json"].indexOf(t.formats[0].toLowerCase())>-1){switch(t.formats[0].toLowerCase()){case"kml":n.add("kml",t.link,t.title||"Layer",t.abstract,!0,"EPSG:4326");break;case"json":case"geojson":n.add("geojson",t.link,t.title||"Layer",t.abstract,!1,"EPSG:4326")}a.setMainPanel("layermanager")}}else alert('Datasource type "'+t.trida+'" not supported.')},e.highlightComposition=function(e,t){void 0!==e.feature&&e.feature.set("highlighted",t)},e.clear=function(){e.query.text_filter="",e.query.title="",e.query.Subject="",e.query.keywords="",e.query.OrganisationName="",e.query.sortby=""},e.setOtnKeyword=function(t){return"-"==t&&(t=""),e.query.Subject=t,e.loadDatasets(e.datasources),!1},e.datasources=i.datasources,e.init=function(){d=t.map,t.map.on("pointermove",function(t){var a=u.getSource().getFeaturesAtCoordinate(t.coordinate),s=!1;$(u.getSource().getFeatures()).each(function(){this.get("record").highlighted&&(this.get("record").highlighted=!1,s=!0)}),a.length&&$(a).each(function(){this.get("record").highlighted||(this.get("record").highlighted=!0,s=!0)}),s&&!e.$$phase&&e.$digest()}),e.$on("map.extent_changed",function(t,a,s){"datasource_selector"==e.Core.mainpanel&&e.filter.byExtent&&e.loadDatasets(e.datasources)}),t.map.addLayer(u),angular.isUndefined(e.datasources[0].loaded)&&a.panelVisible(e.panel_name,e)&&(e.loadDatasets(e.datasources),e.fillCodesets(e.datasources)),e.$emit("scope_loaded","DatasourceSelector"),e.$on("core.mainpanel_changed",function(t){angular.isUndefined(e.datasources[0].loaded)&&a.panelVisible(e.panel_name,e)&&(e.loadDatasets(e.datasources),e.fillCodesets(e.datasources)),u.setVisible(a.panelVisible(e.panel_name,e))})},e.$on("map.loaded",e.init)}])});