define(["angular","ol","map"],function(angular,ol){angular.module("hs.datasource_selector",["hs.map","hs.ows.wms","hs.ows.nonwms"]).directive("hs.datasourceSelector.directive",function(){return{templateUrl:hsl_path+"components/datasource_selector/partials/datasource_selector.html?bust="+gitsha}}).directive("hs.datasourceSelector.metadataDialogDirective",function(){return{templateUrl:hsl_path+"components/datasource_selector/partials/dialog_metadata.html?bust="+gitsha,link:function(e,t,a){$("#datasource_selector-metadata-dialog").modal("show")}}}).directive("hs.datasourceSelector.advancedMickaDialogDirective",function(){return{templateUrl:hsl_path+"components/datasource_selector/partials/dialog_micka_advanced.html?bust="+gitsha,link:function(e,t,a){$("#ds-advanced-micka").modal("show")}}}).directive("hs.datasourceSelector.suggestionsDialogDirective",function(){return{templateUrl:hsl_path+"components/datasource_selector/partials/dialog_micka_suggestions.html?bust="+gitsha,link:function(e,t,a){$("#ds-suggestions-micka").modal("show"),e.data.suggestionFilter=e.data.query[e.data.suggestionConfig.input],$("#ds-sug-filter").focus(),e.DS.suggestionFilterChanged()}}}).directive("hs.datasourceSelector.objectDirective",["$compile",function(e){return{templateUrl:hsl_path+"components/datasource_selector/partials/object.html?bust="+gitsha,compile:function(t){var a,s=t.contents().remove();return function(t,i){t.isIteratable=function(e){return"object"==typeof e},null==t.value?t.obj="-":t.obj=t.value,angular.isUndefined(a)&&(a=e(s)),a(t,function(e){i.append(e)})}}}}]).service("hs.datasource_selector.service",["$rootScope","hs.map.service","Core","config","hs.utils.service","hs.ows.nonwms.service",function(e,t,a,s,i,o){function r(e){return void 0!==c.data.query[e]?"type"==e&&"data"==c.data.query[e]?encodeURIComponent("(type='dataset' OR type='nonGeographicDataset' OR type='series' OR type='tile')"):""!=c.data.query[e]?encodeURIComponent(e+"='"+c.data.query[e]+"'"):"":"ServiceType"==e?encodeURIComponent("(ServiceType=view OR ServiceType=download OR ServiceType=WMS OR ServiceType=WFS OR Format like '*KML*' OR Format like '*GeoJSON*' OR Format like '*application/sparql-results+json*')"):""}function n(e){var a={record:e,hs_notqueryable:!0,highlighted:!1},s=e.bbox.split(" "),i=[parseFloat(s[0]),parseFloat(s[1])],o=[parseFloat(s[2]),parseFloat(s[3])],r=t.map.getView().getProjection().getExtent();if(i=ol.proj.transform(i,"EPSG:4326",t.map.getView().getProjection()),o=ol.proj.transform(o,"EPSG:4326",t.map.getView().getProjection()),isFinite(i[0])||(i[0]=r[0]),isFinite(i[1])||(i[1]=r[1]),isFinite(o[0])||(o[0]=r[2]),isFinite(o[1])||(o[1]=r[3]),!(isNaN(i[0])||isNaN(i[1])||isNaN(o[0])||isNaN(o[1]))){var n=[i[0],i[1],o[0],o[1]];a.geometry=ol.geom.Polygon.fromExtent(n);var d=new ol.Feature(a);e.feature=d,l.getSource().addFeatures([d])}}function d(){t.map.on("pointermove",function(t){var a=l.getSource().getFeaturesAtCoordinate(t.coordinate),s=!1;$(l.getSource().getFeatures()).each(function(){this.get("record").highlighted&&(this.get("record").highlighted=!1,s=!0)}),a.length&&$(a).each(function(){this.get("record").highlighted||(this.get("record").highlighted=!0,s=!0)}),s&&!e.$$phase&&e.$digest()}),e.$on("map.extent_changed",function(e){"datasource_selector"==a.mainpanel&&"datasources"==a.mainpanel&&c.data.filterByExtent&&c.loadDatasets(c.data.datasources)}),t.map.addLayer(l),angular.isUndefined(c.data.datasources[0].loaded)&&(a.panelVisible("datasource_selector")||a.panelVisible("datasourceBrowser"))&&(c.loadDatasets(c.data.datasources),c.fillCodesets(c.data.datasources)),e.$on("core.mainpanel_changed",function(e){angular.isUndefined(c.data.datasources[0].loaded)&&(a.panelVisible("datasource_selector")||a.panelVisible("datasourceBrowser"))&&(c.loadDatasets(c.data.datasources),c.fillCodesets(c.data.datasources)),l.setVisible(a.panelVisible("datasource_selector")||a.panelVisible("datasources"))})}var c=this;this.data={},this.data.query={textFilter:"",title:"",type:"service",Subject:""},this.data.paging=s.dsPaging||10,this.data.textField="AnyText",this.data.selectedLayer=null,this.data.filterByExtent=!0,this.data.datasets=void 0,this.data.mickaDS=void 0,this.data.suggestionConfig={},this.data.suggestions=[],this.data.suggestionsLoaded=!0,this.data.datasources=s.datasources;var l=new ol.layer.Vector({title:"Datasources extents",show_in_manager:!1,source:new ol.source.Vector,style:function(e,t){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#005CB6",width:e.get("highlighted")?4:1}),fill:new ol.style.Fill({color:"rgba(0, 0, 255, 0.01)"})})]}});return this.loadDatasets=function(e){c.data.datasets=e,l.getSource().clear();for(var t in c.data.datasets)c.data.datasets[t].start=0,c.loadDataset(c.data.datasets[t])},this.loadDataset=function(e){switch(e.type){case"micka":var a=ol.proj.transformExtent(t.map.getView().calculateExtent(t.map.getSize()),t.map.getView().getProjection(),"EPSG:4326"),s=c.data.filterByExtent?"BBOX='"+a.join(" ")+"'":"",o=encodeURIComponent,d=angular.isDefined(c.data.query.textFilter)&&c.data.query.textFilter.length>0?c.data.query.textFilter:c.data.query.title,u=[""!=d?c.data.textField+o(" like '*"+d+"*'"):"",o(s),r("ServiceType"),r("topicCategory"),r("Subject"),r("Denominator"),r("OrganisationName"),r("keywords")].filter(function(e){return""!=e}).join("%20AND%20"),g=e.url+"?request=GetRecords&format=application/json&language="+e.language+"&query="+u+(void 0!==c.data.query.sortby&&""!=c.data.query.sortby?"&sortby="+c.data.query.sortby:"&sortby=bbox")+"&limit="+c.data.paging+"&start="+e.start;g=i.proxify(g),void 0!==e.ajaxReq&&e.ajaxReq.abort(),e.loaded=!1,e.ajaxReq=$.ajax({url:g,cache:!1,dataType:"json",success:function(t){if(angular.forEach(e.layers,function(e){try{void 0!==e.feature&&null!=e.feature&&l.getSource().removeFeature(e.feature)}catch(e){}}),e.layers=[],e.loaded=!0,null==t)e.matched;else{e.matched=t.matched,e.next=t.next;for(var a in t.records)if(t.records[a]){var s=t.records[a];e.layers.push(s),n(s)}}},error:function(t){e.loaded=!0}})}},this.fillCodesets=function(e){for(var t in e)c.fillCodeset(c.data.datasets[t])},this.fillCodeset=function(e){switch(e.type){case"micka":var t=e.code_list_url;t=i.proxify(t),void 0===e.code_lists&&(e.code_lists={serviceType:[],applicationType:[],dataType:[],topicCategory:[]}),e.ajax_req_codelists=$.ajax({url:t,cache:!1,success:function(t){$("map serviceType value",t).each(function(){e.code_lists.serviceType.push({value:$(this).attr("name"),name:$(this).html()})}),$("map applicationType value",t).each(function(){e.code_lists.applicationType.push({value:$(this).attr("name"),name:$(this).html()})}),$("map applicationType value",t).each(function(){e.code_lists.applicationType.push({value:$(this).attr("name"),name:$(this).html()})}),$("map topicCategory value",t).each(function(){e.code_lists.topicCategory.push({value:$(this).attr("name"),name:$(this).html()})}),c.advancedMickaTypeChanged()}})}},this.advancedMickaTypeChanged=function(){if(void 0!==c.data.mickaDS&&void 0!==c.data.mickaDS.code_lists)switch(c.data.query.type){case"service":c.data.mickaDS.level2_types=c.data.mickaDS.code_lists.serviceType;break;case"application":c.data.mickaDS.level2_types=c.data.mickaDS.code_lists.applicationType}},this.checkAdvancedMicka=function(){if(angular.isUndefined(c.data.mickaDS))for(var e in c.data.datasets)"micka"==c.data.datasets[e].type&&(c.data.mickaDS=c.data.datasets[e]);""!=c.data.query.title&&(c.data.query.textFilter=c.data.query.title)},this.changeSuggestionConfig=function(e,t,a){c.data.suggestionConfig={input:e,param:t,field:a}},this.suggestionFilterChanged=function(){void 0!==c.suggestionAjax&&c.suggestionAjax.abort();var t=c.data.mickaDS.url+"../util/suggest.php?&type="+c.data.suggestionConfig.param+"&query="+c.data.suggestionFilter;t=i.proxify(t),c.data.suggestionsLoaded=!1,c.suggestionAjax=$.ajax({url:t,cache:!1,dataType:"json",success:function(t){c.data.suggestionsLoaded=!0,c.data.suggestions=t.records,delete c.suggestionAjax,e.$$phase||e.$digest()}})},this.addSuggestion=function(e){c.data.query[c.data.suggestionConfig.input]=e},this.isZoomable=function(e){return angular.isDefined(e.bbox)},this.zoomTo=function(e){if(void 0!==e){var a=e.split(" "),s=[parseFloat(a[0]),parseFloat(a[1])],i=[parseFloat(a[2]),parseFloat(a[3])];if(s=ol.proj.transform(s,"EPSG:4326",t.map.getView().getProjection()),i=ol.proj.transform(i,"EPSG:4326",t.map.getView().getProjection()),!(isNaN(s[0])||isNaN(s[1])||isNaN(i[0])||isNaN(i[1]))){var o=[s[0],s[1],i[0],i[1]];t.map.getView().fit(o,t.map.getSize())}}},this.layerDownload=function(e,t){return 1==e.download&&["kml","geojson","json"].indexOf(t.formats[0].toLowerCase())>-1&&t.url.length>0?t.url:"#"},this.layerRDF=function(e,t){return e.url+"?request=GetRecordById&id="+t.id+"&outputschema=http://www.w3.org/ns/dcat%23"},this.addLayerToMap=function(e,t){if("micka"==e.type)if("service"==t.trida){if("WMS"==t.serviceType||"OGC:WMS"==t.serviceType||"view"==t.serviceType)return"WMS";if(t.link.toLowerCase().indexOf("sparql")>-1)o.add("sparql",t.link,t.title||"Layer",t.abstract,!0,"EPSG:4326");else{if("WFS"==t.serviceType||"OGC:WFS"==t.serviceType||"download"==t.serviceType)return"WFS";if(t.formats&&["kml","geojson","json"].indexOf(t.formats[0].toLowerCase())>-1){switch(t.formats[0].toLowerCase()){case"kml":o.add("kml",t.link,t.title||"Layer",t.abstract,!0,"EPSG:4326");break;case"json":case"geojson":o.add("geojson",t.link,t.title||"Layer",t.abstract,!1,"EPSG:4326")}return}alert('Service type "'+t.serviceType+'" not supported.')}}else if("dataset"==t.trida){if(["kml","geojson","json"].indexOf(t.formats[0].toLowerCase())>-1){switch(t.formats[0].toLowerCase()){case"kml":o.add("kml",t.link,t.title||"Layer",t.abstract,!0,"EPSG:4326");break;case"json":case"geojson":o.add("geojson",t.link,t.title||"Layer",t.abstract,!1,"EPSG:4326")}return}}else alert('Datasource type "'+t.trida+'" not supported.')},this.highlightComposition=function(e,t){void 0!==e.feature&&e.feature.set("highlighted",t)},this.clear=function(){c.data.query.textFilter="",c.data.query.title="",c.data.query.Subject="",c.data.query.keywords="",c.data.query.OrganisationName="",c.data.query.sortby=""},angular.isDefined(t.map)?d():e.$on("map.loaded",function(){d()}),c}]).controller("hs.datasource_selector.controller",["$scope","Core","$compile","hs.utils.service","$http","hs.datasource_selector.service",function(e,t,a,s,i,o){e.data=o.data,e.DS=o,e.dsPaging=e.data.paging,e.wms_connecting=!1,e.$on("ows.wms_connecting",function(){e.wms_connecting=!0}),e.datasetSelect=function(){e.wms_connecting=!1},i({method:"GET",url:s.proxify("http://opentransportnet.eu:8082/api/3/action/vocabulary_show?id=36c07014-c461-4f19-b4dc-a38106144e66")}).then(function(t){e.otn_keywords=[{title:"-"}],angular.forEach(t.data.result.tags,function(t){e.otn_keywords.push({title:t.name})})}),e.openMickaAdvancedSearch=function(){if(0==$("#ds-advanced-micka").length){var t=angular.element("<div hs.datasource_selector.advanced_micka_dialog_directive></div>");$("#hs-dialog-area").append(t),a(t)(e)}else $("#ds-advanced-micka").modal("show");o.checkAdvancedMicka()},e.showSuggestions=function(t,s,i){if(o.changeSuggestionConfig(t,s,i),0==$("#ds-suggestions-micka").length){var r=angular.element("<div hs.datasource_selector.suggestions_dialog_directive></span>");$("#hs-dialog-area").append(r),a(r)(e)}else $("#ds-suggestions-micka").modal("show"),$("#ds-sug-filter").val(e.data.query[t]).focus(),o.suggestionFilterChanged()},e.getPreviousRecords=function(t){t.start-e.data.dsPaging<0?(t.start=0,t.next=e.data.dsPaging):(t.start-=e.data.dsPaging,t.next=t.start+e.data.dsPaging),o.loadDataset(t)},e.getNextRecords=function(t){0!=t.next&&(t.start=Math.floor(t.next/e.data.dsPaging)*e.data.dsPaging,t.next+e.data.dsPaging>t.matched?t.next=t.matched:t.next+=e.data.dsPaging,o.loadDataset(t))},e.showMetadata=function(t,s){e.selected_layer=s,e.selected_ds=t,e.$$phase||e.$digest(),$("#hs-dialog-area #datasource_selector-metadata-dialog").remove();var i=angular.element("<div hs.datasource_selector.metadata_dialog_directive></span>");$("#hs-dialog-area").append(i),a(i)(e)},e.addLayerToMap=function(e,a){var s=o.addLayerToMap(e,a);if("WMS"==s){t.singleDatasources?$('.dss-tabs a[href="#OWS"]').tab("show"):t.setMainPanel("ows");i=a.link;hslayers_api.gui.Ows.setUrlAndConnect(decodeURIComponent(i),"WMS")}else if("WFS"==s){t.singleDatasources?$('.dss-tabs a[href="#OWS"]').tab("show"):t.setMainPanel("ows");var i=a.link;hslayers_api.gui.Ows.setUrlAndConnect(decodeURIComponent(i),"WFS")}else t.setMainPanel("layermanager")},e.setOtnKeyword=function(t){return"-"==t&&(t=""),e.query.Subject=t,o.loadDatasets(o.datasources),!1},e.$emit("scope_loaded","DatasourceSelector")}])});
