define(["angular","ol","map","ngcookies"],function(angular,ol){angular.module("hs.status_creator",["hs.map","hs.core","ngCookies"]).directive("hs.statusCreator.directive",function(){return{templateUrl:hsl_path+"components/status_creator/partials/dialog.html?bust="+gitsha,link:function(e,t){$("#stc-save, #stc-saveas").hide()}}}).directive("hs.statusCreator.directiveForm",function(){return{templateUrl:hsl_path+"components/status_creator/partials/form.html?bust="+gitsha,link:function(e,t){}}}).directive("hs.statusCreator.directiveSimpleform",function(){return{templateUrl:hsl_path+"components/status_creator/partials/simpleform.html?bust="+gitsha,link:function(e,t){}}}).directive("hs.statusCreator.directivePanel",function(){return{templateUrl:hsl_path+"components/status_creator/partials/panel.html?bust="+gitsha,link:function(e,t){}}}).directive("hs.statusCreator.resultDialogDirective",function(){return{templateUrl:hsl_path+"components/status_creator/partials/dialog_result.html?bust="+gitsha,link:function(e,t,s){$("#status-creator-result-dialog").modal("show")}}}).directive("hs.statusCreator.saveDialogDirective",function(){return{templateUrl:hsl_path+"components/status_creator/partials/dialog_save.html?bust="+gitsha,link:function(e,t,s){$("#status-creator-save-dialog").modal("show")}}}).directive("hs.statusCreator.focusName",function(e){return{link:function(e,t,s){e.$watch(s.focusName,function(a){!0===a&&(console.log("value=",a),t[0].focus(),e[s.focusName]=!1)})}}}).service("hs.status_creator.service",["hs.map.service","Core","hs.utils.service","$window","$cookies",function(e,t,s,a,o){var r={map2json:function(e,t){var s={};angular.forEach(t.groups,function(e){(e.r||e.w)&&(s[e.roleName]=(e.r?"r":"")+(e.w?"w":""))});var a={abstract:t.abstract,title:t.title,keywords:t.keywords,extent:t.bbox,user:{address:t.address,city:t.city,country:t.country,email:t.email,name:t.name,organization:t.organization,phone:t.phone,position:t.position,postalcode:t.postalcode,state:t.state,url:t.url},groups:s};a.scale=e.getView().getProjection().getMetersPerUnit(),a.projection=e.getView().getProjection().getCode().toLowerCase();var o=e.getView().getCenter();o&&(a.center=[o[0],o[1]]),a.units=e.getView().getProjection().getUnits(),e.maxExtent&&(a.maxExtent={},a.maxExtent.left=e.maxExtent.left,a.maxExtent.bottom=e.maxExtent.bottom,a.maxExtent.right=e.maxExtent.right,a.maxExtent.top=e.maxExtent.top);var n=e.getLayers().getArray();return a.layers=r.layers2json(n,t),a.current_base_layer=r.getCurrentBaseLayer(e),a},getCurrentBaseLayer:function(e){var t=null;return angular.forEach(e.getLayers().getArray(),function(e){(angular.isUndefined(e.get("show_in_manager"))||1==e.get("show_in_manager"))&&1==e.get("base")&&e.getVisible()&&(t={title:e.get("title")})}),t},layers2json:function(e,t){var s=[];return e.forEach(function(e){if(angular.isDefined(t))angular.forEach(t.layers,function(t){if(t.layer==e&&t.checked){var a=r.layer2json(e);a&&s.push(a)}});else{var a=r.layer2json(e);a&&s.push(a)}}),s},layer2string:function(e,t){var s=r.layer2json(e);return JSON.stringify(s,t)},serializeStyle:function(e){var t={};if(void 0!==e.getFill()&&null!=e.getFill()&&(t.fill=e.getFill().getColor()),void 0!==e.getStroke()&&null!=e.getStroke()&&(t.stroke={color:e.getStroke().getColor(),width:e.getStroke().getWidth()}),void 0!==e.getImage()&&null!=e.getImage()){var a=e.getImage(),o={};angular.isDefined(a.getFill)&&void 0!==a.getFill()&&null!=a.getFill()&&(o.fill=a.getFill().getColor()),angular.isDefined(a.getStroke)&&void 0!==a.getStroke()&&null!=a.getStroke()&&(o.stroke={color:a.getStroke().getColor(),width:a.getStroke().getWidth()}),angular.isDefined(a.getRadius)&&(o.radius=a.getRadius()),angular.isFunction(a.getSrc)&&angular.isString(a.getSrc())?o.src=s.proxify(a.getSrc()):angular.isFunction(a.getImage)&&null!=a.getImage()&&angular.isDefined(a.getImage().src)&&(o.src=a.getImage().src),a instanceof ol.style.Circle&&(o.type="circle"),a instanceof ol.style.Icon&&(o.type="icon"),t.image=o}return t},layer2json:function(e){var t={metadata:{}};if(!(!e instanceof ol.layer.Layer)){if(t.visibility=e.getVisible(),t.opacity=e.getOpacity(),t.title=e.get("title"),t.path=e.get("path"),e.getExtent()){var s=e.getExtent();t.maxExtent={left:s[0],bottom:s[3],right:s[2],top:s[1]}}if((e instanceof ol.layer.Tile||e instanceof ol.layer.Image)&&((n=e.getSource())instanceof ol.source.ImageWMS||n instanceof ol.source.TileWMS)){if(t.className="HSLayers.Layer.WMS",t.singleTile=n instanceof ol.source.ImageWMS,t.wmsMinScale=e.get("minScale"),t.wmsMaxScale=e.get("maxScale"),e.get("legends")){t.legends=[];for(var a=e.get("legends"),o=0;o<a.length;o++)t.legends.push(encodeURIComponent(a[o]))}t.maxResolution=e.getMaxResolution(),t.minResolution=e.getMinResolution(),n.getUrl&&(t.url=encodeURIComponent(n.getUrl())),n.getUrls&&(t.url=encodeURIComponent(n.getUrls()[0])),n.getProjection()&&(t.projection=n.getProjection().getCode().toLowerCase()),t.params=n.getParams(),t.ratio=n.get("ratio")||n.ratio_,t.displayInLayerSwitcher=e.get("show_in_manager"),t.metadata.styles=n.get("styles"),e.get("dimensions")&&(t.dimensions=e.get("dimensions"))}if(e instanceof ol.layer.Vector){var n=e.getSource();if(t.className="OpenLayers.Layer.Vector",angular.isDefined(e.get("definition")))t.protocol={url:encodeURIComponent(e.get("definition").url),format:e.get("definition").format};else try{t.features=r.serializeFeatures(n.getFeatures())}catch(s){}angular.isDefined(n.defOptions)&&(t.defOptions=n.defOptions),t.maxResolution=e.getMaxResolution(),t.minResolution=e.getMinResolution(),t.projection="epsg:4326",e.getStyle()instanceof ol.style.Style&&(t.style=r.serializeStyle(e.getStyle()))}return t}},serializeFeatures:function(e){return(new ol.format.GeoJSON).writeFeatures(e)},generateUuid:s.generateUuid,generateThumbnail:function(s,a){"status_creator"!=t.mainpanel&&"permalink"!=t.mainpanel||(s.attr("crossOrigin","Anonymous"),e.map.once("postcompose",function(e){document.getElementById("my_canvas_id");var t=e.context.canvas,a=document.createElement("canvas");a.style.width="256px",a.style.height="256px",a.width=256,a.height=256,a.getContext("2d").drawImage(t,t.width/2-128,t.height/2-128,256,256,0,0,256,256);try{s.attr("src",a.toDataURL("image/png")),this.thumbnail=a.toDataURL("image/jpeg",.8)}catch(e){s.attr("src",hsl_path+"components/status_creator/notAvailable.png")}s.width(256).height(256)},a),e.map.renderSync())}};return a.addEventListener("beforeunload",function(t){var s={},a=[];angular.forEach(e.map.getLayers(),function(e){e.get("saveState")&&a.push(r.layer2json(e))}),s.layers=a,o.put("hs_layers",JSON.stringify(s))}),r}]).controller("hs.status_creator.controller",["$scope","$rootScope","hs.map.service","Core","hs.status_creator.service","config","$compile","$cookies",function(e,t,s,a,o,r,n,i){return e.layers=[],e.id="",e.thumbnail=null,e.panel_name="status_creator",e.current_composition_title="",e.config=r,e.getCurrentExtent=function(){var t=s.map.getView().calculateExtent(s.map.getSize()),a=[t[0],t[1]],o=[t[2],t[3]],r=s.map.getView().getProjection().getCode();a=ol.proj.transform(a,r,"EPSG:4326"),o=ol.proj.transform(o,r,"EPSG:4326"),e.bbox=[a[0].toFixed(2),a[1].toFixed(2),o[0].toFixed(2),o[1].toFixed(2)],e.$$phase||e.$digest()},$window.addEventListener("beforeunload",function(e){var t={},a=[];angular.forEach(s.map.getLayers(),function(e){e.get("saveState")&&a.push(me.layer2json(e))}),t.layers=a,i.put("hs_layers",JSON.stringify(t))}),me}]).controller("hs.status_creator.controller",["$scope","$rootScope","hs.map.service","Core","hs.status_creator.service","config","$compile","$cookies",function(e,t,s,a,o,r,n,i){e.layers=[],e.id="",e.thumbnail=null,e.panel_name="status_creator",e.current_composition_title="",e.config=r,e.getCurrentExtent=function(){var t=s.map.getView().calculateExtent(s.map.getSize()),a=[t[0],t[1]],o=[t[2],t[3]],r=s.map.getView().getProjection().getCode();a=ol.proj.transform(a,r,"EPSG:4326"),o=ol.proj.transform(o,r,"EPSG:4326"),e.bbox=[a[0].toFixed(2),a[1].toFixed(2),o[0].toFixed(2),o[1].toFixed(2)],e.$$phase||e.$digest()},e.next=function(){if($("a[href=#author]").parent().hasClass("active")){var t="text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(o.map2json(s.map,e)));$("#stc-download").remove(),$('<a id="stc-download" class="btn btn-default" href="data:'+t+'" download="context.hsl">Download</a>').insertAfter("#stc-next"),$("#stc-download").click(function(){$("#stc-next").show(),$("#stc-download").hide(),$("#stc-save, #stc-saveas").hide(),$(".stc-tabs li:eq(0) a").tab("show"),a.setMainPanel("layermanager",!0)}),$("#stc-next").hide(),a.isAuthorized()&&$("#stc-save, #stc-saveas").show()}else $("a[href=#context]").parent().hasClass("active")?$(".stc-tabs li:eq(1) a").tab("show"):$("a[href=#access]").parent().hasClass("active")&&$(".stc-tabs li:eq(2) a").tab("show")},e.showResultDialog=function(){if(0==$("#hs-dialog-area #status-creator-result-dialog").length){var t=angular.element("<div hs.status_creator.result_dialog_directive></span>");$("#hs-dialog-area").append(t),n(t)(e)}else $("#status-creator-result-dialog").modal("show");e.$$phase||e.$digest()},e.confirmSave=function(){e.title=this.title,e.abstract=this.abstract,e.keywords=this.keywords,$.ajax({url:(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+(r.status_manager_url||"/wwwlibs/statusmanager2/index.php"),cache:!1,method:"POST",async:!1,data:JSON.stringify({project:r.project_name,title:e.title,request:"rightToSave"}),success:function(t){if(e.hasPermission=t.results.hasPermission,e.titleFree=t.results.titleFree,t.results.guessedTitle&&(e.guessedTitle=t.results.guessedTitle),e.titleFree&&e.hasPermission)e.save(!0);else{e.$$phase||e.$digest(),$("#hs-dialog-area #status-creator-save-dialog").remove();var s=angular.element("<div hs.status_creator.save_dialog_directive></span>");$("#hs-dialog-area").append(s),n(s)(e)}},error:function(){e.success=!1,e.showResultDialog()}})},e.selectNewTitle=function(){e.title=e.guessedTitle,e.changeTitle=!0},e.save=function(n){(n||""==e.id)&&(e.id=o.generateUuid()),$.ajax({url:(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+(r.status_manager_url||"/wwwlibs/statusmanager2/index.php"),cache:!1,method:"POST",dataType:"json",data:JSON.stringify({data:o.map2json(s.map,e),permanent:!0,id:e.id,project:r.project_name,thumbnail:e.thumbnail,request:"save"}),success:function(s){var o={};e.success=angular.isDefined(s.saved)&&!1!==s.saved,e.showResultDialog(),$("#stc-next").show(),$("#stc-download").hide(),$("#stc-save, #stc-saveas").hide(),$(".stc-tabs li:eq(0) a").tab("show"),a.setMainPanel("layermanager",!0),$(".composition-info").html($("<div>").html(e.title)).click(function(){$(".composition-abstract").toggle()}),$(".composition-info").append($("<div>").html(e.abstract).addClass("well composition-abstract")),o.id=e.id,o.title=e.title,o.abstract=e.abstract||"",t.$broadcast("compositions.composition_loading",o),t.$broadcast("compositions.composition_loaded",o)},error:function(){e.success=!1,e.showResultDialog()}})},e.open=function(){e.layers=[],e.getCurrentExtent(),s.map.getLayers().forEach(function(t){!angular.isUndefined(t.get("show_in_manager"))&&1!=t.get("show_in_manager")||1==t.get("base")||e.layers.push({title:t.get("title"),checked:!0,layer:t})}),e.layers.sort(function(e,t){return e.layer.get("position")-t.layer.get("position")}),e.fillGroups(),a.setMainPanel("status_creator",!0),e.loadUserDetails()},e.fillGroups=function(){e.groups=[],r.advancedForm&&$.ajax({url:(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+(r.status_manager_url||"/wwwlibs/statusmanager2/index.php"),cache:!1,method:"GET",async:!1,dataType:"json",data:{request:"getGroups"},success:function(t){t.success&&(e.groups=t.result,angular.forEach(e.groups,function(e){e.w=!1,e.r=!1}))}}),e.groups.unshift({roleTitle:"Public",roleName:"guest",w:!1,r:!1});var t=e.current_composition;angular.isDefined(e.current_composition)&&""!=t&&angular.forEach(e.groups,function(e){angular.isDefined(t.groups)&&angular.isDefined(t.groups[e.roleName])&&(e.w=t.groups[e.roleName].indexOf("w")>-1,e.r=t.groups[e.roleName].indexOf("r")>-1)})},e.loadUserDetails=function(){$.ajax({url:(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+r.status_manager_url+"?request=getuserinfo",success:e.setUserDetails})},e.setUserDetails=function(t){t&&1==t.success&&(t.userInfo&&(e.email=t.userInfo.email,e.phone=t.userInfo.phone,e.name=t.userInfo.firstName+" "+t.userInfo.lastName),t.userInfo&&t.userInfo.org&&(e.address=t.userInfo.org.street,e.country=t.userInfo.org.state,e.postalcode=t.userInfo.org.zip,e.city=t.userInfo.org.city,e.organization=t.userInfo.org.name))},e.focusTitle=function(){e.guessedTitle&&(e.title=e.guessedTitle),setTimeout(function(){$("#hs-stc-title").focus()},0)},e.$on("compositions.composition_loaded",function(t,s){angular.isUndefined(s.error)&&(s.data?(e.id=s.id,e.abstract=s.data.abstract,e.title=s.data.title,e.keywords=s.data.keywords,e.current_composition=s.data):(e.id=s.id,e.abstract=s.abstract,e.title=s.title,e.keywords=s.keywords,e.current_composition=s),e.current_composition_title=e.title)}),e.$on("core.map_reset",function(t,s){e.id=e.abstract=e.title=e.current_composition_title=e.keywords=e.current_composition="",$("#stc-next").show(),$("#stc-download").hide(),$("#stc-save, #stc-saveas").hide(),$(".stc-tabs li:eq(0) a").tab("show")}),e.$on("core.mainpanel_changed",function(t){"status_creator"==a.mainpanel&&($("#stc-next").show(),$("#stc-download").hide(),$("#stc-save, #stc-saveas").hide(),$(".stc-tabs li:eq(0) a").tab("show"),o.generateThumbnail($("#hs-stc-thumbnail"),e))}),e.$on("map.extent_changed",function(t,s,a){e.getCurrentExtent(),o.generateThumbnail($("#hs-stc-thumbnail"),e)}),e.getCurrentExtent(),e.$emit("scope_loaded","StatusCreator")}])});