define(["angular","ol","map","ngcookies"],function(angular,ol){angular.module("hs.status_creator",["hs.map","hs.core","ngCookies"]).directive("hs.statusCreator.directive",function(){return{templateUrl:hsl_path+"components/status_creator/partials/dialog.html?bust="+gitsha}}).directive("hs.statusCreator.directiveForm",function(){return{templateUrl:hsl_path+"components/status_creator/partials/form.html?bust="+gitsha}}).directive("hs.statusCreator.directiveSimpleform",function(){return{templateUrl:hsl_path+"components/status_creator/partials/simpleform.html?bust="+gitsha}}).directive("hs.statusCreator.directivePanel",function(){return{templateUrl:hsl_path+"components/status_creator/partials/panel.html?bust="+gitsha}}).directive("hs.statusCreator.resultDialogDirective",function(){return{templateUrl:hsl_path+"components/status_creator/partials/dialog_result.html?bust="+gitsha,link:function(t,e,a){$("#status-creator-result-dialog").modal("show")}}}).directive("hs.statusCreator.saveDialogDirective",function(){return{templateUrl:hsl_path+"components/status_creator/partials/dialog_save.html?bust="+gitsha,link:function(t,e,a){$("#status-creator-save-dialog").modal("show")}}}).directive("hs.statusCreator.focusName",function(t){return{link:function(t,e,a){t.$watch(a.focusName,function(s){!0===s&&(console.log("value=",s),e[0].focus(),t[a.focusName]=!1)})}}}).service("hs.status_creator.service",["hs.map.service","Core","hs.utils.service","$window","$cookies",function(t,e,a,s,o){var r={map2json:function(t,e,a,s){var o={};angular.forEach(s.groups,function(t){(t.r||t.w)&&(o[t.roleName]=(t.r?"r":"")+(t.w?"w":""))});var n={abstract:e.abstract,title:e.title,keywords:e.keywords,extent:e.bbox,user:{address:a.address,city:a.city,country:a.country,email:a.email,name:a.name,organization:a.organization,phone:a.phone,position:a.position,postalcode:a.postalcode,state:a.state},groups:o};n.scale=t.getView().getProjection().getMetersPerUnit(),n.projection=t.getView().getProjection().getCode().toLowerCase();var i=t.getView().getCenter();i&&(n.center=[i[0],i[1]]),n.units=t.getView().getProjection().getUnits(),t.maxExtent&&(n.maxExtent={},n.maxExtent.left=t.maxExtent.left,n.maxExtent.bottom=t.maxExtent.bottom,n.maxExtent.right=t.maxExtent.right,n.maxExtent.top=t.maxExtent.top);var c=t.getLayers().getArray();return n.layers=r.layers2json(c,e.layers),n.current_base_layer=r.getCurrentBaseLayer(t),n},getCurrentBaseLayer:function(t){var e=null;return angular.forEach(t.getLayers().getArray(),function(t){(angular.isUndefined(t.get("show_in_manager"))||1==t.get("show_in_manager"))&&1==t.get("base")&&t.getVisible()&&(e={title:t.get("title")})}),e},layers2json:function(t,e){var a=[];return t.forEach(function(t){if(angular.isDefined(e))angular.forEach(e,function(e){if(e.layer==t&&e.checked){var s=r.layer2json(t);s&&a.push(s)}});else{var s=r.layer2json(t);s&&a.push(s)}}),a},layer2string:function(t,e){var a=r.layer2json(t);return JSON.stringify(a,e)},serializeStyle:function(t){var e={};if(void 0!==t.getFill()&&null!=t.getFill()&&(e.fill=t.getFill().getColor()),void 0!==t.getStroke()&&null!=t.getStroke()&&(e.stroke={color:t.getStroke().getColor(),width:t.getStroke().getWidth()}),void 0!==t.getImage()&&null!=t.getImage()){var s=t.getImage(),o={};angular.isDefined(s.getFill)&&void 0!==s.getFill()&&null!=s.getFill()&&(o.fill=s.getFill().getColor()),angular.isDefined(s.getStroke)&&void 0!==s.getStroke()&&null!=s.getStroke()&&(o.stroke={color:s.getStroke().getColor(),width:s.getStroke().getWidth()}),angular.isDefined(s.getRadius)&&(o.radius=s.getRadius()),angular.isFunction(s.getSrc)&&angular.isString(s.getSrc())?o.src=a.proxify(s.getSrc()):angular.isFunction(s.getImage)&&null!=s.getImage()&&angular.isDefined(s.getImage().src)&&(o.src=s.getImage().src),s instanceof ol.style.Circle&&(o.type="circle"),s instanceof ol.style.Icon&&(o.type="icon"),e.image=o}return e},layer2json:function(t){var e={metadata:{}};if(!(!t instanceof ol.layer.Layer)){if(e.visibility=t.getVisible(),e.opacity=t.getOpacity(),e.title=t.get("title"),e.path=t.get("path"),t.getExtent()){var a=t.getExtent();e.maxExtent={left:a[0],bottom:a[3],right:a[2],top:a[1]}}if((t instanceof ol.layer.Tile||t instanceof ol.layer.Image)&&((n=t.getSource())instanceof ol.source.ImageWMS||n instanceof ol.source.TileWMS)){if(e.className="HSLayers.Layer.WMS",e.singleTile=n instanceof ol.source.ImageWMS,e.wmsMinScale=t.get("minScale"),e.wmsMaxScale=t.get("maxScale"),t.get("legends")){e.legends=[];for(var s=t.get("legends"),o=0;o<s.length;o++)e.legends.push(encodeURIComponent(s[o]))}e.maxResolution=t.getMaxResolution(),e.minResolution=t.getMinResolution(),n.getUrl&&(e.url=encodeURIComponent(n.getUrl())),n.getUrls&&(e.url=encodeURIComponent(n.getUrls()[0])),n.getProjection()&&(e.projection=n.getProjection().getCode().toLowerCase()),e.params=n.getParams(),e.ratio=n.get("ratio")||n.ratio_,e.displayInLayerSwitcher=t.get("show_in_manager"),e.metadata.styles=n.get("styles"),t.get("dimensions")&&(e.dimensions=t.get("dimensions"))}if(t instanceof ol.layer.Vector){var n=t.getSource();if(e.className="OpenLayers.Layer.Vector",angular.isDefined(t.get("definition")))e.protocol={url:encodeURIComponent(t.get("definition").url),format:t.get("definition").format};else try{e.features=r.serializeFeatures(n.getFeatures())}catch(a){}angular.isDefined(n.defOptions)&&(e.defOptions=n.defOptions),e.maxResolution=t.getMaxResolution(),e.minResolution=t.getMinResolution(),e.projection="epsg:4326",t.getStyle()instanceof ol.style.Style&&(e.style=r.serializeStyle(t.getStyle()))}return e}},serializeFeatures:function(t){return(new ol.format.GeoJSON).writeFeatures(t)},generateUuid:a.generateUuid,generateThumbnail:function(a,s){"status_creator"!=e.mainpanel&&"permalink"!=e.mainpanel&&"statusCreator"!=e.mainpanel||(a.attr("crossOrigin","Anonymous"),t.map.once("postcompose",function(t){document.getElementById("my_canvas_id");var e=t.context.canvas,s=document.createElement("canvas");s.style.width="256px",s.style.height="256px",s.width=256,s.height=256,s.getContext("2d").drawImage(e,e.width/2-128,e.height/2-128,256,256,0,0,256,256);try{a.attr("src",s.toDataURL("image/png")),this.thumbnail=s.toDataURL("image/jpeg",.8)}catch(t){a.attr("src",hsl_path+"components/status_creator/notAvailable.png")}a.width(256).height(256)},s),t.map.renderSync())}};return s.addEventListener("beforeunload",function(e){var a={},s=[];angular.forEach(t.map.getLayers(),function(t){t.get("saveState")&&s.push(r.layer2json(t))}),a.layers=s,o.put("hs_layers",JSON.stringify(a))}),r}]).service("hs.status_creator.managerService",["$rootScope","hs.map.service","Core","hs.status_creator.service","config",function(t,e,a,s,o){var r={};return r.compoData={title:"",abstract:"",keywords:[],layers:[],id:"",thumbnail:void 0,bbox:void 0,currentCompositionTitle:"",currentComposition:void 0},r.userData={email:"",phone:"",name:"",address:"",country:"",postalCode:"",city:"",organization:""},r.statusData={titleFree:void 0,hasPermission:void 0,success:void 0,changeTitle:void 0,groups:[]},r.confirmSave=function(){$.ajax({url:(o.hostname.user?o.hostname.user.url:o.hostname.status_manager?o.hostname.status_manager.url:o.hostname.default.url)+(o.status_manager_url||"/wwwlibs/statusmanager2/index.php"),cache:!1,method:"POST",async:!1,data:JSON.stringify({project:o.project_name,title:r.compoData.title,request:"rightToSave"}),success:function(e){r.statusData.hasPermission=e.results.hasPermission,r.statusData.titleFree=e.results.titleFree,e.results.guessedTitle&&(r.statusData.guessedTitle=e.results.guessedTitle),r.statusData.titleFree||(r.statusData.changeTitle=!1),r.statusData.titleFree&&r.statusData.hasPermission?r.save(!0):t.$broadcast("StatusManager.saveResult",2)},error:function(){r.statusData.success=!1,t.$broadcast("StatusManager.saveResult",3)}})},r.save=function(a){(a||""==r.compoData.id)&&(r.compoData.id=s.generateUuid()),$.ajax({url:(o.hostname.user?o.hostname.user.url:o.hostname.status_manager?o.hostname.status_manager.url:o.hostname.default.url)+(o.status_manager_url||"/wwwlibs/statusmanager2/index.php"),cache:!1,method:"POST",dataType:"json",data:JSON.stringify({data:s.map2json(e.map,r.compoData,r.userData,r.statusData),permanent:!0,id:r.compoData.id,project:o.project_name,thumbnail:r.compoData.thumbnail,request:"save"}),success:function(e){var a={};r.statusData.success=angular.isDefined(e.saved)&&!1!==e.saved,a.id=r.compoData.id,a.title=r.compoData.title,a.abstract=r.compoData.abstract||"",t.$broadcast("compositions.composition_loading",a),t.$broadcast("compositions.composition_loaded",a),t.$broadcast("StatusManager.saveResult",1)},error:function(){r.statusData.success=!1,t.$broadcast("StatusManager.saveResult",3)}})},r.open=function(){a.setMainPanel("status_creator",!0),r.refresh()},r.refresh=function(){r.compoData.layers=[],r.compoData.bbox=r.getCurrentExtent(),e.map.getLayers().forEach(function(t){!angular.isUndefined(t.get("show_in_manager"))&&1!=t.get("show_in_manager")||1==t.get("base")||r.compoData.layers.push({title:t.get("title"),checked:!0,layer:t})}),r.compoData.layers.sort(function(t,e){return t.layer.get("position")-e.layer.get("position")}),r.fillGroups(),r.loadUserDetails()},r.fillGroups=function(){r.statusData.groups=[],o.advancedForm&&$.ajax({url:(o.hostname.user?o.hostname.user.url:o.hostname.status_manager?o.hostname.status_manager.url:o.hostname.default.url)+(o.status_manager_url||"/wwwlibs/statusmanager2/index.php"),cache:!1,method:"GET",async:!1,dataType:"json",data:{request:"getGroups"},success:function(t){t.success&&(r.statusData.groups=t.result,angular.forEach(r.statusData.groups,function(t){t.w=!1,t.r=!1}))}}),r.statusData.groups.unshift({roleTitle:"Public",roleName:"guest",w:!1,r:!1});var t=r.compoData.currentComposition;angular.isDefined(r.compoData.currentComposition)&&""!=t&&angular.forEach(r.statusData.groups,function(e){angular.isDefined(t.groups)&&angular.isDefined(t.groups[e.roleName])&&(e.w=t.groups[e.roleName].indexOf("w")>-1,e.r=t.groups[e.roleName].indexOf("r")>-1)})},r.loadUserDetails=function(){$.ajax({url:(o.hostname.user?o.hostname.user.url:o.hostname.status_manager?o.hostname.status_manager.url:o.hostname.default.url)+o.status_manager_url+"?request=getuserinfo",success:r.setUserDetails})},r.setUserDetails=function(t){t&&1==t.success&&(t.userInfo&&(r.userData.email=t.userInfo.email,r.userData.phone=t.userInfo.phone,r.userData.name=t.userInfo.firstName+" "+t.userInfo.lastName),t.userInfo&&t.userInfo.org&&(r.userData.address=t.userInfo.org.street,r.userData.country=t.userInfo.org.state,r.userData.postalcode=t.userInfo.org.zip,r.userData.city=t.userInfo.org.city,r.userData.organization=t.userInfo.org.name))},r.getCurrentExtent=function(){var t=e.map.getView().calculateExtent(e.map.getSize()),a=[t[0],t[1]],s=[t[2],t[3]],o=e.map.getView().getProjection().getCode();return a=ol.proj.transform(a,o,"EPSG:4326"),s=ol.proj.transform(s,o,"EPSG:4326"),[a[0].toFixed(2),a[1].toFixed(2),s[0].toFixed(2),s[1].toFixed(2)]},t.$on("StatusCreator.open",function(t){r.open()}),t.$on("compositions.composition_loaded",function(t,e){angular.isUndefined(e.error)&&(e.data?(r.compoData.id=e.id,r.compoData.abstract=e.data.abstract,r.compoData.title=e.data.title,r.compoData.keywords=e.data.keywords,r.compoData.currentComposition=e.data):(r.compoData.id=e.id,r.compoData.abstract=e.abstract,r.compoData.title=e.title,r.compoData.keywords=e.keywords,r.compoData.currentComposition=e),r.compoData.currentCompositionTitle=r.compoData.title)}),r.resetCompoData=function(){r.compoData.id=r.compoData.abstract=r.compoData.title=r.compoData.currentCompositionTitle=r.compoData.keywords=r.compoData.currentComposition=""},t.$on("core.map_reset",function(t,e){r.resetCompoData()}),t.$on("core.mainpanel_changed",function(t){"status_creator"!=a.mainpanel&&"statusCreator"!=a.mainpanel||(r.refresh(),s.generateThumbnail($("#hs-stc-thumbnail"),r.compoData))}),t.$on("map.extent_changed",function(t){r.compoData.bbox=r.getCurrentExtent(),s.generateThumbnail($("#hs-stc-thumbnail"),r.compoData)}),r}]).controller("hs.status_creator.controller",["$scope","hs.map.service","Core","hs.status_creator.service","config","$compile","hs.status_creator.managerService",function(t,e,a,s,o,r,n){t.compoData=n.compoData,t.statusData=n.statusData,t.userData=n.userData,t.panel_name="status_creator",t.config=o,t.next=function(){if($("a[href=#author]").parent().hasClass("active")){var o="text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s.map2json(e.map,t.compoData,t.userData,t.statusData)));$("#stc-download").remove(),$('<a id="stc-download" class="btn btn-default" href="data:'+o+'" download="context.hsl">Download</a>').insertAfter("#stc-next"),$("#stc-download").click(function(){$("#stc-next").show(),$("#stc-download").hide(),$("#stc-save, #stc-saveas").hide(),$(".stc-tabs li:eq(0) a").tab("show"),a.setMainPanel("layermanager",!0)}),$("#stc-next").hide(),a.isAuthorized()&&$("#stc-save, #stc-saveas").show()}else $("a[href=#context]").parent().hasClass("active")?$(".stc-tabs li:eq(1) a").tab("show"):$("a[href=#access]").parent().hasClass("active")&&$(".stc-tabs li:eq(2) a").tab("show")},t.showResultDialog=function(){if(0==$("#hs-dialog-area #status-creator-result-dialog").length){var e=angular.element("<div hs.status_creator.result_dialog_directive></span>");$("#hs-dialog-area").append(e),r(e)(t)}else $("#status-creator-result-dialog").modal("show");t.$$phase||t.$digest()},t.showSaveDialog=function(){$("#hs-dialog-area #status-creator-save-dialog").remove();var e=angular.element("<div hs.status_creator.save_dialog_directive></span>");$("#hs-dialog-area").append(e),r(e)(t),t.$$phase||t.$digest()},t.confirmSave=function(){n.confirmSave()},t.save=function(t){n.save(t)},t.$on("StatusManager.saveResult",function(e,s){1===s?(t.showResultDialog(),$("#stc-next").show(),$("#stc-download").hide(),$("#stc-save, #stc-saveas").hide(),$(".stc-tabs li:eq(0) a").tab("show"),a.setMainPanel("layermanager",!0),$(".composition-info").html($("<div>").html(t.title)).click(function(){$(".composition-abstract").toggle()}),$(".composition-info").append($("<div>").html(t.abstract).addClass("well composition-abstract"))):2===s?t.showSaveDialog():3===s&&t.showResultDialog()}),t.selectNewTitle=function(){t.compoData.title=t.statusData.guessedTitle,t.changeTitle=!0},t.focusTitle=function(){t.statusData.guessedTitle&&(t.compoData.title=t.statusData.guessedTitle),setTimeout(function(){$("#hs-stc-title").focus()},0)},t.getCurrentExtent=function(){t.compoData.bbox=n.getCurrentExtent()},t.$on("core.map_reset",function(t,e){$("#stc-next").show(),$("#stc-download").hide(),$("#stc-save, #stc-saveas").hide(),$(".stc-tabs li:eq(0) a").tab("show")}),t.$on("core.mainpanel_changed",function(t){"status_creator"==a.mainpanel&&($("#stc-next").show(),$("#stc-download").hide(),$("#stc-save, #stc-saveas").hide(),$(".stc-tabs li:eq(0) a").tab("show"))}),t.$emit("scope_loaded","StatusCreator")}])});