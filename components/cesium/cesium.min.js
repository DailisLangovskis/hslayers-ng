require.config({paths:{hs_cesium_camera:hsl_path+"components/cesium/camera"+hslMin}}),define(["angular","cesiumjs","permalink","ol","hs_cesium_camera"],function(angular,e,i,ol,t){angular.module("hs.cesium",["hs"]).service("hs.cesium.service",["config","$rootScope","hs.utils.service","hs.map.service","hs.layermanager.service",function(i,r,n,o,a){function s(e){var i=new ol.format.GeoJSON,t=e.getFeatures();t.forEach(function(i){void 0!==e.cesium_layer.entities.getById(i.getId())&&t.splice(t.indexOf(i),1)});var r=[];for(e.cesium_layer.entities.values.forEach(function(i){null==e.getFeatureById(i.id)&&r.push(i.id)});r.length>0;){var n=r.pop();e.cesium_layer.entities.removeById(n)}return i.writeFeaturesObject(t)}function c(e,i){e.cesium_layer=i,e.on("change:visible",function(i){i.target.cesium_layer.show=e.getVisible()}),e.on("change:opacity",function(i){i.target.cesium_layer.alpha=parseFloat(e.getOpacity())})}function u(e,i){e.cesium_layer=i,l(e),e.on("features:loaded",function(e){e.target.cesium_layer&&l(e.target)})}function l(i){new e.GeoJsonDataSource("tmp").load(s(i),{camera:p.scene.camera,canvas:p.scene.canvas,clampToGround:!0}).then(function(e){e.entities.values.forEach(function(e){try{void 0===i.cesium_layer.entities.getById(e.id)&&i.cesium_layer.entities.add(e)}catch(e){console&&console.error(e.toString())}}),i.cesiumStyler(i.cesium_layer)})}function m(i){if(i instanceof ol.layer.Group)angular.forEach(i.layers,function(e){m(e)});else{i.setVisible(o.isLayerVisible(i,o.visible_layers)||i.getVisible()),i.manuallyAdded=!1,i.getSource()instanceof ol.source.ImageWMS&&o.proxifyLayerLoader(i,!1),i.getSource()instanceof ol.source.TileWMS&&o.proxifyLayerLoader(i,!0);var t=d.convertOlToCesiumProvider(i);angular.isDefined(t)&&(t instanceof e.ImageryLayer?(c(i,t),d.viewer.imageryLayers.add(t)):(d.viewer.dataSources.add(t),u(i.getSource(),t)))}}var p;this.init=function(){void 0===e&&console.error("Please include cesium in shim definition: cesiumjs: {exports: 'Cesium'}"),window.CESIUM_BASE_URL=hsl_path+"node_modules/cesium/Build/Cesium";var n=new e.CesiumTerrainProvider({url:i.terrain_provider||"https://assets.agi.com/stk-terrain/v1/tilesets/world/tiles"}),s=o.map.getView(),c=s.calculateExtent(o.map.getSize()),u=ol.proj.transformExtent(c,s.getProjection(),"EPSG:4326"),l=e.Rectangle.fromDegrees(u[0],u[1],u[2],u[3]);e.Camera.DEFAULT_VIEW_FACTOR=0,e.Camera.DEFAULT_VIEW_RECTANGLE=l,e.BingMapsApi.defaultKey="Ak5NFHBx3tuU85MOX4Lo-d2JP0W8amS1IHVveZm4TIY9fmINbSycLR8rVX9yZG82";new e.BingMapsImageryProvider({url:"https://dev.virtualearth.net",key:"get-yours-at-https://www.bingmapsportal.com/",mapStyle:e.BingMapsStyle.AERIAL});(p=new e.Viewer("cesiumContainer",{timeline:!1,animation:!1,infoBox:void 0===i.cesiumInfoBox||i.cesiumInfoBox,terrainProvider:n,terrainExaggeration:i.terrainExaggeration||1,skyBox:new e.SkyBox({sources:{positiveX:hsl_path+"node_modules/cesium/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_px.jpg",negativeX:hsl_path+"node_modules/cesium/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_mx.jpg",positiveY:hsl_path+"node_modules/cesium/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_py.jpg",negativeY:hsl_path+"node_modules/cesium/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_my.jpg",positiveZ:hsl_path+"node_modules/cesium/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_pz.jpg",negativeZ:hsl_path+"node_modules/cesium/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_mz.jpg"}}),sceneMode:e.SceneMode.SCENE3D,mapProjection:new e.WebMercatorProjection,shadows:!1})).scene.debugShowFramesPerSecond=!0,p.terrainProvider=n,d.viewer=p,t.init(p,o),setTimeout(function(){d.repopulateLayers(null)},3500),p.camera.moveEnd.addEventListener(function(e){if(!o.visible){var i=t.getCameraCenterInLngLat();if(null==i)return;var n=t.getViewportPolygon();r.$broadcast("map.sync_center",i,n)}}),angular.forEach(i.terrain_providers,function(e){e.type="terrain",a.data.terrainlayers.push(e)}),o.map.getLayers().on("add",function(e){m(e.element)}),r.$on("map.extent_changed",function(e,i,r){var n=o.map.getView();o.visible&&t.setExtentEqualToOlExtent(n)}),r.$on("search.zoom_to_center",function(i,t){p.camera.setView({destination:e.Cartesian3.fromDegrees(t.coordinate[0],t.coordinate[1],15e3)})}),r.$on("layermanager.base_layer_visible_changed",function(i,t,r){angular.isDefined(t.type)&&"terrain"==t.type&&(p.terrainProvider=new e.CesiumTerrainProvider({url:t.url}))});var g=new e.ScreenSpaceEventHandler(p.scene.canvas);g.setInputAction(function(i){var t=p.camera.getPickRay(i.position),r=p.scene.pick(i.position),n=p.imageryLayers.pickImageryLayerFeatures(t,p.scene);r&&r.id&&r.id.onclick?r.id.onclick(r.id):e.defined(n)?e.when(n,function(e){var i="";if(e.length>0)for(var t=0;t<e.length;t++)i=i+e[t].data+"\n";var r=$(".cesium-infoBox-iframe");setTimeout(function(){$(".cesium-infoBox-description",r.contents()).html(i.replaceAll("\n","<br/>")),r.height(200)},1e3)}):console&&console.log("No features picked.")},e.ScreenSpaceEventType.LEFT_DOWN),g.setInputAction(function(i){p.camera.getPickRay(i.position);var t=p.scene.pick(i.position);if(p.scene.pickPositionSupported&&p.scene.mode===e.SceneMode.SCENE3D){var n=p.scene.pickPosition(i.position);if(e.defined(n)){var o=e.Cartographic.fromCartesian(n),a=e.Math.toDegrees(o.longitude),s=e.Math.toDegrees(o.latitude);r.$emit("cesium_position_clicked",[a,s])}}t&&t.id&&t.id.onclick&&t.id.onRightClick(t.id)},e.ScreenSpaceEventType.RIGHT_DOWN),r.$broadcast("cesiummap.loaded",p)},this.repopulateLayers=function(e){angular.isDefined(i.default_layers)&&angular.forEach(i.default_layers,m),angular.isDefined(i.box_layers)&&angular.forEach(i.box_layers,m),angular.forEach(o.map.getLayers(),function(e){angular.isUndefined(e.cesium_layer)&&m(e)})},this.convertOlToCesiumProvider=function(i){function t(e){this.proxy=e}if(t.prototype.getURL=function(e){var i=this.proxy+window.location.protocol+"//"+window.location.hostname+window.location.pathname+hsl_path+"img/blank.png",t=-1===this.proxy.indexOf("?")?"?":"";if(e.indexOf("bbox=0%2C0%2C45")>-1||e.indexOf("bbox=0, 45")>-1)return i;var r=n.getParamsFromUrl(e).bbox.split(",");return Math.sqrt(Math.pow(r[0]-r[2],2)+Math.pow(r[1]-r[3],2))>1?i:(e=e.replaceAll("fromcrs","FROMCRS")).indexOf("proxy4ows")>-1?e:this.proxy+t+encodeURIComponent(e)},i.getSource()instanceof ol.source.OSM)return new e.ImageryLayer(e.createOpenStreetMapImageryProvider(),{show:i.getVisible(),minimumTerrainLevel:i.minimumTerrainLevel||15});if(i.getSource()instanceof ol.source.TileWMS){var r=i.getSource(),o=r.getParams();return o.VERSION="1.1.1",o.CRS="EPSG:4326",o.FROMCRS="EPSG:4326",new e.ImageryLayer(new e.WebMapServiceImageryProvider({url:r.getUrls()[0],layers:r.getParams().LAYERS,getFeatureInfoFormats:[new e.GetFeatureInfoFormat("text","text/plain")],enablePickFeatures:!0,parameters:o,getFeatureInfoParameters:{VERSION:"1.1.1",CRS:"EPSG:4326",FROMCRS:"EPSG:4326"},minimumTerrainLevel:o.minimumTerrainLevel||12,proxy:new t("/cgi-bin/hsproxy.cgi?url=")}),{alpha:.7,show:i.getVisible()})}if(i.getSource()instanceof ol.source.Vector){if(i.getSource().getFormat()instanceof ol.format.KML)return e.KmlDataSource.load(i.getSource().getUrl(),{camera:p.scene.camera,canvas:p.scene.canvas,clampToGround:i.getSource().get("clampToGround")||!0});var a=new e.GeoJsonDataSource(i.get("title"));return i.cesium_layer=a,i.on("change:visible",function(e){e.target.cesium_layer.show=i.getVisible()}),a}console&&console.error("Unsupported layer type for layer: ",i,"in Cesium converter")},this.getCameraCenterInLngLat=t.getCameraCenterInLngLat;var d=this}]).directive("hs.cesium.directive",["Core",function(e){return{templateUrl:hsl_path+"components/cesium/partials/cesium.html?bust="+gitsha,link:function(e,i){}}}]).directive("hs.cesium.toolbarButtonDirective",function(){return{templateUrl:hsl_path+"components/cesium/partials/toolbar_button_directive.html?bust="+gitsha}}).controller("hs.cesium.controller",["$scope","hs.cesium.service","config","hs.permalink.service_url","Core","hs.map.service","hs.sidebar.service","$timeout",function(e,i,t,r,n,o,a,s){i.map;e.init=function(){i.init()},setTimeout(function(){o.visible=!1},0),a.extra_buttons.push({title:"3D/2D",icon_class:"glyphicon glyphicon-globe",click:function(){o.visible=!o.visible,o.visible&&s(function(){n.updateMapSize()},0)}}),e.init(),e.$emit("scope_loaded","CesiumMap")}])});