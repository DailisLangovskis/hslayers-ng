define(["angular","ol","s4a","dc","map","core"],function(angular,ol,e){angular.module("hs.tracking",["hs.map","hs.core"]).directive("hs.tracking.directive",function(){return{templateUrl:hsl_path+"components/tracking/partials/tracking.html?bust="+gitsha}}).controller("hs.tracking.controller",["$scope","hs.map.service","Core",function(t,a,n){var i=e.data.SensLog,r=a.map,o=new ol.source.Vector,s=null;t.isTracking=!1,t.observations=[];var c,l=new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#ff0000",width:3}),image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:"#ff0000"})})}),g=new ol.layer.Vector({source:o,style:l}),p=function(e){var t=new ol.Feature({geometry:new ol.geom.Point(e),labelPoint:new ol.geom.Point(e),name:"Most recent track"});o.addFeature(t)},u=function(){i.getLastPosition(3,"sdi4apps").then(function(e){var a=i.toJsDate(e.time_stamp);if(null===s||a.getTime()>s.getTime()){p([e.x,e.y]),r.getView().setCenter([e.x,e.y]),s=new Date(a.getTime());var n=i.getLastObservation(3,21,"sdi4apps"),o=i.getLastObservation(3,22,"sdi4apps"),c=i.getLastObservation(3,23,"sdi4apps");jQuery.when(n,o,c).done(function(e,a,n){t.observations.length>=10&&t.observations.shift(),t.observations.push({time:i.toJsDate(e.time),temperature:e.value,percipitation:a.value,speed:n.value}),t.$$phase||t.$digest()})}})};t.startTracking=function(){t.isTracking=!0,u(),t.$$phase||t.$digest(),c=setInterval(function(){u(),t.$$phase||t.$digest()},5e3)},t.stopTracking=function(){t.isTracking=!1,clearInterval(c),t.clearAll(),t.$$phase||t.$digest()},t.clearAll=function(){o.clear(),t.observations.length=0},t.activate=function(){r.addLayer(g)},t.deactivate=function(){r.removeLayer(g)},t.$on("core.mainpanel_changed",function(e){"tracking"===n.mainpanel?t.activate():t.deactivate()}),t.$on("scope_loaded",function(e,a){"tracking"===n.mainpanel&&"tracking"===a?t.activate():t.deactivate()}),t.$emit("scope_loaded","tracking")}])});