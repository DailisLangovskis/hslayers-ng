define(["ol","dc","map","query","core","drag"],function(ol,e){angular.module("hs.lodexplorer",["hs.drag","hs.map","hs.query","hs.core"]).directive("hs.lodexplorer.directive",function(){return{templateUrl:hsl_path+"components/lodexplorer/partials/lodexplorer.html?bust="+gitsha,link:function(e,t){}}}).service("hs.lodexplorer.service_sparqllog",[function(){return{logs:[]}}]).directive("hs.lodexplorer.directiveSparqllogdialog",function(){return{templateUrl:hsl_path+"components/lodexplorer/partials/sparqllogdialog.html?bust="+gitsha}}).controller("hs.lodexplorer.controller_sparqllogdialog",["$scope","hs.lodexplorer.service_sparqllog",function(e,t){e.sparql_log=t.logs}]).controller("hs.lodexplorer.controller",["$scope","hs.map.service","hs.lodexplorer.service_sparqllog","Core",function(t,r,a,o){var n=null,l=r.map,s=e.barChart("#dc-magnitude-chart","filtered"),i=e.barChart("#dc-magnitude-chart2","filter"),u={};t.ajax_loader=hsl_path+"components/lodexplorer/ajax-loader.gif",t.loading=!1,t.sparql_log=[],t.sources=[{url:"http://eurostat.linked-statistics.org/data/nama_r_e2gdp.rdf",name:"Gross domestic product (GDP) at current market prices by NUTS 2 regions"},{url:"http://eurostat.linked-statistics.org/data/demo_r_frate2.rdf",name:"Fertility rates by age - NUTS 2 regions"},{url:"http://eurostat.linked-statistics.org/data/hlth_rs_prsrg.rdf",name:"Health personnel by NUTS 2 regions"},{url:"http://eurostat.linked-statistics.org/data/ef_kvftreg.rdf",name:"Key variables: area, livestock (LSU), labour force and standard output (SO) by type of farming (2-digit)"}],t.setSources=function(e){t.sources=e,t.$$phase||t.$digest()},t.groupings=[],t.styleFunction=function(e,r){return Number.MIN_VALUE!=e.gradient_value?[new ol.style.Style({fill:new ol.style.Fill({color:t.rainbow(1,e.gradient_value,e.opacity?e.opacity:0)}),stroke:new ol.style.Stroke({color:"rgba(100, 100, 100, 0.3)"})})]:[new ol.style.Style({fill:new ol.style.Fill({color:[187,187,187,.9]}),stroke:new ol.style.Stroke({color:"rgba(100, 100, 100, 0.3)"})})]},t.rainbow=function(e,t,r){var a,o,n,l=t/(1.00000001*e),s=~~(4*l),i=4*l-s,u=1-i;switch(s%4){case 2:a=i,o=1,n=0;break;case 0:a=0,o=i,n=1;break;case 3:a=1,o=u,n=0;break;case 1:a=0,o=1,n=u}return"rgba("+~~(235*a)+","+~~(235*o)+","+~~(235*n)+", "+r+")"},t.chooseSource=function(e){var r=["SELECT DISTINCT ?classif","FROM <"+e+">","WHERE {","?s a <http://purl.org/linked-data/cube#Observation>;","    ?property ?classif .","FILTER(isIri(?classif) and ?property != <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> ","    and ?property != <http://purl.org/linked-data/cube#dataSet> ",")","}"].join("\n");console&&console.log(r);var a="http://data.plan4all.eu/sparql?default-graph-uri=&query="+window.escape(r)+"&format=application%2Fsparql-results%2Bjson&timeout=2000&debug=off";t.loading=!0,$.ajax({url:a,success:c})};var d="",c=function(e){t.classifs_loaded=!0;var r={};d="";for(var a=0;a<e.results.bindings.length;a++){var o=e.results.bindings[a].classif.value.split("#")[0];r[o]||(r[o]=o,d+="FROM <"+o+".rdf>\n")}var n=["SELECT ?property, ?value","FROM <"+t.source+">","WHERE {","{ SELECT ?s WHERE {?s a <http://purl.org/linked-data/cube#Observation>} LIMIT 1}.","?s ?property ?value .","FILTER(?property NOT IN ( <http://www.w3.org/1999/02/22-rdf-syntax-ns#type>, <http://purl.org/linked-data/cube#dataSet>, <http://eurostat.linked-statistics.org/property#geo>, <http://purl.org/linked-data/sdmx/2009/measure#obsValue>))","}"].join("\n");console&&console.log(n);var l="http://data.plan4all.eu/sparql?default-graph-uri=&query="+window.escape(n)+"&format=application%2Fsparql-results%2Bjson&timeout=2000&debug=off";$.ajax({url:l,success:p})},p=function(e){for(var r=e.results.bindings,a={},o=0;o<r.length;o++){var n=r[o].property.value.split("#")[1];a[n]||(a[n]={name:n,property:r[o].property.value,datatype:r[o].value.datatype?r[o].value.datatype:"url"})}t.groupings=a,t.loading=!1,t.$$phase||t.$digest(),g()},g=function(e){var r="";t.loading=!0;var o="",n="";angular.forEach(t.groupings,function(e,t){var a="";if(e.value){switch(e.datatype){case"http://www.w3.org/2001/XMLSchema#date":a="xsd:dateTime('"+e.value+"')";break;default:a="<"+e.value+">"}r+=" ?measurement <"+e.property+"> ?filter"+e.name+". FILTER(?filter"+e.name+" = "+a+" ).\n"}switch(e.datatype){case"http://www.w3.org/2001/XMLSchema#date":o+="OPTIONAL{?measurement <"+e.property+"> ?"+e.name+"}. \n",n+=", ?"+e.name;break;default:o+="OPTIONAL{?measurement <"+e.property+"> ?m_"+e.name+". ?m_"+e.name+" skos:prefLabel ?"+e.name+"}. \n",n+=", str(?"+e.name+") as ?"+e.name}});var l=["PREFIX property: <http://eurostat.linked-statistics.org/property#>","PREFIX measure: <http://purl.org/linked-data/sdmx/2009/measure#>","SELECT DISTINCT str(?code) as ?code, (xsd:decimal(?value) as ?value)"+n,"FROM <"+t.source+">","FROM <http://www.w3.org/2004/02/skos/core>","FROM <http://eurostat.linked-statistics.org/dic/unit>","FROM <http://data.plan4all.eu/nuts_supported.rdf>",d,"WHERE {","?measurement a <http://purl.org/linked-data/cube#Observation>;","measure:obsValue ?value;","property:geo ?location.","?location <http://data.plan4all.eu/nuts_supported.rdf#supported> true.",o,"?location skos:notation ?code.",r,"}"].join("\n");console&&console.log(l);var s=new Date;a.logs.unshift({date:s.toLocaleString(),query:l,date_val:s.valueOf()});var i="http://data.plan4all.eu/sparql?default-graph-uri=&query="+window.escape(l)+"&format=application%2Fsparql-results%2Bjson&timeout=0&debug=off";$.ajax({url:i,success:f})},f=function(r){var a,o=Number.MIN_VALUE,l=Number.MAX_VALUE,d=Number.MIN_VALUE,c=Number.MAX_VALUE,p=[],g=[];n.getSource().forEachFeature(function(e){e.gradient_value=Number.MIN_VALUE,u[e.get("nuts_id")]=e,e.opacity=.9});for(var f=0;f<r.results.bindings.length;f++)if(u[r.results.bindings[f].code.value]){a=parseFloat(r.results.bindings[f].value.value);var h={};for(var m in r.results.bindings[f])r.results.bindings[f].hasOwnProperty(m)&&(r.results.bindings[f][m].dataType&&"http://www.w3.org/2001/XMLSchema#date"==r.results.bindings[f][m].dataType?h[m]=r.results.bindings[f][m].value.substr(0,10):h[m]=r.results.bindings[f][m].value);h.value=a,o=a>o?a:o,l=a<l?a:l,g.push(h)}c=l,d=o;var v=crossfilter(g);n.getSource().forEachFeature(function(e){e.gradient_value=Number.MIN_VALUE,u[e.get("nuts_id")]=e,e.opacity=.9});var b=o-l,y=b/40,w=b/40,_=function(e){return~~((e.value-l)/y)},E=function(e){return~~((e.value-c)/w)},x=v.dimension(function(e){return e.value}),k=(x.group().reduceCount(function(e){return e.value}),v.dimension(E)),N=k.group().reduceCount(E),S=v.dimension(_),L=S.group().reduceCount(_),F=function(e,t){var r=k.top(1/0),a=Number.MIN_VALUE,o=Number.MAX_VALUE;t?(a=c+t[1]*w,o=c+t[0]*w):r.forEach(function(e){var t=e.value;a=t>a?t:a,o=t<o?t:o});n.getSource().forEachFeature(function(e){var t=e.get("data_value");(t<o||t>a)&&(e.opacity=.1)}),r.forEach(function(e){u[e.code]&&e.value>=o&&e.value<=a&&(u[e.code].opacity=.9,u[e.code].gradient_value=(e.value-o)/(a-o),u[e.code].set("data_value",e.value))})};i.width($("#lod_data_panel").width()-35).height(130).margins({top:3,right:10,bottom:20,left:30}).dimension(S).group(L).transitionDuration(500).centerBar(!0).gap(50).x(d3.scale.linear().domain([0,40])).xUnits(function(){return 10}).on("filtered",function(t,r){r&&(d=l+r[1]*y,c=l+r[0]*y,w=(d-c)/40,e.events.trigger(function(){s.getChartStack().clear(),k=crossfilter(S.top(1/0)).dimension(E),N=k.group().reduceCount(E),s.dimension(k).group(N),s.render(),F(0,null)}))}).elasticY(!0).xAxis().tickFormat(function(e){return(l+e*y).toFixed(2)}),s.width($("#lod_data_panel").width()-35).height(130).margins({top:3,right:10,bottom:20,left:30}).dimension(k).group(N).transitionDuration(500).centerBar(!0).gap(50).x(d3.scale.linear().domain([0,40])).xUnits(function(){return 10}).elasticY(!0).on("filtered",F).xAxis().tickFormat(function(e){return(c+e*w).toFixed(2)});var M=function(t,r){var a=x.top(1/0);o=Number.MIN_VALUE,l=Number.MAX_VALUE,a.forEach(function(e){var t=e.value;o=t>o?t:o,l=t<l?t:l}),y=(b=o-l)/40,i.getChartStack().clear(),S=crossfilter(x.top(1/0)).dimension(_),L=S.group().reduceCount(_),i.dimension(S).group(L),i.filterAll(),s.getChartStack().clear(),c=l,d=o,w=b/40,k=crossfilter(S.top(1/0)).dimension(E),N=k.group().reduceCount(E),s.dimension(k).group(N),s.render(),i.redraw(),e.events.trigger(function(){s.render()},600),F(0,null)};angular.forEach(t.groupings,function(t,r){var a=v.dimension(function(e){return e[t.name]?e[t.name]:"NaN"}),o=a.group().reduceCount(function(e){return e[t.name]?e[t.name]:"NaN"});switch(t.datatype){case"http://www.w3.org/2001/XMLSchema#date":(n=e.rowChart("#chart"+t.name)).width($("#lod_data_panel").width()-35).height(23*o.size()+40).labelOffsetY(12).dimension(a).group(o).on("filtered",M),p.push(n);break;default:if(1==a.group().size())return void $("#chart"+t.name).parent().hide();var o=a.group(),n=e.rowChart("#chart"+t.name);n.width($("#lod_data_panel").width()-35).height(23*o.size()+40).labelOffsetY(12).dimension(a).group(o).on("filtered",M),p.push(n)}}),e.renderAll(),s.render(),i.render(),t.loading=!1};t.$on("core.mainpanel_changed",function(e){"lodexplorer"==o.mainpanel?(t.data_panel_visible=!0,null==n&&(n=new ol.layer.Vector({title:"Nuts regions",source:new ol.source.Vector({format:new ol.format.GeoJSON,loader:function(e,t,r){$.ajax({url:hsl_path+"components/lodexplorer/nuts2.geojson",success:function(e){src.addFeatures(src.readFeatures(e))}})},strategy:ol.loadingstrategy.all}),style:t.styleFunction})),l.addLayer(n)):"info"!=o.mainpanel&&(l.removeLayer(n),t.data_panel_visible=!1)}),t.closeDataPanel=function(){t.data_panel_visible=!1},t.$emit("scope_loaded","LodExplorer")}])});