define(["ol","dc","map","query","core","drag"],function(ol,e){angular.module("hs.lodexplorer",["hs.drag","hs.map","hs.query","hs.core"]).directive("hs.lodexplorer.directive",function(){return{templateUrl:hsl_path+"components/lodexplorer/partials/lodexplorer.html?bust="+gitsha,link:function(e,r){}}}).service("hs.lodexplorer.service_sparqllog",[function(){return{logs:[]}}]).directive("hs.lodexplorer.directiveSparqllogdialog",function(){return{templateUrl:hsl_path+"components/lodexplorer/partials/sparqllogdialog.html?bust="+gitsha}}).controller("hs.lodexplorer.controller_sparqllogdialog",["$scope","hs.lodexplorer.service_sparqllog",function(e,r){e.sparql_log=r.logs}]).controller("hs.lodexplorer.controller",["$scope","hs.map.service","hs.query.service_infopanel","hs.lodexplorer.service_sparqllog","Core",function(r,t,a,o,n){var l=null,s=t.map,i=e.barChart("#dc-magnitude-chart","filtered"),u=e.barChart("#dc-magnitude-chart2","filter"),d={};r.ajax_loader=hsl_path+"components/lodexplorer/ajax-loader.gif",r.loading=!1,r.sparql_log=[],r.sources=[{url:"http://eurostat.linked-statistics.org/data/nama_r_e2gdp.rdf",name:"Gross domestic product (GDP) at current market prices by NUTS 2 regions"},{url:"http://eurostat.linked-statistics.org/data/demo_r_frate2.rdf",name:"Fertility rates by age - NUTS 2 regions"},{url:"http://eurostat.linked-statistics.org/data/hlth_rs_prsrg.rdf",name:"Health personnel by NUTS 2 regions"},{url:"http://eurostat.linked-statistics.org/data/ef_kvftreg.rdf",name:"Key variables: area, livestock (LSU), labour force and standard output (SO) by type of farming (2-digit)"}],r.setSources=function(e){r.sources=e,r.$$phase||r.$digest()},r.groupings=[],r.styleFunction=function(e,t){return Number.MIN_VALUE!=e.gradient_value?[new ol.style.Style({fill:new ol.style.Fill({color:r.rainbow(1,e.gradient_value,e.opacity?e.opacity:0)}),stroke:new ol.style.Stroke({color:"rgba(100, 100, 100, 0.3)"})})]:[new ol.style.Style({fill:new ol.style.Fill({color:[187,187,187,.9]}),stroke:new ol.style.Stroke({color:"rgba(100, 100, 100, 0.3)"})})]},r.rainbow=function(e,r,t){var a,o,n,l=r/(1.00000001*e),s=~~(4*l),i=4*l-s,u=1-i;switch(s%4){case 2:a=i,o=1,n=0;break;case 0:a=0,o=i,n=1;break;case 3:a=1,o=u,n=0;break;case 1:a=0,o=1,n=u}return"rgba("+~~(235*a)+","+~~(235*o)+","+~~(235*n)+", "+t+")"},r.chooseSource=function(e){var t=["SELECT DISTINCT ?classif","FROM <"+e+">","WHERE {","?s a <http://purl.org/linked-data/cube#Observation>;","    ?property ?classif .","FILTER(isIri(?classif) and ?property != <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> ","    and ?property != <http://purl.org/linked-data/cube#dataSet> ",")","}"].join("\n");console&&console.log(t);var a="http://data.plan4all.eu/sparql?default-graph-uri=&query="+window.escape(t)+"&format=application%2Fsparql-results%2Bjson&timeout=2000&debug=off";r.loading=!0,$.ajax({url:a,success:p})};var c="",p=function(e){r.classifs_loaded=!0;var t={};c="";for(var a=0;a<e.results.bindings.length;a++){var o=e.results.bindings[a].classif.value.split("#")[0];t[o]||(t[o]=o,c+="FROM <"+o+".rdf>\n")}var n=["SELECT ?property, ?value","FROM <"+r.source+">","WHERE {","{ SELECT ?s WHERE {?s a <http://purl.org/linked-data/cube#Observation>} LIMIT 1}.","?s ?property ?value .","FILTER(?property NOT IN ( <http://www.w3.org/1999/02/22-rdf-syntax-ns#type>, <http://purl.org/linked-data/cube#dataSet>, <http://eurostat.linked-statistics.org/property#geo>, <http://purl.org/linked-data/sdmx/2009/measure#obsValue>))","}"].join("\n");console&&console.log(n);var l="http://data.plan4all.eu/sparql?default-graph-uri=&query="+window.escape(n)+"&format=application%2Fsparql-results%2Bjson&timeout=2000&debug=off";$.ajax({url:l,success:g})},g=function(e){for(var t=e.results.bindings,a={},o=0;o<t.length;o++){var n=t[o].property.value.split("#")[1];a[n]||(a[n]={name:n,property:t[o].property.value,datatype:t[o].value.datatype?t[o].value.datatype:"url"})}r.groupings=a,r.loading=!1,r.$$phase||r.$digest(),f()},f=function(e){var t="";r.loading=!0;var a="",n="";angular.forEach(r.groupings,function(e,r){var o="";if(e.value){switch(e.datatype){case"http://www.w3.org/2001/XMLSchema#date":o="xsd:dateTime('"+e.value+"')";break;default:o="<"+e.value+">"}t+=" ?measurement <"+e.property+"> ?filter"+e.name+". FILTER(?filter"+e.name+" = "+o+" ).\n"}switch(e.datatype){case"http://www.w3.org/2001/XMLSchema#date":a+="OPTIONAL{?measurement <"+e.property+"> ?"+e.name+"}. \n",n+=", ?"+e.name;break;default:a+="OPTIONAL{?measurement <"+e.property+"> ?m_"+e.name+". ?m_"+e.name+" skos:prefLabel ?"+e.name+"}. \n",n+=", str(?"+e.name+") as ?"+e.name}});var l=["PREFIX property: <http://eurostat.linked-statistics.org/property#>","PREFIX measure: <http://purl.org/linked-data/sdmx/2009/measure#>","SELECT DISTINCT str(?code) as ?code, (xsd:decimal(?value) as ?value)"+n,"FROM <"+r.source+">","FROM <http://www.w3.org/2004/02/skos/core>","FROM <http://eurostat.linked-statistics.org/dic/unit>","FROM <http://data.plan4all.eu/nuts_supported.rdf>",c,"WHERE {","?measurement a <http://purl.org/linked-data/cube#Observation>;","measure:obsValue ?value;","property:geo ?location.","?location <http://data.plan4all.eu/nuts_supported.rdf#supported> true.",a,"?location skos:notation ?code.",t,"}"].join("\n");console&&console.log(l);var s=new Date;o.logs.unshift({date:s.toLocaleString(),query:l,date_val:s.valueOf()});var i="http://data.plan4all.eu/sparql?default-graph-uri=&query="+window.escape(l)+"&format=application%2Fsparql-results%2Bjson&timeout=0&debug=off";$.ajax({url:i,success:h})},h=function(t){var a,o=Number.MIN_VALUE,n=Number.MAX_VALUE,s=Number.MIN_VALUE,c=Number.MAX_VALUE,p=[],g=[];l.getSource().forEachFeature(function(e){e.gradient_value=Number.MIN_VALUE,d[e.get("nuts_id")]=e,e.opacity=.9});for(var f=0;f<t.results.bindings.length;f++)if(d[t.results.bindings[f].code.value]){a=parseFloat(t.results.bindings[f].value.value);var h={};for(var m in t.results.bindings[f])t.results.bindings[f].hasOwnProperty(m)&&(t.results.bindings[f][m].dataType&&"http://www.w3.org/2001/XMLSchema#date"==t.results.bindings[f][m].dataType?h[m]=t.results.bindings[f][m].value.substr(0,10):h[m]=t.results.bindings[f][m].value);h.value=a,o=a>o?a:o,n=a<n?a:n,g.push(h)}c=n,s=o;var v=crossfilter(g);l.getSource().forEachFeature(function(e){e.gradient_value=Number.MIN_VALUE,d[e.get("nuts_id")]=e,e.opacity=.9});var b=o-n,y=b/40,w=b/40,_=function(e){return~~((e.value-n)/y)},E=function(e){return~~((e.value-c)/w)},x=v.dimension(function(e){return e.value}),k=(x.group().reduceCount(function(e){return e.value}),v.dimension(E)),N=k.group().reduceCount(E),S=v.dimension(_),L=S.group().reduceCount(_),F=function(e,r){var t=k.top(1/0),a=Number.MIN_VALUE,o=Number.MAX_VALUE;r?(a=c+r[1]*w,o=c+r[0]*w):t.forEach(function(e){var r=e.value;a=r>a?r:a,o=r<o?r:o});l.getSource().forEachFeature(function(e){var r=e.get("data_value");(r<o||r>a)&&(e.opacity=.1)}),t.forEach(function(e){d[e.code]&&e.value>=o&&e.value<=a&&(d[e.code].opacity=.9,d[e.code].gradient_value=(e.value-o)/(a-o),d[e.code].set("data_value",e.value))})};u.width($("#lod_data_panel").width()-35).height(130).margins({top:3,right:10,bottom:20,left:30}).dimension(S).group(L).transitionDuration(500).centerBar(!0).gap(50).x(d3.scale.linear().domain([0,40])).xUnits(function(){return 10}).on("filtered",function(r,t){t&&(s=n+t[1]*y,c=n+t[0]*y,w=(s-c)/40,e.events.trigger(function(){i.getChartStack().clear(),k=crossfilter(S.top(1/0)).dimension(E),N=k.group().reduceCount(E),i.dimension(k).group(N),i.render(),F(0,null)}))}).elasticY(!0).xAxis().tickFormat(function(e){return(n+e*y).toFixed(2)}),i.width($("#lod_data_panel").width()-35).height(130).margins({top:3,right:10,bottom:20,left:30}).dimension(k).group(N).transitionDuration(500).centerBar(!0).gap(50).x(d3.scale.linear().domain([0,40])).xUnits(function(){return 10}).elasticY(!0).on("filtered",F).xAxis().tickFormat(function(e){return(c+e*w).toFixed(2)});var M=function(r,t){var a=x.top(1/0);o=Number.MIN_VALUE,n=Number.MAX_VALUE,a.forEach(function(e){var r=e.value;o=r>o?r:o,n=r<n?r:n}),y=(b=o-n)/40,u.getChartStack().clear(),S=crossfilter(x.top(1/0)).dimension(_),L=S.group().reduceCount(_),u.dimension(S).group(L),u.filterAll(),i.getChartStack().clear(),c=n,s=o,w=b/40,k=crossfilter(S.top(1/0)).dimension(E),N=k.group().reduceCount(E),i.dimension(k).group(N),i.render(),u.redraw(),e.events.trigger(function(){i.render()},600),F(0,null)};angular.forEach(r.groupings,function(r,t){var a=v.dimension(function(e){return e[r.name]?e[r.name]:"NaN"}),o=a.group().reduceCount(function(e){return e[r.name]?e[r.name]:"NaN"});switch(r.datatype){case"http://www.w3.org/2001/XMLSchema#date":(n=e.rowChart("#chart"+r.name)).width($("#lod_data_panel").width()-35).height(23*o.size()+40).labelOffsetY(12).dimension(a).group(o).on("filtered",M),p.push(n);break;default:if(1==a.group().size())return void $("#chart"+r.name).parent().hide();var o=a.group(),n=e.rowChart("#chart"+r.name);n.width($("#lod_data_panel").width()-35).height(23*o.size()+40).labelOffsetY(12).dimension(a).group(o).on("filtered",M),p.push(n)}}),e.renderAll(),i.render(),u.render(),r.loading=!1};r.$on("core.mainpanel_changed",function(e){"lodexplorer"==n.mainpanel?(r.data_panel_visible=!0,null==l&&(l=new ol.layer.Vector({title:"Nuts regions",source:new ol.source.Vector({format:new ol.format.GeoJSON,loader:function(e,r,t){$.ajax({url:hsl_path+"components/lodexplorer/nuts2.geojson",success:function(e){src.addFeatures(src.readFeatures(e))}})},strategy:ol.loadingstrategy.all}),style:r.styleFunction})),s.addLayer(l)):"info"!=n.mainpanel&&(s.removeLayer(l),r.data_panel_visible=!1)}),r.closeDataPanel=function(){r.data_panel_visible=!1},r.$emit("scope_loaded","LodExplorer")}])});