define(["angular","ol","dc","map"],function(angular,ol,e){String.prototype.hashCode=function(){var e=0;if(0==this.length)return e;for(i=0;i<this.length;i++)char=this.charCodeAt(i),e=(e<<5)-e+char,e&=e;return e};angular.module("hs.feature_crossfilter",["hs.map","hs.core"]).directive("hs.featureCrossfilter.directive",function(){return{templateUrl:hsl_path+"components/feature_crossfilter/partials/f_crossfilter.html?bust="+gitsha,link:function(e,r){}}}).service("hs.feature_crossfilter.service",[function(){return{makeCrossfilterDimensions:function(e,r){var t=crossfilter(e.getFeatures()),i=[];for(var n in r){var o=r[n],s=t.dimension(function(e){return e.get(o)}),a=s.group().reduceCount(function(e){return e.get(o)});i.push({dimension:s,grouping:a})}return i}}}]).controller("hs.feature_crossfilter.controller",["$scope","hs.map.service","Core","hs.feature_crossfilter.service","config",function(r,t,i,n,o){t.map;var s=o.crossfilterable_layers;r.ajax_loader=hsl_path+"components/feature_crossfilter/ajax-loader.gif",r.loading=!1,r.groupings=[],r.createConfiguredCharts=function(){r.loading=!0;for(var i in r.groupings)r.groupings[i].dirty=!0;for(o=0;o<s.length;o++)if(0==t.map.getLayers().item(s[o].layer_ix).getSource().getFeatures().length)return void setTimeout(r.createConfiguredCharts,1e3);for(var o=0;o<s.length;o++){for(var a=t.map.getLayers().item(s[o].layer_ix),u=s[o].attributes,f=0;f<u.length;f++){var g=u[f],c=!1;for(var i in r.groupings)r.groupings[i].id==o.toString()+g.hashCode&&(r.groupings[i].dirty,c=!0);c||r.groupings.push({name:g,id:o.toString()+g.hashCode(),dirty:!1})}r.$$phase||r.$digest(),a.getSource().on("change",r.createConfiguredCharts);for(var l=n.makeCrossfilterDimensions(a.getSource(),u),h=function(e,t){var i=e.dimension().top(1/0);a.getSource().forEachFeature(function(e){e.set("visible",!1)});for(var n=0;n<i.length;n++)i[n].set("visible",!0);r.$emit("feature_crossfilter_filtered",t)},f=0;f<u.length;f++){var g=u[f],d=[],p=function(r,t){if($(r).length>0){var i=e.rowChart(r);i.width($(".panelspace").width()-35).height(23*l[t].grouping.size()+40).labelOffsetY(12).dimension(l[t].dimension).group(l[t].grouping).on("filtered",h),d.push(i),i.render()}else setTimeout(p,1e3,r,t)};p("#fc_chart"+o+g.hashCode(),f)}}for(var m=r.groupings.length-1;m>0;m--)1==r.groupings[i].dirty&&r.groupings.splice(m,1);r.loading=!1,r.$$phase||r.$digest()},"feature_crossfilter"==i.mainpanel&&r.createConfiguredCharts(),r.$on("core.mainpanel_changed",function(e){"feature_crossfilter"==i.mainpanel&&r.createConfiguredCharts()}),r.$on("infopanel.updated",function(e){}),r.$emit("scope_loaded","FeatureCrossfilter")}])});