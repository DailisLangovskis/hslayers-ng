define(["angular","app","map","ol","utils","ows.wms","dragdroplists","status_creator"],function(angular,e,a,ol){angular.module("hs.layermanager",["hs.map","hs.utils","hs.ows.wms","dndLists","hs.status_creator"]).directive("hs.layermanager.directive",function(){return{templateUrl:hsl_path+"components/layermanager/partials/layermanager.html?bust="+gitsha}}).directive("hs.layermanager.layerlistDirective",["$compile",function(e){return{templateUrl:hsl_path+"components/layermanager/partials/layerlist.html?bust="+gitsha,compile:function(a){var t,r=a.contents().remove();return function(a,i){function n(){var e=[];return angular.forEach(a.data.layers,function(t){(t.layer.get("path")==a.obj.hsl_path||(angular.isUndefined(t.layer.get("path"))||""==t.layer.get("path"))&&""==a.obj.hsl_path)&&e.push(t)}),e}function s(){a.filtered_layers=n(),a.filtered_layers.sort(function(e,a){return a.layer.get("position")-e.layer.get("position")}),a.generateLayerTitlesArray()}a.layer_titles=[],null==a.value?a.obj=a.data.folders:a.obj=a.value,a.filtered_layers=n(),a.generateLayerTitlesArray=function(){a.layer_titles=[];for(var e=0;e<a.filtered_layers.length;e++)a.layer_titles.push(a.filtered_layers[e].title)},a.$on("layermanager.updated",s),s(),angular.isUndefined(t)&&(t=e(r)),t(a,function(e){i.append(e)}),a.dragged=function(e,t,r,i,n){a.draggedCont(e,t,r,i,n,a.layer_titles)}}}}}]).directive("hs.layermanager.removeAllDialogDirective",function(){return{templateUrl:hsl_path+"components/layermanager/partials/dialog_removeall.html?bust="+gitsha,link:function(e,a,t){$("#hs-remove-all-dialog").modal("show")}}}).directive("hs.layermanager.folderDirective",["$compile",function(e){return{templateUrl:hsl_path+"components/layermanager/partials/folder.html?bust="+gitsha,compile:function(a){var t,r=a.contents().remove();return function(a,i){a.folderVisible=function(e){return e.sub_folders.length>0},null==a.value?a.obj="-":a.obj=a.value,angular.isUndefined(t)&&(t=e(r)),t(a,function(e){i.append(e)})}}}}]).service("hs.layermanager.service",["$rootScope","hs.map.service","Core","hs.utils.service","config","hs.layermanager.WMSTservice",function(e,a,t,r,i,n){function s(e,a){return e.indexOf("proxy4ows")>-1&&(e=r.getParamsFromUrl(e).OWSURL),e+=(e.indexOf("?")>0?"":"?")+"&version=1.3.0&service=WMS&request=GetLegendGraphic&sld_version=1.1.0&layer="+a+"&format=image%2Fpng"}function l(a){var t=a.element;if(null==t.get("show_in_manager")||0!=t.get("show_in_manager")){n.layerIsWmsT(t),m(t);var r;if(t.getSource().getParams){r=t.getSource().getParams().LAYERS.split(",");for(var i=0;i<r.length;i++)t.getSource().getUrls&&(r[i]=s(t.getSource().getUrls()[0],r[i])),t.getSource().getUrl&&(r[i]=s(t.getSource().getUrl(),r[i]))}t.on("change:visible",function(a){if(1!=t.get("base")){for(r=0;r<h.data.layers.length;r++)if(h.data.layers[r].layer==a.target){h.data.layers[r].visible=a.target.getVisible();break}}else for(var r=0;r<h.data.baselayers.length;r++)h.data.baselayers[r].layer==a.target?h.data.baselayers[r].active=a.target.getVisible():h.data.baselayers[r].active=!1;e.$$phase||e.$digest()}),void 0===t.get("position")&&t.set("position",y(t)),console&&console.log(t.get("title"),t.getVisible());var l={title:o(t),layer:t,grayed:h.isLayerInResolutionInterval(t),visible:t.getVisible()};if(n.layerIsWmsT(l)){var c,u=l.layer.get("dimensions_time")||l.layer.dimensions_time;c=angular.isDefined(l.layer.get("dimensions").time.default)?new Date(l.layer.get("dimensions").time.default):new Date(u.timeInterval[0]),angular.extend(l,{time_step:u.timeStep,time_unit:u.timeUnit,date_format:n.getDateFormatForTimeSlider(u.timeUnit),date_from:new Date(u.timeInterval[0]),date_till:new Date(u.timeInterval[1]),time:c,date_increment:c.getTime()}),n.setLayerTimeSliderIntervals(l,u),n.setLayerTime(l)}1!=t.get("base")?(d(t),t.get("legends")&&(l.legends=t.get("legends")),h.data.layers.push(l)):(l.active=t.getVisible(),h.data.baselayers.push(l)),t.getVisible()&&t.get("base")&&(h.data.baselayer=o(t)),h.updateLayerOrder(),e.$broadcast("layermanager.updated",t),e.$broadcast("compositions.composition_edited")}}function o(e){return angular.isDefined(e.get("title"))?e.get("title").replace(/&#47;/g,"/"):"Void"}function d(e){if(angular.isDefined(e.get("path"))&&"undefined"!==e.get("path")){for(var a=e.get("path").split("/"),t=h.data.folders,r=0;r<a.length;r++){var i=null;if(angular.forEach(t.sub_folders,function(e){e.name==a[r]&&(i=e)}),null==i){var n={sub_folders:[],indent:r,layers:[],name:a[r],hsl_path:t.hsl_path+(""!=t.hsl_path?"/":"")+a[r],coded_path:t.coded_path+t.sub_folders.length+"-"};t.sub_folders.push(n),t=n}else t=i}t.layers.push(e),h.data.folders.layers.indexOf(e)>-1&&h.data.folders.layers.splice(h.data.folders.layers.indexOf(e),1)}else h.data.folders.layers.push(e)}function c(e){if(angular.isDefined(e.get("path"))&&"undefined"!==e.get("path")){for(var a=e.get("path").split("/"),t=h.data.folders,r=0;r<a.length;r++)angular.forEach(t.sub_folders,function(e){e.name==a[r]&&(t=e)});t.layers.splice(t.layers.indexOf(e),1);for(r=a.length;r>0&&(0==t.layers.length&&0==t.sub_folders.length);r--){var i=h.data.folders;if(r>1)for(var n=0;n<r-1;n++)angular.forEach(i.sub_folders,function(e){e.name==a[n]&&(i=e)});i.sub_folders.splice(i.sub_folders.indexOf(t),1),t=i}}else h.data.folders.layers.splice(h.data.folders.layers.indexOf(e),1)}function u(a){c(a.element);for(t=0;t<h.data.layers.length;t++)h.data.layers[t].layer==a.element&&h.data.layers.splice(t,1);for(var t=0;t<h.data.baselayers.length;t++)h.data.baselayers[t].layer==a.element&&h.data.baselayers.splice(t,1);e.$broadcast("layermanager.updated",a.element),e.$broadcast("layer.removed",a.element),e.$broadcast("compositions.composition_edited")}function g(){angular.isDefined(i.box_layers)&&(h.data.box_layers=i.box_layers,angular.forEach(h.data.box_layers,function(e){var a=!1,t=!1;angular.forEach(e.get("layers"),function(e){1==e.get("visible")&&1==e.get("base")?t=!0:1==e.get("visible")&&(a=!0)}),e.set("active",t||a)}))}function y(e){for(var t=null,r=0;r<a.map.getLayers().getLength();r++)if(a.map.getLayers().item(r)==e){t=r;break}return t}function m(a){var t=a.getSource();t.loadCounter=0,t.loadTotal=0,t.loadError=0,t.loaded=!0,a instanceof ol.layer.Image?(t.on("imageloadstart",function(r){t.loaded=!1,t.loadCounter+=1,e.$broadcast("layermanager.layer_loading",a),e.$$phase||e.$digest()}),t.on("imageloadend",function(r){t.loaded=!0,t.loadCounter-=1,e.$broadcast("layermanager.layer_loaded",a),e.$$phase||e.$digest()}),t.on("imageloaderror",function(r){t.loaded=!0,t.error=!0,e.$broadcast("layermanager.layer_loaded",a),e.$$phase||e.$digest()})):a instanceof ol.layer.Tile&&(t.on("tileloadstart",function(r){t.loadCounter+=1,t.loadTotal+=1,1==t.loaded&&(t.loaded=!1,t.set("loaded",!1),e.$broadcast("layermanager.layer_loading",a),e.$$phase||e.$digest())}),t.on("tileloadend",function(r){t.loadCounter-=1,0==t.loadCounter&&(t.loaded=!0,t.set("loaded",!0),e.$broadcast("layermanager.layer_loaded",a),e.$$phase||e.$digest())}),t.on("tileloaderror",function(r){t.loadCounter-=1,t.loadError+=1,t.loadError==t.loadTotal&&(t.error=!0),0==t.loadCounter&&(t.loaded=!0,t.set("loaded",!0),e.$broadcast("layermanager.layer_loaded",a),e.$$phase||e.$digest())}))}function f(){p=a.map,a.map.getLayers().forEach(function(e){l({element:e})}),g(),a.map.getView().on("change:resolution",function(a){null!=v&&clearTimeout(v),v=setTimeout(function(){for(var a=0;a<h.data.layers.length;a++)h.data.layers[a].grayed=h.isLayerInResolutionInterval(h.data.layers[a].layer);e.$$phase||e.$digest()},500)}),p.getLayers().on("add",l),p.getLayers().on("remove",u)}var h={};h.data={},h.data.folders={hsl_path:"",coded_path:"0-",layers:[],sub_folders:[],indent:0},h.data.layers=[],h.data.baselayers=[],h.data.baselayersVisibile=!0;var p;h.getLayerByTitle=function(e){var a;return angular.forEach(h.data.layers,function(t){t.title==e&&(a=t)}),a},h.changeLayerVisibility=function(e,a){a.layer.setVisible(e),a.visible=e,e&&1==a.layer.get("exclusive")&&angular.forEach(h.data.layers,function(e){e.layer.get("path")==a.layer.get("path")&&e!=a&&(e.layer.setVisible(!1),e.visible=!1)})},h.changeBaseLayerVisibility=function(e,a){if(1==h.data.baselayersVisible)if(e){for(t=0;t<h.data.baselayers.length;t++)h.data.baselayers[t].layer.setVisible(!1),h.data.baselayers[t].visible=!1,h.data.baselayers[t].active=!1;for(t=0;t<h.data.baselayers.length;t++)if(h.data.baselayers[t]==a){h.data.baselayers[t].layer.setVisible(!0),h.data.baselayers[t].visible=!0,h.data.baselayers[t].active=!0;break}}else{h.data.baselayersVisible=!1;for(t=0;t<h.data.baselayers.length;t++)h.data.baselayers[t].layer.setVisible(!1)}else{if(e){a.active=!0;for(t=0;t<h.data.baselayers.length;t++)h.data.baselayers[t]!=a?h.data.baselayers[t].active=!1:h.data.baselayers[t].layer.setVisible(!0)}else for(var t=0;t<h.data.baselayers.length;t++)1==h.data.baselayers[t].visible&&h.data.baselayers[t].layer.setVisible(!0);h.data.baselayersVisible=!0}},h.updateLayerOrder=function(){angular.forEach(h.data.layers,function(e){e.layer.set("position",y(e.layer))})},h.removeAllLayers=function(){var e=[];for(a.map.getLayers().forEach(function(a){(angular.isUndefined(a.get("removable"))||1==a.get("removable"))&&(angular.isUndefined(a.get("base"))||0==a.get("base"))&&e.push(a)});e.length>0;)a.map.removeLayer(e.shift())},h.activateTheme=function(e){var a=!0;1==e.get("active")&&(a=!1),e.set("active",a);var t=!1;e.setVisible(a),angular.forEach(e.get("layers"),function(e){if(1!=e.get("base")||t){if(1==e.get("base"))return;e.setVisible(a)}else h.changeBaseLayerVisibility(),t=!0})},h.isLayerInResolutionInterval=function(e){var t=e.getSource();if(t instanceof ol.source.ImageWMS||t instanceof ol.source.TileWMS){var r=a.map.getView().getResolution(),i=p.getView().getProjection().getUnits(),n=r*ol.proj.METERS_PER_UNIT[i]*39.37*(25.4/.28);return e.getMinResolution()>=n||n>=e.getMaxResolution()}n=a.map.getView().getResolution();return e.getMinResolution()>=n&&n<=e.getMaxResolution()};var v;return angular.isDefined(a.map)?f():e.$on("map.loaded",function(){f()}),h}]).service("hs.layermanager.WMSTservice",["$rootScope","hs.map.service","Core","hs.utils.service","config",function(e,a,t,r,i){function n(e){var a,t,r,i,n,s,l,o;r=i=n=s=l=o=0;var d=e.search("T");if(d>-1?(a=e.substring(1,d),t=e.substring(d+1)):a=e.substring(1),a){var c=a.search("Y")>-1?a.search("Y"):void 0,u=a.search("M")>-1?a.search("M"):void 0,g=(a.search("W")>-1&&a.search("W"),a.search("D")>-1?a.search("D"):void 0);void 0!==c&&(r=parseFloat(a.substring(0,c))),void 0!==u&&(i=parseFloat(a.substring((c||-1)+1,u))),void 0!==g&&(n=parseFloat(a.substring((u||c||-1)+1,g)))}if(t){var y=t.search("H")>-1?t.search("H"):void 0,m=t.search("M")>-1?t.search("M"):void 0,f=t.search("S")>-1?t.search("S"):void 0;void 0!==y&&(s=parseFloat(t.substring(0,y))),void 0!==m&&(l=parseFloat(t.substring((y||-1)+1,m))),void 0!==f&&(o=parseFloat(t.substring((m||y||-1)+1,f)))}var h=new Date(0,0,0,0,0,0,0);return new Date(r,i,n,s,l,o,0)-h}var s={};return s.getDateFormatForTimeSlider=function(e){switch(e){case"FullYear":case"Month":case"Day":return date_format="dd-MM-yyyy";default:return"dd-MM-yyyy HH:mm"}},s.setLayerTimeSliderIntervals=function(e,a){switch(e.time_unit){case"FullYear":t=new Date(a.timeInterval[0]);e.min_time=t.getFullYear(),t=new Date(a.timeInterval[1]),e.max_time=t.getFullYear();break;case"Month":var t=new Date(a.timeInterval[0]);e.min_time=0;var r=new Date(a.timeInterval[1]);e.max_time=t.monthDiff(r);break;default:e.min_time=new Date(a.timeInterval[0]).getTime(),e.max_time=new Date(a.timeInterval[1]).getTime()}},s.layerIsWmsT=function(e){if(angular.isUndefined(e)||null==e)return!1;var a=e.layer;if(angular.isUndefined(a))return!1;if(a.get("dimensions_time")&&angular.isArray(a.get("dimensions_time").timeInterval))return!0;if(a.get("dimensions")&&angular.isObject(a.get("dimensions").time)){var t={},r=a.get("dimensions").time.values;if(angular.isArray(r)&&(r=r[0]),(r=r.replace(/\s*/g,"")).search("/")>-1){var i=r.split("/").map(function(e){return e.search("Z")>-1&&(e=e.replace("Z","00:00")),e});3==i.length&&(t.timeStep=n(i[2]),i.pop()),t.timeInterval=i}return angular.extend(a,{dimensions_time:t}),!0}return!1},s.setLayerTime=function(a,t){var r=a.layer.get("dimensions_time")||a.layer.dimensions_time,i=new Date(r.timeInterval[0]);switch(a.time_unit){case"FullYear":i.setFullYear(a.date_increment);break;case"Month":i.addMonths(a.date_increment);break;default:a.date_increment<a.min_time&&(a.date_increment=a.min_time),a.date_increment>a.max_time&&(a.date_increment=a.max_time),i=new Date(parseInt(a.date_increment))}a.time=i,angular.isDefined(t)&&i.setTime(i.getTime()+3600*t*1e3),a.layer.getSource().updateParams({TIME:i.toISOString()}),e.$broadcast("layermanager.layer_time_changed",a.layer,i.toISOString())},s}]).controller("hs.layermanager.controller",["$scope","hs.map.service","config","$rootScope","Core","$compile","hs.utils.service","hs.styler.service","hs.ows.wms.service_capabilities","hs.status_creator.service","hs.layermanager.service","hs.layermanager.WMSTservice","hs.utils.layerUtilsService",function(e,a,t,r,i,n,s,l,o,d,c,u,g){function y(e){var a=null,t=e.get("BoundingBox");if(angular.isArray(t)&&4==t.length)a=ol.proj.transformExtent(t,"EPSG:4326",f.getView().getProjection());else for(var r=0;r<t.length;r++)if(angular.isDefined(ol.proj.get(t[r].crs))||angular.isDefined(e.getSource().getParams().FROMCRS)){var i=t[r].crs||e.getSource().getParams().FROMCRS;b=t[r].extent;var n=[b[0],b[1]],s=[b[2],b[3]];n=ol.proj.transform(n,i,f.getView().getProjection()),s=ol.proj.transform(s,i,f.getView().getProjection()),a=[n[0],n[1],s[0],s[1]];break}return a}function m(){f=a.map}e.Core=i,e.layer_renamer_visible=!1,e.data=c.data;var f;e.changeLayerVisibility=c.changeLayerVisibility,e.changeBaseLayerVisibility=c.changeBaseLayerVisibility,e.activateTheme=c.activateTheme,e.setCurrentLayer=function(a,t,r){return e.currentlayer==a?e.currentlayer=null:(e.currentlayer=a,u.layerIsWmsT(a)&&(e.currentlayer.time=new Date(a.layer.getSource().getParams().TIME),e.currentlayer.date_increment=e.currentlayer.time.getTime()),$(".layerpanel").insertAfter($("#layer"+r+t)),e.cur_layer_opacity=a.layer.getOpacity()),!1},e.setLayerOpacity=function(a){return a.setOpacity(e.cur_layer_opacity),e.$emit("compositions.composition_edited"),!1},e.removeLayer=function(e){f.removeLayer(e)},e.draggedCont=function(e,t,i,n,s,l){l.indexOf(i)<t&&t--;for(var o=l[t],d=null,u=null,g=a.map.getLayers(),y=0;y<g.getLength();y++)g.item(y).get("title")==o&&(d=y),g.item(y).get("title")==i&&(u=y),t>l.length&&(d=y+1);var m=g.item(u);f.getLayers().removeAt(u),f.getLayers().insertAt(d,m),c.updateLayerOrder(),r.$broadcast("layermanager.updated")},e.zoomToLayer=function(a){var t=null;if(a.get("BoundingBox")?t=y(a):angular.isDefined(a.getSource().getExtent)&&(t=a.getSource().getExtent()),null==t&&e.isLayerWMS(a)){var r=null;a.getSource().getUrls&&(r=a.getSource().getUrls()[0]),a.getSource().getUrl&&(r=a.getSource().getUrl()),o.requestGetCapabilities(r).then(function(e){var r=(new ol.format.WMSCapabilities).read(e.data);angular.isArray(r.Capability.Layer)&&angular.forEach(r.Capability.Layer,function(e){e.Name==a.params.LAYERS&&a.set("BoundingBox",e.BoundingBox)}),angular.isObject(r.Capability.Layer)&&(a.set("BoundingBox",r.Capability.Layer.BoundingBox),null!=(t=y(a))&&f.getView().fit(t,f.getSize()))})}null!=t&&f.getView().fit(t,f.getSize())},e.layerIsZoomable=g.layerIsZoomable,e.layerIsStyleable=g.layerIsStyleable,e.styleLayer=function(e){l.layer=e,i.setMainPanel("styler")},e.removeAllLayers=function(a,t){if(void 0!==a)c.removeAllLayers(),1==t&&r.$broadcast("compositions.load_composition",e.composition_id);else if(0==$("#hs-dialog-area #hs-remove-all-dialog").length){var i=angular.element("<div hs.layermanager.remove_all_dialog_directive></div>");$("#hs-dialog-area").append(i),n(i)(e)}else $("#hs-remove-all-dialog").modal("show")},e.isLayerQueryable=function(e){g.isLayerQueryable(e.layer)},e.isLayerWMS=g.isLayerWMS,e.dateToNonUtc=function(e){if(!angular.isUndefined(e))return new Date(e.valueOf()+6e4*e.getTimezoneOffset())},e.toggleLayerRename=function(){e.layer_renamer_visible=!e.layer_renamer_visible},e.setTitle=function(){e.currentlayer.layer.set("title",e.currentlayer.title)},e.hasBoxImages=function(){if(angular.isDefined(e.data.box_layers))for(var a=0;a<e.data.box_layers.length;a++)if(e.data.box_layers[a].get("img"))return!0;return!1},e.isLayerInResolutionInterval=function(e){var t=e.getSource();if(t instanceof ol.source.ImageWMS||t instanceof ol.source.TileWMS){var r=a.map.getView().getResolution(),i=f.getView().getProjection().getUnits(),n=r*ol.proj.METERS_PER_UNIT[i]*39.37*(25.4/.28);return e.getMinResolution()>=n||n>=e.getMaxResolution()}n=a.map.getView().getResolution();return e.getMinResolution()>=n&&n<=e.getMaxResolution()},e.isScaleVisible=function(e){return void 0!==e&&(e.minResolutionValid=!1,e.maxResolutionValid=!1,angular.isDefined(e.getMinResolution())&&0!=e.getMinResolution()&&(e.minResolutionValid=!0,e.minResolution=e.getMinResolution()),angular.isDefined(e.getMaxResolution())&&e.getMaxResolution()!=1/0&&(e.maxResolutionValid=!0,e.maxResolution=e.getMaxResolution()),!(!e.minResolutionValid&&!e.maxResolutionValid))},e.setLayerResolution=function(e){if(void 0===e)return!1;e.setMinResolution(e.minResolution),e.setMaxResolution(e.maxResolution)},e.layerLoaded=g.layerLoaded,e.layerValid=g.layerInvalid,e.addDrawingLayer=function(){var a=new ol.source.Vector;a.styleAble=!0,a.hasPoint=!0,a.hasPolygon=!0,a.hasLine=!0;var t=new ol.layer.Vector({title:"New user graphics layer",visibility:!0,source:a});f.getLayers().push(t),e.$emit("layer_added",{layer:d.layer2json(t)}),hslayers_api.gui.Draw.setLayerToSelect(t),i.setMainPanel("draw",!1,!1)},e.$on("layer.removed",function(a,t){angular.isObject(e.currentlayer)&&e.currentlayer.layer==t&&($(".layerpanel").insertAfter($(".hs-lm-mapcontentlist")),e.currentlayer=null)}),e.$on("compositions.composition_loaded",function(a,t){angular.isUndefined(t.error)&&(angular.isDefined(t.data)&&angular.isDefined(t.data.id)?e.composition_id=t.data.id:angular.isDefined(t.id)?e.composition_id=t.id:delete e.composition_id)}),e.$on("compositions.composition_deleted",function(a,t){t==e.composition_id&&(delete e.composition_id,e.$$phase||e.$digest())}),e.$on("core.map_reset",function(a){delete e.composition_id,e.$$phase||e.$digest()}),angular.isDefined(a.map)?m():r.$on("map.loaded",function(){m()}),e.$emit("scope_loaded","LayerManager")}])});