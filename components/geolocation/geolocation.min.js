define(["angular","ol"],function(angular,ol){angular.module("hs.geolocation",["hs.map"]).directive("hs.geolocation.directive",["hs.map.service","hs.geolocation.service","Core",function(o,e,t){return{templateUrl:t.isMobile()?hsl_path+"components/geolocation/partials/geolocation_cordova.html?bust="+gitsha:hsl_path+"components/geolocation/partials/geolocation.html?bust="+gitsha,link:function(o,a,n){t.puremapApp||(t.isMobile()?(a.appendTo($("#menu")),$(".blocate").click(function(){$(".locate-mobile").toggleClass("ol-collapsed"),$("#toolbar").removeClass("show"),e.gpsStatus||$(".locate-mobile").hasClass("ol-collapsed")||(e.toggleGps(),e.toggleFeatures(!0))})):(a.appendTo($(".ol-overlaycontainer-stopevent")),$(".locate .blocate").click(function(){$(".locate").toggleClass("ol-collapsed"),e.geolocation.setTracking(!0),e.toggleFeatures(!$(".locate").hasClass("ol-collapsed"))})))},replace:!0}}]).service("hs.geolocation.service",["hs.map.service","$rootScope","$log","Core",function(o,e,t,a){function n(){if(a.isMobile()){l.setCenter=function(){o.map.getView().setCenter(l.last_location.latlng)},l.geolocation=navigator.geolocation,l.toggleGps=function(){l.gpsStatus?l.stopGpsWatch():l.startGpsWatch(),l.toggleFeatures(l.gpsStatus),e.$broadcast("geolocation.switched")},l.startGpsWatch=function(){navigator.geolocation&&(l.gpsStatus=!0,null!=l.changed_handler&&l.geolocation.clearWatch(l.changed_handler),l.changed_handler=l.geolocation.watchPosition(n,s,r))},l.stopGpsWatch=function(){l.gpsStatus=!1,l.geolocation.clearWatch(l.changed_handler),l.changed_handler=null};var n=function(t){l.accuracy=t.coords.accuracy?Math.round(t.coords.accuracy):"-",l.altitude=t.coords.altitude?Math.round(t.coords.altitude):"-",l.heading=t.coords.heading?t.coords.heading:null,l.speed=t.coords.speed?Math.round(3.6*t.coords.speed):"-",l.last_location={latlng:ol.proj.transform([t.coords.longitude,t.coords.latitude],"EPSG:4326",o.map.getView().getProjection()),geoposition:t},i.setGeometry()?i.getGeometry().setCoordinates(l.last_location.latlng):i.setGeometry(new ol.geom.Point(l.last_location.latlng)),c.setGeometry()?c.getGeometry().setCenterAndRadius(l.last_location.latlng,l.accuracy):c.setGeometry(new ol.geom.Circle(l.last_location.latlng,t.coords.accuracy)),l.following&&l.setCenter(),lat=t.coords.latitude,lon=t.coords.longitude,"undefined"!=typeof trackingDb&&trackingDb.transaction(logPosition,errorCB,successCB),db_id++,e.$broadcast("geolocation.updated")},s=function(o){var e="Error "+o.code+": "+o.message;console&&console.log(e),l.gpsStatus&&("Timeout expired"==o.message&&(console&&console.log("Removing the timeout setting"),r.timeout=1e4,null!=l.changed_handler&&l.geolocation.clearWatch(l.changed_handler)),setTimeout(function(){l.changed_handler=l.geolocation.watchPosition(n,s,r),console&&console.log("Try again..")},5e3))},r={enableHighAccuracy:!0,timeout:5e3,maximumAge:1e5}}else l.geolocation=new ol.Geolocation({projection:o.map.getView().getProjection()}),l.changed_handler=function(){if(l.geolocation.getTracking()){if(l.accuracy=l.geolocation.getAccuracy()?l.geolocation.getAccuracy()+" [m]":"",l.altitude=l.geolocation.getAltitude()?l.geolocation.getAltitude()+" [m]":"-",l.altitudeAccuracy=l.geolocation.getAltitudeAccuracy()?"+/- "+l.geolocation.getAltitudeAccuracy()+" [m]":"",l.heading=l.geolocation.getHeading()?l.geolocation.getHeading():null,l.speed=l.geolocation.getSpeed()?l.geolocation.getSpeed()+" [m/s]":"-",l.last_location={latlng:l.geolocation.getPosition(),geoposition:l.geolocation},console.log(l.last_location),l.geolocation.getPosition()){var a=l.geolocation.getPosition();t.info(a),i.getGeometry()?i.getGeometry().setCoordinates(a):i.setGeometry(new ol.geom.Point(a)),l.following&&o.map.getView().setCenter(a)}l.heading&&o.map.getView().setRotation(l.heading),e.$broadcast("geolocation.updated")}},l.geolocation.on("change",l.changed_handler),l.geolocation.on("error",function(o){var e=document.getElementById("info");e.innerHTML=o.message,e.style.display=""}),l.geolocation.on("change:accuracyGeometry",function(){c.set("geometry",l.geolocation.accuracyGeometry)})}var l={following:!1,geolocation:null,toggleFeatures:function(e){var t=l.position_layer.getSource();e?(o.map.addLayer(l.position_layer),t.addFeature(c),t.addFeature(i),l.position_layer.setZIndex(99)):(t.removeFeature(c),t.removeFeature(i),o.map.removeLayer(l.position_layer))}},c=new ol.Feature,i=new ol.Feature;return e.$on("map.loaded",function(){n()}),l.style=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:[242,121,0,.7]}),stroke:new ol.style.Stroke({color:[187,51,51,.7]}),radius:5}),fill:new ol.style.Fill({color:[187,187,187,.2]}),stroke:new ol.style.Stroke({color:[102,102,0,.8]})}),c.setStyle(l.style),i.setStyle(l.style),l.position_layer=new ol.layer.Vector({title:"Position",show_in_manager:!1,source:new ol.source.Vector}),l}]).controller("hs.geolocation.controller",["$scope","hs.geolocation.service","hs.map.service","Core",function(o,e,t,a){o.speed=null,o.alt=null,o.altitudeAccuracy=null,o.accuracy=null,o.Geolocation=e,a.isMobile()?(o.switchGps=e.toggleGps,o.gpsActive=function(o){if(0===arguments.length)return e.gpsStatus;e.startGpsWatch(),console.log("Starting GPS.")}):o.gpsActive=function(o){if(0==arguments.length)return e.geolocation.getTracking();e.geolocation.setTracking(o)},o.getGeolocationProvider=function(){return e.geolocation},o.following=function(o){if(0==arguments.length)return e.following;e.following=o,console&&console.log(e.last_location),angular.isDefined(e.last_location)?(o&&t.map.getView().setCenter(e.last_location.latlng),a.isMobile()&&e.changed_handler()):console&&console.log("last location not defined")},o.setFeatureStyle=function(o){return e.style=o},o.$on("geolocation.updated",function(t){o.speed=e.speed,o.alt=e.altitude,o.accuracy=e.accuracy,o.altitudeAccuracy=e.altitudeAccuracy,o.$$phase||o.$digest()}),o.$on("geolocation.switched",function(t){e.gpsSwitch=e.gpsStatus?"Stop GPS":"Start GPS",o.$$phase||o.$digest()}),o.$emit("scope_loaded","Geolocation")}])});