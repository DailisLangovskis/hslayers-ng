define(["angular","app","permalink","ol"],function(angular,e,t,ol){angular.module("hs.map",["hs"]).service("hs.map.service",["config","$rootScope","hs.utils.service",function(e,t,n){function i(e){return new ol.View({center:e.getCenter(),zoom:e.getZoom(),projection:e.getProjection(),rotation:e.getRotation()})}var a;this.init=function(){function n(e){null!=a&&clearTimeout(a),a=setTimeout(function(){t.$broadcast("map.extent_changed",e.element,o.map.getView().calculateExtent(o.map.getSize()))},500)}o.map=new ol.Map({target:"map",interactions:[],view:i(e.default_view)}),o.map.getView().on("change:center",function(e){n(e)}),o.map.getView().on("change:resolution",function(e){n(e)}),o.map.on("moveend",function(e){n(e)}),angular.forEach(o.interactions,function(e,t){o.map.addInteraction(e)}),o.map.addControl(new ol.control.ScaleLine),t.$broadcast("map.loaded")},this.duration=400,this.interactions={DoubleClickZoom:new ol.interaction.DoubleClickZoom({duration:this.duration}),KeyboardPan:new ol.interaction.KeyboardPan({pixelDelta:256}),KeyboardZoom:new ol.interaction.KeyboardZoom({duration:this.duration}),MouseWheelZoom:new ol.interaction.MouseWheelZoom({duration:this.duration}),PinchRotate:new ol.interaction.PinchRotate,PinchZoom:new ol.interaction.PinchZoom({constrainResolution:!0,duration:this.duration}),DragPan:new ol.interaction.DragPan({kinetic:new ol.Kinetic(-.01,.1,200)}),DragZoom:new ol.interaction.DragZoom,DragRotate:new ol.interaction.DragRotate};new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),undefinedHTML:"&nbsp;"});var o=this;this.findLayerByTitle=function(e){var t=o.map.getLayers(),n=null;return angular.forEach(t,function(t){t.get("title")==e&&(n=t)}),n},this.repopulateLayers=function(t){angular.isDefined(e.box_layers)&&angular.forEach(e.box_layers,function(e){angular.forEach(e.get("layers"),function(e){e.setVisible(o.isLayerVisible(e,o.visible_layers)),e.manuallyAdded=!1,o.map.addLayer(e)})}),angular.isDefined(e.default_layers)&&angular.forEach(e.default_layers,function(e){e.setVisible(o.isLayerVisible(e,o.visible_layers)),e.manuallyAdded=!1,e.getSource()instanceof ol.source.ImageWMS&&o.proxifyLayerLoader(e,!1),o.map.addLayer(e)})},this.reset=function(){var e=[];for(o.map.getLayers().forEach(function(t){e.push(t)});e.length>0;)o.map.removeLayer(e.shift());o.repopulateLayers(null),o.resetView()},this.resetView=function(){o.map.setView(i(e.default_view))},this.isLayerVisible=function(e,t){if(t){var n=!1;return angular.forEach(t,function(t){t==e.get("title")&&(n=!0)}),n}return e.getVisible()},this.proxifyLayerLoader=function(e,t){var i=e.getSource();if(t){var a=i.getTileUrlFunction()||i.tileUrlFunction();i.setTileUrlFunction(function(e,t,i){return n.proxify(decodeURIComponent(a(e,t,i)))})}else e.getSource().setImageLoadFunction(function(e,t){e.getImage().src=n.proxify(t)})},this.puremap=function(){var e=this.map.getInteractions(),t=this.map.getControls();angular.forEach(e,function(e){o.map.removeInteraction(e)}),angular.forEach(t,function(e){o.map.removeControl(e)})},this.moveToAndZoom=function(e,t,n){var i=o.map.getView();i.setCenter([e,t]),i.setZoom(n)},this.getMap=function(){return OlMap.map}}]).directive("hs.map.directive",["Core",function(e){return{templateUrl:hsl_path+"components/map/partials/map.html?bust="+gitsha,link:function(e,t){$(".ol-zoomslider",t).width(28).height(200)}}}]).controller("hs.map.controller",["$scope","hs.map.service","config","hs.permalink.service_url","Core",function(e,t,n,i,a){t.map;e.setTargetDiv=function(e){t.map.setTarget(e)},e.findLayerByTitle=t.findLayerByTitle,e.showFeaturesWithAttrHideRest=function(e,t,n,i,a,o){},e.init=function(){t.init(),i.getParamValue("visible_layers")&&(t.visible_layers=i.getParamValue("visible_layers").split(";")),t.repopulateLayers(),hs_x=i.getParamValue("hs_x"),hs_y=i.getParamValue("hs_y"),hs_z=i.getParamValue("hs_z"),hs_x&&"NaN"!=hs_x&&hs_y&&"NaN"!=hs_y&&hs_z&&"NaN"!=hs_z&&t.moveToAndZoom(parseFloat(hs_x),parseFloat(hs_y),parseInt(hs_z)),i.getParamValue("permalink")&&i.parsePermalinkLayers(),i.getParamValue("puremap")&&(a.puremapApp=!0,t.puremap())},e.init(),e.$emit("scope_loaded","Map")}])});