define(["angular","app","permalink","ol"],function(angular,e,t,ol){ol.Feature.prototype.getLayer=function(e){var t,n=this,o=[],a=function(e){var t=e.getSource();if(t instanceof ol.source.Vector){var n=t.getFeatures();n.length>0&&o.push({layer:e,features:n})}};return e.getLayers().forEach(function(e){e instanceof ol.layer.Group?e.getLayers().forEach(a):a(e)}),o.forEach(function(e){e.features.some(function(e){return n===e})&&(t=e.layer)}),t},angular.module("hs.map",["hs"]).service("hs.map.service",["config","$rootScope","hs.utils.service","$timeout",function(e,t,n,o){function a(e){return new ol.View({center:e.getCenter(),zoom:e.getZoom(),projection:e.getProjection(),rotation:e.getRotation()})}function i(e){angular.forEach(e.getFeatures(),function(t){if(t.getGeometry())switch(t.getGeometry().getType()){case"LineString":case"MultiLineString":e.hasLine=!0;break;case"Polygon":case"MultiPolygon":e.hasPoly=!0;break;case"Point":case"MultiPoint":e.hasPoint=!0}}),(e.hasLine||e.hasPoly||e.hasPoint)&&(e.styleAble=!0)}var r;this.init=function(){function n(e){null!=r&&clearTimeout(r),r=setTimeout(function(){t.$broadcast("map.extent_changed",e.element,s.map.getView().calculateExtent(s.map.getSize()))},500)}s.map=new ol.Map({target:"map",interactions:[],view:a(e.default_view)}),s.visible=!0,s.map.getView().on("change:center",function(e){n(e)}),s.map.getView().on("change:resolution",function(e){n(e)}),s.map.on("moveend",function(e){n(e)}),angular.forEach(s.interactions,function(e,t){s.map.addInteraction(e)}),s.map.addControl(new ol.control.ScaleLine),s.repopulateLayers(),t.$broadcast("map.loaded")},this.duration=400,this.interactions={DoubleClickZoom:new ol.interaction.DoubleClickZoom({duration:this.duration}),KeyboardPan:new ol.interaction.KeyboardPan({pixelDelta:256}),KeyboardZoom:new ol.interaction.KeyboardZoom({duration:this.duration}),MouseWheelZoom:new ol.interaction.MouseWheelZoom({duration:this.duration}),PinchRotate:new ol.interaction.PinchRotate,PinchZoom:new ol.interaction.PinchZoom({constrainResolution:!0,duration:this.duration}),DragPan:new ol.interaction.DragPan({kinetic:new ol.Kinetic(-.01,.1,200)}),DragZoom:new ol.interaction.DragZoom,DragRotate:new ol.interaction.DragRotate};new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),undefinedHTML:"&nbsp;"});var s=this;this.findLayerByTitle=function(e){var t=s.map.getLayers(),n=null;return angular.forEach(t,function(t){t.get("title")==e&&(n=t)}),n},this.repopulateLayers=function(t){angular.isDefined(e.box_layers)&&angular.forEach(e.box_layers,function(e){angular.forEach(e.get("layers"),function(e){e.setVisible(s.isLayerVisible(e,s.visible_layers)),e.manuallyAdded=!1,e.getSource()instanceof ol.source.Vector&&s.getVectorType(e),s.map.addLayer(e)})}),angular.isDefined(e.default_layers)&&angular.forEach(e.default_layers,function(e){e.setVisible(s.isLayerVisible(e,s.visible_layers)),e.manuallyAdded=!1,e.getSource()instanceof ol.source.ImageWMS&&s.proxifyLayerLoader(e,!1),e.getSource()instanceof ol.source.TileWMS&&s.proxifyLayerLoader(e,!0),e.getSource()instanceof ol.source.Vector&&s.getVectorType(e),s.map.addLayer(e)})},this.getVectorType=function(e){var t=e.getSource();t.hasLine=!1,t.hasPoly=!1,t.hasPoint=!1,t.getFeatures().length>0?i(t):t.on("change",function(e){var t=e.target;"ready"===t.getState()&&i(t)})},this.reset=function(){var e=[];for(s.map.getLayers().forEach(function(t){e.push(t)});e.length>0;)s.map.removeLayer(e.shift());s.repopulateLayers(null),s.resetView()},this.resetView=function(){s.map.setView(a(e.default_view))},this.isLayerVisible=function(e,t){if(t){var n=!1;return angular.forEach(t,function(t){t==e.get("title")&&(n=!0)}),n}return e.getVisible()},this.proxifyLayerLoader=function(e,t){var o=e.getSource();if(t){var a=o.getTileUrlFunction()||o.tileUrlFunction();o.setTileUrlFunction(function(e,t,o){var i=a(e,t,o);return-1==i.indexOf("proxy")&&(i=decodeURIComponent(i)),n.proxify(i)})}else e.getSource().setImageLoadFunction(function(e,t){e.getImage().src=n.proxify(t)})},this.puremap=function(){var e=s.map.getInteractions(),t=s.map.getControls();angular.forEach(e,function(e){s.map.removeInteraction(e)}),angular.forEach(t,function(e){s.map.removeControl(e)}),o(s.puremap,1e3)},this.moveToAndZoom=function(e,t,n){var o=s.map.getView();o.setCenter([e,t]),o.setZoom(n)},this.getMap=function(){return OlMap.map}}]).directive("hs.map.directive",["Core","$compile",function(e,t){return{templateUrl:hsl_path+"components/map/partials/map.html?bust="+gitsha,link:function(e,n,o){$(".ol-zoomslider",n).width(28).height(200),void 0===o.ngShow&&(o.$set("ng-show","hs_map.visible"),t(n)(e))}}}]).controller("hs.map.controller",["$scope","hs.map.service","config","hs.permalink.service_url","Core","$rootScope",function(e,t,n,o,a,i){function r(e){var t=0;e=Math.abs(e);for(var n=156543.03390625;e<n;)if(n/=2,t++,e>n)return t;return t}t.map;e.setTargetDiv=function(e){t.map.setTarget(e)},e.findLayerByTitle=t.findLayerByTitle,e.hs_map=t,e.showFeaturesWithAttrHideRest=function(e,t,n,o,a,i){},e.init=function(){o.getParamValue("visible_layers")&&(t.visible_layers=o.getParamValue("visible_layers").split(";")),t.init(),hs_x=o.getParamValue("hs_x"),hs_y=o.getParamValue("hs_y"),hs_z=o.getParamValue("hs_z"),hs_x&&"NaN"!=hs_x&&hs_y&&"NaN"!=hs_y&&hs_z&&"NaN"!=hs_z&&t.moveToAndZoom(parseFloat(hs_x),parseFloat(hs_y),parseInt(hs_z)),o.getParamValue("permalink")&&o.parsePermalinkLayers(),o.getParamValue("puremap")&&(a.puremapApp=!0,t.puremap())},i.$on("map.sync_center",function(e,n){if(!angular.isUndefined(n)&&null!=n){var o=ol.proj.transform([n[0],n[1]],"EPSG:4326",t.map.getView().getProjection());t.moveToAndZoom(o[0],o[1],r(n[2]))}}),e.init(),e.$emit("scope_loaded","Map")}])});