define(["angular","ol","map","permalink","styles"],function(angular,ol){angular.module("hs.search",["hs.map","hs.styles"]).directive("hs.search.directiveSearchinput",["$window",function(e){return{templateUrl:hsl_path+"components/search/partials/searchinput.html?bust="+gitsha,replace:!0,link:function(e,r){}}}]).directive("hs.search.directiveSearchresults",["$window",function(e){return{templateUrl:hsl_path+"components/search/partials/searchresults.html?bust="+gitsha,replace:!0,link:function(e,r){}}}]).service("hs.search.service",["$http","hs.utils.service","config","hs.map.service","hs.styles.service","$rootScope",function(e,r,s,t,a,i){function o(e){return"geonames"==e.provider_name?ol.proj.transform([parseFloat(e.lng),parseFloat(e.lat)],"EPSG:4326",t.map.getView().getProjection()):"sdi4apps_openapi"==e.provider_name?l.readFeature(e.FullGeom.toUpperCase()).getGeometry().transform("EPSG:4326",t.map.getView().getProjection()).getCoordinates():void 0}function n(e,r){r.results=e.geonames,c(r)}function c(e){var r=d.searchResultsLayer.getSource();angular.forEach(e.results,function(s){s.provider_name=e.name;var t=new ol.Feature({geometry:new ol.geom.Point(o(s)),record:s});r.addFeature(t),s.feature=t})}function u(e,r){r.results=e.data,h(r)}function h(e){var r=d.searchResultsLayer.getSource();angular.forEach(e.results,function(s){l.readFeature(s.FullGeom.toUpperCase());s.provider_name=e.name;var t=new ol.Feature({geometry:new ol.geom.Point(o(s)),record:s});r.addFeature(t),s.feature=t})}this.data={},this.data.providers={};var l=new ol.format.WKT;this.searchResultsLayer=new ol.layer.Vector({title:"Search results",source:new ol.source.Vector({}),style:a.pin_white_blue_highlight,show_in_manager:!1}),this.xhr={},this.request=function(e){var t=null,a=[];angular.isUndefined(s.search_provider)?a=["geonames"]:"string"==typeof s.search_provider?a=[s.search_provider]:angular.isObject(s.search_provider)&&(a=s.search_provider),d.cleanResults(),angular.forEach(a,function(s){"geonames"==s?t="http://api.geonames.org/searchJSON?&username=raitis&name_startsWith="+e:"sdi4apps_openapi"==s&&(t="http://portal.sdi4apps.eu/openapi/search?q="+e),t=r.proxify(t),angular.isDefined(d.xhr[s])&&null!==d.xhr[s]&&d.xhr[s].abort(),d.xhr[s]=$.ajax({url:t,cache:!1,provider:s,success:function(e){d.searchResultsReceived(e,this.provider),d.xhr[this.provider]=null}})})},this.searchResultsReceived=function(e,r){angular.isUndefined(d.data.providers[r])&&(d.data.providers[r]={results:[],name:r}),provider=d.data.providers[r],"geonames"==r?n(e,provider):"sdi4apps_openapi"==r&&u(e,provider),i.$broadcast("search.resultsReceived",{layer:d.searchResultsLayer,providers:d.data.providers})},this.hideResultsLayer=function(){t.map.removeLayer(d.searchResultsLayer)},this.showResultsLayer=function(){d.hideResultsLayer(),t.map.addLayer(d.searchResultsLayer)},this.cleanResults=function(){angular.forEach(d.data.providers,function(e){e.results.length=0}),d.searchResultsLayer.getSource().clear(),d.hideResultsLayer()},this.selectResult=function(e,r){var s=o(e);t.map.getView().setCenter(s),angular.isUndefined(r)&&(r=10),t.map.getView().setZoom(r),i.$broadcast("search.zoom_to_center",{coordinate:ol.proj.transform(s,t.map.getView().getProjection(),"EPSG:4326"),zoom:r})};var d=this}]).controller("hs.search.controller",["$scope","Core","hs.search.service","hs.permalink.service_url",function(e,r,s,t){e.data=s.data,e.init=function(){e.query="",e.clearvisible=!1,t.getParamValue("search")&&(e.query=t.getParamValue("search"),r.searchVisible(!0),e.queryChanged())},e.queryChanged=function(){s.request(e.query)},e.zoomTo=function(r){e.fcode_zoom_map={PPLA:12,PPL:15,PPLC:10,ADM1:9,FRM:15,PPLF:13,LCTY:13,RSTN:15,PPLA3:9,AIRP:13,AIRF:13,HTL:17,STM:14,LK:13};var t=10;angular.isDefined(r.fcode)&&angular.isDefined(e.fcode_zoom_map[r.fcode])&&(t=e.fcode_zoom_map[r.fcode]),s.selectResult(r,t),e.clear()},e.clear=function(){e.query="",e.clearvisible=!1,s.cleanResults()},e.searchResultsReceived=function(r){$("#searchresults").show(),e.clearvisible=!0,s.showResultsLayer(),e.$$phase||e.$digest()},e.highlightResult=function(e,r){angular.isDefined(e.feature)&&e.feature.set("highlighted",r)},e.init(),e.$on("search.resultsReceived",function(r,s){e.searchResultsReceived(s)}),e.$watch('Core.panelVisible("search")',function(e,r){e!==r&&e&&setTimeout(function(){$("#search_address").focus()},500)}),e.$emit("scope_loaded","Search")}])});