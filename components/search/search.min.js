define(["angular","ol","map","permalink","styles"],function(angular,ol){angular.module("hs.search",["hs.map","hs.styles"]).directive("hs.search.directiveSearchinput",["$window",function(e){return{templateUrl:hsl_path+"components/search/partials/searchinput.html?bust="+gitsha,replace:!0,link:function(e,r){}}}]).directive("hs.search.directiveSearchresults",["$window",function(e){return{templateUrl:hsl_path+"components/search/partials/searchresults.html?bust="+gitsha,replace:!0,link:function(e,r){}}}]).service("hs.search.service",["$http","hs.utils.service","config",function(e,r,s){this.xhr={},this.request=function(e){var t=null,o=[];angular.isUndefined(s.search_provider)?o=["geonames"]:"string"==typeof s.search_provider?o=[s.search_provider]:angular.isObject(s.search_provider)&&(o=s.search_provider),angular.forEach(o,function(s){"geonames"==s?t="http://api.geonames.org/searchJSON?&username=raitis&name_startsWith="+e:"sdi4apps_openapi"==s&&(t="http://portal.sdi4apps.eu/openapi/search?q="+e),t=r.proxify(t),angular.isDefined(a.xhr[s])&&null!==a.xhr[s]&&a.xhr[s].abort(),a.xhr[s]=$.ajax({url:t,cache:!1,provider:s,success:function(e){a.searchResultsReceived(e,this.provider),a.xhr[this.provider]=null}})})};var a=this}]).controller("hs.search.controller",["$scope","Core","hs.map.service","hs.search.service","$log","hs.permalink.service_url","hs.styles.service","config",function(e,r,s,a,t,o,i,n){function c(e,r){r.results=e.geonames,l(r)}function l(r){var s=e.search_results_layer.getSource();angular.forEach(r.results,function(e){e.provider_name=r.name;var a=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([parseFloat(e.lng),parseFloat(e.lat)],"EPSG:4326",p.getView().getProjection())),record:e});s.addFeature(a),e.feature=a})}function u(e,r){r.results=e.data,h(r)}function h(r){angular.forEach(r.results,function(s){var a=f.readFeature(s.FullGeom.toUpperCase()),t=e.search_results_layer.getSource();s.provider_name=r.name;var o=new ol.Feature({geometry:a.getGeometry().transform("EPSG:4326",p.getView().getProjection()),record:s});t.addFeature(o),s.feature=o})}var p,d=new ol.geom.Point([0,0]),f=new ol.format.WKT;e.providers={},angular.isDefined(s.map)?p=s.map:e.$on("map.loaded",function(){p=s.map}),e.search_results_layer=null,e.init=function(){e.query="",e.results=[],e.clearvisible=!1,o.getParamValue("search")&&(e.query=o.getParamValue("search"),r.searchVisible(!0),e.queryChanged())},e.queryChanged=function(){a.request(e.query),$("#searchresults").show()},e.zoomTo=function(r){if(e.fcode_zoom_map={PPLA:12,PPL:15,PPLC:10,ADM1:9,FRM:15,PPLF:13,LCTY:13,RSTN:15,PPLA3:9,AIRP:13,AIRF:13,HTL:17,STM:14,LK:13},e.createCurrentPointLayer(),"geonames"==r.provider_name)coordinate=ol.proj.transform([parseFloat(r.lng),parseFloat(r.lat)],"EPSG:4326",p.getView().getProjection());else if("sdi4apps_openapi"==r.provider_name){var s=f.readFeature(r.FullGeom.toUpperCase());coordinate=s.getGeometry().transform("EPSG:4326",p.getView().getProjection()).getCoordinates()}d.setCoordinates(coordinate,"XY"),p.getView().setCenter(coordinate),angular.isDefined(r.fcode)&&angular.isDefined(e.fcode_zoom_map[r.fcode])?p.getView().setZoom(e.fcode_zoom_map[r.fcode]):p.getView().setZoom(10),e.clear()},e.clear=function(){angular.forEach(e.providers,function(e){e.results=[]}),e.query="",e.clearvisible=!1,e.search_results_layer&&p.getLayers().remove(e.search_results_layer),e.search_results_layer=null},a.searchResultsReceived=function(r,s){$("#searchresults").show(),e.clearvisible=!0,e.createCurrentPointLayer(),angular.isUndefined(e.providers[s])&&(e.providers[s]={results:[],name:s}),provider=e.providers[s],"geonames"==s?c(r,provider):"sdi4apps_openapi"==s&&u(r,provider),e.$$phase||e.$digest()},e.createCurrentPointLayer=function(){e.search_results_layer&&(e.search_results_layer.getSource().clear(),p.removeLayer(e.search_results_layer)),e.search_results_layer=new ol.layer.Vector({title:"Search results",source:new ol.source.Vector({}),style:i.pin_white_blue_highlight,show_in_manager:!1}),angular.forEach(e.providers,function(e){"geonames"==e.name?l(e):"sdi4apps_openapi"==e.name&&h(e)}),p.addLayer(e.search_results_layer)},e.highlightResult=function(e,r){angular.isDefined(e.feature)&&e.feature.set("highlighted",r)},e.init(),e.$on("search.results_received",function(r,s){e.searchResultsReceived(s)}),e.$watch('Core.panelVisible("search")',function(e,r){e!==r&&e&&setTimeout(function(){$("#search_address").focus()},500)}),e.$emit("scope_loaded","Search")}])});