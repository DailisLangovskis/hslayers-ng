define(["angular","ol","map","core","ngfocusif"],function(angular,ol){angular.module("hs.trip_planner",["hs.map","hs.core","focus-if"]).directive("hs.tripPlanner.directive",function(){return{templateUrl:hsl_path+"components/trip_planner/partials/trip_planner.html?bust="+gitsha}}).service("hs.trip_planner.service",["Core","hs.map.service","hs.utils.service","$http","hs.permalink.service_url",function(e,t,o,n,a){var r={waypoints:[],scopes:[],digestScopes:function(){angular.forEach(r.scopes,function(e){e.$$phase||e.$digest()})},loadWaypoints:function(e){$("meta[property=og\\:title]").attr("content","test");var t="SELECT * FROM <http://www.sdi4apps.eu/trips.rdf> WHERE {"+("<http://www.sdi4apps.eu/trips.rdf#"+e+">")+" ?p ?o}";$.ajax({url:"//data.plan4all.eu/sparql?default-graph-uri=&query="+encodeURIComponent(t)+"&should-sponge=&format=application%2Fsparql-results%2Bjson&timeout=0&debug=on"}).done(function(e){angular.forEach(e.results.bindings,function(e){"http://www.sdi4apps.eu/trips.rdf#waypoints"==e.p.value&&(r.waypoints=JSON.parse(e.o.value))}),r.calculateRoutes()})},addWaypoint:function(e,t){null==a.getParamValue("trip")&&(r.trip=o.generateUuid(),a.push("trip",r.trip),a.update());var n={lon:e,lat:t,name:"Waypoint "+(r.waypoints.length+1),hash:("Waypoint "+r.waypoints.length+Math.random()).hashCode().toString(),routes:[]};angular.forEach(r.scopes,function(e){angular.isDefined(e.waypointAdded)&&e.waypointAdded(n)}),r.waypoints.push(n),r.storeWaypoints(),r.calculateRoutes(),r.digestScopes()},storeWaypoints:function(){if(null!=a.getParamValue("trip_editable")){var e=[];angular.forEach(r.waypoints,function(t){e.push({name:t.name,lon:t.lon,lat:t.lat,routes:[]})});var t="<http://www.sdi4apps.eu/trips.rdf#"+r.trip+">",o="WITH <http://www.sdi4apps.eu/trips.rdf> DELETE {?t ?p ?s} INSERT {"+t+' <http://www.sdi4apps.eu/trips.rdf#waypoints> "'+JSON.stringify(e).replace(/"/g,'\\"')+'"} WHERE {?t ?p ?s. FILTER(?t = '+t+"). }";$.ajax({type:"POST",data:{query:o},url:"//data.plan4all.eu/sparql?default-graph-uri=&should-sponge=&format=application%2Fsparql-results%2Bjson&timeout=0&debug=on"}).done(function(e){console.log(e)})}},removeWaypoint:function(e){var t=r.waypoints.indexOf(e)-1;t>-1&&r.waypoints[t].routes.length>0&&(angular.forEach(r.waypoints[t].routes,function(e){angular.forEach(r.scopes,function(t){angular.isDefined(t.routeRemoved)&&t.routeRemoved(e)})}),r.waypoints[t].routes=[]),angular.forEach(r.scopes,function(t){angular.forEach(e.routes,function(e){angular.isDefined(t.routeRemoved)&&t.routeRemoved(e)}),t.waypointRemoved(e)}),r.waypoints.splice(r.waypoints.indexOf(e),1),r.storeWaypoints(),r.calculateRoutes(),r.digestScopes()},calculateRoutes:function(){for(var e=0;e<r.waypoints.length-1;e++){var n=r.waypoints[e],a=r.waypoints[e+1];0==n.routes.length&&(a.loading=!0,$.ajax({method:"GET",url:o.proxify("http://www.yournavigation.org/api/1.0/gosmore.php?flat="+n.lat+"&flon="+n.lon+"&tlat="+a.lat+"&tlon="+a.lon+"&format=geojson"),cache:!1,i:e}).done(function(e){var o=r.waypoints[this.i+1],n=r.waypoints[this.i];o.loading=!1;var a=(new ol.format.GeoJSON).readFeatures({type:"Feature",geometry:e,properties:e.properties},{dataProjection:e.crs.name,featureProjection:t.map.getView().getProjection().getCode()});n.routes.push(a[0]),angular.forEach(r.scopes,function(e){angular.isDefined(e.routeAdded)&&e.routeAdded(a)}),r.digestScopes()}))}}};return null!=a.getParamValue("trip")&&(r.trip=a.getParamValue("trip"),r.loadWaypoints(r.trip),a.push("trip",r.trip)),r}]).directive("hs.tripPlanner.toolbarButtonDirective",function(){return{templateUrl:hsl_path+"components/trip_planner/partials/toolbar_button_directive.html?bust="+gitsha}}).controller("hs.trip_planner.controller",["$scope","hs.map.service","Core","hs.trip_planner.service","config",function(e,t,o,n,a){function r(t){angular.forEach(t.routes,function(t){e.routeRemoved(t)}),t.routes=[]}t.map;e.ajax_loader=hsl_path+"img/ajax-loader.gif";var i=new ol.source.Vector({}),s=new ol.layer.Vector({source:i,style:function(e,t){return[new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.6)"}),stroke:new ol.style.Stroke({color:"#337AB7",width:3}),image:new ol.style.Icon({src:e.get("highlighted")?hsl_path+"img/pin_white_red32.png":hsl_path+"img/pin_white_blue32.png",crossOrigin:"anonymous",anchor:[.5,1]})})]},title:"Travel route"}),p=new ol.Collection,l=new ol.interaction.Modify({features:p});angular.isUndefined(t.map)?e.$on("map.loaded",function(){t.map.addLayer(s)}):(console&&console.log("add trip layer"),t.map.addLayer(s)),angular.isUndefined(a.default_layers)&&(a.default_layers=[]),a.default_layers.push(s),e.service=n,n.scopes.push(e);var u;e.waypointAdded=function(e){var o=new ol.Feature({geometry:new ol.geom.Point(ol.proj.transform([e.lon,e.lat],"EPSG:4326",t.map.getView().getProjection().getCode())),wp:e});e.feature=o,i.addFeature(o),p.push(o),o.on("change",function(e){this.get("wp").routes.length>0&&r(this.get("wp"));var a=ol.proj.transform(o.getGeometry().getCoordinates(),t.map.getView().getProjection().getCode(),"EPSG:4326");this.get("wp").lon=a[0],this.get("wp").lat=a[1];var i=n.waypoints.indexOf(this.get("wp"))-1;i>-1&&n.waypoints[i].routes.length>0&&r(n.waypoints[i]),null!=u&&clearTimeout(u),u=setTimeout(function(){n.calculateRoutes()},500)},o)},e.clearAll=function(){e.service.waypoints=[],i.clear(),e.$$phase||e.$digest()},t.map.addInteraction(l),e.routeAdded=function(e){i.addFeatures(e)},e.routeRemoved=function(e){try{i.removeFeature(e)}catch(e){}},e.waypointRemoved=function(e){try{i.removeFeature(e.feature)}catch(e){}},e.formatDistance=function(e){if(e.routes.length<1)return"";var t=e.routes[0].get("distance");return void 0===t?"":parseFloat(t).toFixed(2)+"km"},e.totalDistance=function(){var t=0;return angular.forEach(e.service.waypoints,function(e){e.routes.length>0&&(t+=parseFloat(e.routes[0].get("distance")))}),t.toFixed(2)+"km"},e.toggleEdit=function(t,o){t.name_editing=!t.name_editing,e.service.storeWaypoints(),t.feature.set("highlighted",t.name_editing)},e.prevPanel=function(){o.setMainPanel("info")},e.$on("core.mainpanel_changed",function(e){}),e.$emit("scope_loaded","Trip planner")}])});