define(["angular","ol","WfsSource","WFSCapabilities","utils"],function(angular,ol,e,t){var r=function(e,t){for(i=0;i<t.length;i++)if(e.indexOf(t[i])>-1)return t[i];return e[0]},s=function(e){if(!e)return null;var t=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return e.replace(t,"<a href='$1'>$1</a>")};angular.module("hs.ows.wfs",["hs.utils"]).directive("hs.ows.wfs.capabilitiesErrorDirective",function(){return{templateUrl:hsl_path+"components/ows/partials/dialog_getcapabilities_error.html?bust="+gitsha,link:function(e,t,r){$("#ows-wfs-capabilities-error").modal("show")}}}).service("hs.ows.wfs.service_capabilities",["$http","hs.map.service","hs.utils.service","$rootScope",function(e,t,r,i){var s=this;this.getPathFromUrl=function(e){return e.indexOf("?")>-1?e.substring(0,e.indexOf("?")):e},this.params2String=function(e){return e?Object.keys(e).map(function(t){var r=e[t];return Array.isArray(r)?r.map(function(e){return encodeURIComponent(t)+"="+encodeURIComponent(e)}).join("&"):encodeURIComponent(t)+"="+encodeURIComponent(r)}).join("&"):""},this.requestGetCapabilities=function(t){t=t.replace("&amp;","&"),s.service_url=t;var o=r.getParamsFromUrl(t),n=this.getPathFromUrl(t);angular.isUndefined(o.request)&&angular.isUndefined(o.REQUEST)?o.request="GetCapabilities":angular.isDefined(o.request)?o.request="GetCapabilities":angular.isDefined(o.REQUEST)&&(o.REQUEST="GetCapabilities"),angular.isUndefined(o.service)&&angular.isUndefined(o.SERVICE)&&(o.service="WFS"),angular.isUndefined(o.version)&&angular.isUndefined(o.VERSION)&&(o.version="1.1.0");var a=[n,s.params2String(o)].join("?");a=r.proxify(a);var c=e.get(a);return c.then(function(e){i.$broadcast("ows_wfs.capabilities_received",e)}),c},this.currentProjectionSupported=function(e){var r=!1;return angular.forEach(e,function(e){e.toUpperCase().indexOf(t.map.getView().getProjection().getCode().toUpperCase().replace("EPSG:","EPSG::"))>-1&&(r=!0)}),r},this.getUrl=function(e,t){return void 0!==t&&t?"/cgi-bin/proxy4ows.cgi?OWSURL="+encodeURIComponent(e)+"&owsService=WMS":e}}]).controller("hs.ows.wfs.controller",["$scope","hs.map.service","hs.ows.wfs.service_capabilities","Core","$compile","$rootScope",function(i,o,n,a,c,p){i.map_projection=o.map.getView().getProjection().getCode().toUpperCase(),i.$on("ows_wfs.capabilities_received",function(e,a){try{caps=new t(a.data),i.title=caps.ServiceIdentification.Title,i.description=s(caps.ServiceIdentification.Abstract),i.version=caps.Version||caps.version,i.output_formats=caps.FeatureTypeList.FeatureType[0].OutputFormats,i.srss=[caps.FeatureTypeList.FeatureType[0].DefaultCRS],angular.forEach(caps.FeatureTypeList.FeatureType[0].OtherCRS,function(e){i.srss.push(e)}),i.srss.indexOf("CRS:84")>-1&&i.srss.splice(i.srss.indexOf("CRS:84"),1),n.currentProjectionSupported(i.srss)?i.srs=i.srss.indexOf(o.map.getView().getProjection().getCode())>-1?o.map.getView().getProjection().getCode():o.map.getView().getProjection().getCode().toLowerCase():i.srss.indexOf("EPSG::4326")>-1?i.srs="EPSG:4326":i.srs=i.srss[0],i.services=caps.FeatureTypeList.FeatureType,console.log(i.services),angular.forEach(caps.OperationsMetadata.Operation,function(e){switch(e.name){case"DescribeFeatureType":i.describeFeatureType=e.DCP[0].HTTP.Get;break;case"GetFeature":i.getFeature=e.DCP[0].HTTP.Get}}),i.output_format=r(i.output_formats,["text/xml; subtype=gml/3.2.1"])}catch(e){console&&console.log(e),i.error=e.toString(),$("#hs-dialog-area #ows-wfs-capabilities-error").remove();var p=angular.element("<div hs.ows.wfs.capabilities_error_directive></span>");$("#hs-dialog-area").append(p),c(p)(i)}}),i.selectAllLayers=function(){var e=function(t){t.checked=!0,angular.forEach(t.Layer,function(t){e(t)})};angular.forEach(i.services.Layer,function(t){e(t)})},i.tryAddLayers=function(e){i.add_all=e,i.addLayers(e)},i.addLayers=function(e){var t=function(r){e&&!r.checked||u(r,r.Title.replace(/\//g,"&#47;"),i.folder_name,i.output_format,i.srs),angular.forEach(r.Layer,function(e){t(e)})};angular.forEach(i.services,function(e){t(e)}),a.setMainPanel("layermanager")};var u=function(t,r,s,a,c){console&&console.log(t);var p=n.service_url.split("?")[0],u={};u.url=p,u.format="hs.format.WFS";var f=new ol.layer.Vector({title:r,definition:u,source:new e({url:p,typename:t.Name,projection:c,version:i.version,format:new ol.format.WFS})});o.map.addLayer(f)}}])});