define(["angular","ol","utils"],function(angular,ol){var e=function(e,a){for(i=0;i<a.length;i++)if(e.indexOf(a[i])>-1)return a[i];return e[0]},a=function(e){if(!e)return null;var a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return e.replace(a,"<a href='$1'>$1</a>")};angular.module("hs.ows.wms",["hs.utils"]).directive("hs.ows.wms.resampleDialogDirective",function(){return{templateUrl:hsl_path+"components/ows/partials/dialog_proxyconfirm.html?bust="+gitsha,link:function(e,a,t){$("#ows-wms-resample-dialog").modal("show")}}}).directive("hs.ows.wms.capabilitiesErrorDirective",function(){return{templateUrl:hsl_path+"components/ows/partials/dialog_getcapabilities_error.html?bust="+gitsha,link:function(e,a,t){$("#ows-wms-capabilities-error").modal("show")}}}).service("hs.ows.wms.service_capabilities",["$http","hs.map.service","hs.utils.service","$rootScope",function(a,t,i,r){var s=this;this.getPathFromUrl=function(e){return e.indexOf("?")>-1?e.substring(0,e.indexOf("?")):e},this.params2String=function(e){return e?Object.keys(e).map(function(a){var t=e[a];return Array.isArray(t)?t.map(function(e){return encodeURIComponent(a)+"="+encodeURIComponent(e)}).join("&"):encodeURIComponent(a)+"="+encodeURIComponent(t)}).join("&"):""},this.requestGetCapabilities=function(e){e=e.replace("&amp;","&");var t=i.getParamsFromUrl(e),n=this.getPathFromUrl(e);angular.isUndefined(t.request)&&angular.isUndefined(t.REQUEST)?t.request="GetCapabilities":angular.isDefined(t.request)?t.request="GetCapabilities":angular.isDefined(t.REQUEST)&&(t.REQUEST="GetCapabilities"),angular.isUndefined(t.service)&&angular.isUndefined(t.SERVICE)&&(t.service="WMS"),angular.isUndefined(t.version)&&angular.isUndefined(t.VERSION)&&(t.version="1.3.0");var o=[n,s.params2String(t)].join("?");o=i.proxify(o);var c=a.get(o);return c.then(function(e){r.$broadcast("ows.capabilities_received",e)}),c},this.service2layers=function(a){var i=(new ol.format.WMSCapabilities).read(a),r=i.Capability.Layer,s=(i.Capability.Layer.CRS,i.Capability.Request.GetMap.Format),n=i.Capability.Request.GetFeatureInfo?i.Capability.Request.GetFeatureInfo.Format:[],o=e(s,["image/png; mode=8bit","image/png","image/gif","image/jpeg"]),c=e(n,["application/vnd.esri.wms_featureinfo_xml","application/vnd.ogc.gml","application/vnd.ogc.wms_xml","text/plain","text/html"]),l=[];return $(r).each(function(){console&&console.log("Load service",this),$(this.Layer).each(function(){layer=this,console&&console.log("Load service",this);var e=[];layer.Attribution&&(e=[new ol.Attribution({html:'<a href="'+layer.Attribution.OnlineResource+'">'+layer.Attribution.Title+"</a>"})]);var a=new ol.layer.Tile({title:layer.Title.replace(/\//g,"&#47;"),source:new ol.source.TileWMS({url:i.Capability.Request.GetMap.DCPType[0].HTTP.Get.OnlineResource,attributions:e,styles:layer.Style&&layer.Style.length>0?layer.Style[0].Name:void 0,params:{LAYERS:layer.Name,INFO_FORMAT:layer.queryable?c:void 0,FORMAT:o},crossOrigin:"anonymous"}),abstract:layer.Abstract,useInterimTilesOnError:!1,MetadataURL:layer.MetadataURL,BoundingBox:layer.BoundingBox});t.proxifyLayerLoader(a,!0),l.push(a)})}),l},this.getUrl=function(e,a){return void 0!==a&&a?"/cgi-bin/proxy4ows.cgi?OWSURL="+encodeURIComponent(e)+"&owsService=WMS":e},this.currentProjectionSupported=function(e){var a=!1;return angular.forEach(e,function(e){t.map.getView().getProjection().getCode().toUpperCase()==e.toUpperCase()&&(a=!0)}),a}}]).service("hs.ows.wms.service_layer_producer",["hs.map.service","hs.ows.wms.service_capabilities",function(e,a){this.addService=function(t,i){a.requestGetCapabilities(t).then(function(t){var r=a.service2layers(t);$(r).each(function(){void 0!==i&&i.get("layers").push(this),e.map.addLayer(this)})})}}]).service("hs.ows.wms.addLayerService",["$rootScope","hs.map.service","hs.ows.wms.service_capabilities","Core",function(t,i,r,s){function n(e,a,t,s,n,c,l,d){var p=[];e.Attribution&&(p=[new ol.Attribution({html:'<a href="'+e.Attribution.OnlineResource+'">'+e.Attribution.Title+"</a>"})]);var u=ol.layer.Tile,m=ol.source.TileWMS;o.data.use_tiles||(u=ol.layer.Image,m=ol.source.ImageWMS);var f=e.BoundingBox;angular.isDefined(d)?(tmpbox=e.EX_GeographicBoundingBox,angular.isDefined(e.EX_GeographicBoundingBox)&&(f=e.EX_GeographicBoundingBox)):o.data.map_projection!=srs&&(f=e.LatLonBoundingBox);var g={};angular.forEach(e.Dimension,function(e){g[e.name]=e});var y=[];e.Style&&e.Style[0].LegendURL&&y.push(e.Style[0].LegendURL[0].OnlineResource);var h=new u({title:a,source:new m({url:r.getUrl(o.data.getMapUrl,!r.currentProjectionSupported(o.data.srss)),attributions:p,projection:o.data.crs||o.data.srs,styles:e.Style&&e.Style.length>0?e.Style[0].Name:void 0,params:{LAYERS:e.Name,INFO_FORMAT:e.queryable?n:void 0,FORMAT:o.data.image_format,FROMCRS:o.data.srs,VERSION:o.data.version},crossOrigin:"anonymous"}),minResolution:e.MinScaleDenominator,maxResolution:e.MaxScaleDenominator,saveState:!0,removable:!0,abstract:e.Abstract,MetadataURL:e.MetadataURL,BoundingBox:f,path:o.data.path,dimensions:g,legends:y});i.proxifyLayerLoader(h,o.data.use_tiles),i.map.addLayer(h)}var o=this;return this.data={useResampling:!1,useTiles:!0,mapProjection:void 0,registerMetadata:!0,tileSize:512},this.capabilitiesReceived=function(s){try{var n=(new ol.format.WMSCapabilities).read(s);o.data.mapProjection=i.map.getView().getProjection().getCode().toUpperCase(),o.data.title=n.Service.Title,o.data.description=a(n.Service.Abstract),o.data.version=n.Version||n.version,o.data.image_formats=n.Capability.Request.GetMap.Format,o.data.query_formats=n.Capability.Request.GetFeatureInfo?n.Capability.Request.GetFeatureInfo.Format:[],o.data.exceptions=n.Capability.Exception,o.data.srss=[],angular.isDefined(n.Capability.Layer.CRS)?o.data.srss=n.Capability.Layer.CRS:$("Capability>Layer>SRS",s).each(function(){o.data.srss.push(this.innerHTML)}),o.data.srss.indexOf("CRS:84")>-1&&o.data.srss.splice(o.data.srss.indexOf("CRS:84"),1),r.currentProjectionSupported(o.data.srss)?o.data.srs=o.data.srss.indexOf(i.map.getView().getProjection().getCode())>-1?i.map.getView().getProjection().getCode():i.map.getView().getProjection().getCode().toLowerCase():o.data.srss.indexOf("EPSG:4326")>-1?o.data.srs="EPSG:4326":o.data.srs=o.data.srss[0],o.srsChanged(),o.data.services=n.Capability.Layer,o.data.getMapUrl=n.Capability.Request.GetMap.DCPType[0].HTTP.Get.OnlineResource,o.data.image_format=e(o.data.image_formats,["image/png; mode=8bit","image/png","image/gif","image/jpeg"]),o.data.query_format=e(o.data.query_formats,["application/vnd.esri.wms_featureinfo_xml","application/vnd.ogc.gml","application/vnd.ogc.wms_xml","text/plain","text/html"]),t.$broadcast("wmsCapsParsed")}catch(e){t.$broadcast("wmsCapsParseError",e)}},t.$on("ows.capabilities_received",function(e,a){o.capabilitiesReceived(a.data)}),o.srsChanged=function(){o.data.resample_warning=!r.currentProjectionSupported([o.data.srs]),t.$$phase||t.$digest()},o.addLayers=function(e){var a=function(t){e&&!t.checked||void 0!==t.Layer||n(t,t.Title.replace(/\//g,"&#47;"),o.data.folder_name,o.data.image_format,o.data.query_format,o.data.single_tile,o.data.tile_size,o.data.srs),angular.forEach(t.Layer,function(e){a(e)})};angular.forEach(o.data.services.Layer,function(e){a(e)}),s.setMainPanel("layermanager")},o}]).controller("hs.ows.wms.controller",["$scope","hs.map.service","Core","hs.ows.wms.addLayerService",function(e,a,t,i){e.data=i.data,e.selectAllLayers=function(){var a=function(e){e.checked=!0,angular.forEach(e.Layer,function(e){a(e)})};angular.forEach(e.data.services.Layer,function(e){a(e)})},e.addLayers=function(e){i.addLayers(e)},e.srsChanged=function(){i.srsChanged()},e.hasNestedLayers=function(e){return void 0!==e.Layer}}])});