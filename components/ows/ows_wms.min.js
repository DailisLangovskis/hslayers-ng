define(["angular","ol","utils"],function(angular,ol){var e=function(e,t){for(i=0;i<t.length;i++)if(e.indexOf(t[i])>-1)return t[i];return e[0]},t=function(e){if(!e)return null;var i=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return e.replace(i,"<a href='$1'>$1</a>")};angular.module("hs.ows.wms",["hs.utils"]).directive("hs.ows.wms.resampleDialogDirective",function(){return{templateUrl:hsl_path+"components/ows/partials/dialog_proxyconfirm.html?bust="+gitsha,link:function(e,i,t){$("#ows-wms-resample-dialog").modal("show")}}}).directive("hs.ows.wms.capabilitiesErrorDirective",function(){return{templateUrl:hsl_path+"components/ows/partials/dialog_getcapabilities_error.html?bust="+gitsha,link:function(e,i,t){$("#ows-wms-capabilities-error").modal("show")}}}).service("hs.ows.wms.service_capabilities",["$http","hs.map.service","hs.utils.service","$rootScope",function(i,t,r,a){var s=this;this.getPathFromUrl=function(e){return e.indexOf("?")>-1?e.substring(0,e.indexOf("?")):e},this.params2String=function(e){return e?Object.keys(e).map(function(i){var t=e[i];return Array.isArray(t)?t.map(function(e){return encodeURIComponent(i)+"="+encodeURIComponent(e)}).join("&"):encodeURIComponent(i)+"="+encodeURIComponent(t)}).join("&"):""},this.requestGetCapabilities=function(e){e=e.replace("&amp;","&");var t=r.getParamsFromUrl(e),o=this.getPathFromUrl(e);angular.isUndefined(t.request)&&angular.isUndefined(t.REQUEST)?t.request="GetCapabilities":angular.isDefined(t.request)?t.request="GetCapabilities":angular.isDefined(t.REQUEST)&&(t.REQUEST="GetCapabilities"),angular.isUndefined(t.service)&&angular.isUndefined(t.SERVICE)&&(t.service="WMS"),angular.isUndefined(t.version)&&angular.isUndefined(t.VERSION)&&(t.version="1.3.0");var n=[o,s.params2String(t)].join("?");n=r.proxify(n);var l=i.get(n);return l.then(function(e){a.$broadcast("ows.capabilities_received",e)}),l},this.service2layers=function(i){var r=(new ol.format.WMSCapabilities).read(i),a=r.Capability.Layer,s=(r.Capability.Layer.CRS,r.Capability.Request.GetMap.Format),o=r.Capability.Request.GetFeatureInfo?r.Capability.Request.GetFeatureInfo.Format:[],n=e(s,["image/png; mode=8bit","image/png","image/gif","image/jpeg"]),l=e(o,["application/vnd.esri.wms_featureinfo_xml","application/vnd.ogc.gml","application/vnd.ogc.wms_xml","text/plain","text/html"]),c=[];return $(a).each(function(){console&&console.log("Load service",this),$(this.Layer).each(function(){layer=this,console&&console.log("Load service",this);var e=[];layer.Attribution&&(e=[new ol.Attribution({html:'<a href="'+layer.Attribution.OnlineResource+'">'+layer.Attribution.Title+"</a>"})]);var i=new ol.layer.Tile({title:layer.Title.replace(/\//g,"&#47;"),source:new ol.source.TileWMS({url:r.Capability.Request.GetMap.DCPType[0].HTTP.Get.OnlineResource,attributions:e,styles:layer.Style&&layer.Style.length>0?layer.Style[0].Name:void 0,params:{LAYERS:layer.Name,INFO_FORMAT:layer.queryable?l:void 0,FORMAT:n},crossOrigin:"anonymous"}),abstract:layer.Abstract,useInterimTilesOnError:!1,MetadataURL:layer.MetadataURL,BoundingBox:layer.BoundingBox});t.proxifyLayerLoader(i,!0),c.push(i)})}),c},this.getUrl=function(e,i){return void 0!==i&&i?"/cgi-bin/proxy4ows.cgi?OWSURL="+encodeURIComponent(e)+"&owsService=WMS":e},this.currentProjectionSupported=function(e){var i=!1;return angular.forEach(e,function(e){t.map.getView().getProjection().getCode().toUpperCase()==e.toUpperCase()&&(i=!0)}),i}}]).service("hs.ows.wms.service_layer_producer",["hs.map.service","hs.ows.wms.service_capabilities",function(e,i){this.addService=function(t,r){i.requestGetCapabilities(t).then(function(t){var a=i.service2layers(t);$(a).each(function(){void 0!==r&&r.get("layers").push(this),e.map.addLayer(this)})})}}]).controller("hs.ows.wms.controller",["$scope","hs.map.service","hs.ows.wms.service_capabilities","Core","$compile","$rootScope","hs.utils.service","$timeout",function(i,r,a,s,o,n,l,c){i.use_resampling=!1,i.utils=l,i.use_tiles=!0,i.map_projection=r.map.getView().getProjection().getCode().toUpperCase(),i.register_metadata=!0,i.capabilitiesReceived=function(s){try{var n=new ol.format.WMSCapabilities;i.capabilities=n.read(s);var l=i.capabilities;i.title=l.Service.Title,i.description=t(l.Service.Abstract),i.version=l.Version||l.version,i.image_formats=l.Capability.Request.GetMap.Format,i.query_formats=l.Capability.Request.GetFeatureInfo?l.Capability.Request.GetFeatureInfo.Format:[],i.exceptions=l.Capability.Exception,i.srss=[],angular.isDefined(l.Capability.Layer.CRS)?i.srss=l.Capability.Layer.CRS:$("Capability>Layer>SRS",s).each(function(){i.srss.push(this.innerHTML)}),i.srss.indexOf("CRS:84")>-1&&i.srss.splice(i.srss.indexOf("CRS:84"),1),a.currentProjectionSupported(i.srss)?i.srs=i.srss.indexOf(r.map.getView().getProjection().getCode())>-1?r.map.getView().getProjection().getCode():r.map.getView().getProjection().getCode().toLowerCase():i.srss.indexOf("EPSG:4326")>-1?i.srs="EPSG:4326":i.srs=i.srss[0],i.srsChanged(),i.services=l.Capability.Layer,i.getMapUrl=l.Capability.Request.GetMap.DCPType[0].HTTP.Get.OnlineResource,i.image_format=e(i.image_formats,["image/png; mode=8bit","image/png","image/gif","image/jpeg"]),i.query_format=e(i.query_formats,["application/vnd.esri.wms_featureinfo_xml","application/vnd.ogc.gml","application/vnd.ogc.wms_xml","text/plain","text/html"])}catch(e){console&&console.log(e),i.error=e.toString(),$("#hs-dialog-area #ows-wms-capabilities-error").remove();var c=angular.element("<div hs.ows.wms.capabilities_error_directive></span>");$("#hs-dialog-area").append(c),o(c)(i)}},i.$on("ows.capabilities_received",function(e,t){i.capabilitiesReceived(t.data)}),i.srsChanged=function(){i.resample_warning=!a.currentProjectionSupported(i.srss)},i.selectAllLayers=function(){var e=function(i){i.checked=!0,angular.forEach(i.Layer,function(i){e(i)})};angular.forEach(i.services.Layer,function(i){e(i)})},i.tryAddLayers=function(e){return i.add_all=e,void i.addLayers(e)},i.addLayers=function(e){var t=function(r){e&&!r.checked||void 0!==r.Layer||p(r,r.Title.replace(/\//g,"&#47;"),i.folder_name,i.image_format,i.query_format,i.single_tile,i.tile_size,i.srs),angular.forEach(r.Layer,function(e){t(e)})};angular.forEach(i.services.Layer,function(e){t(e)}),s.setMainPanel("layermanager")};var p=function(e,t,s,o,n,l,c,p){console&&console.log(e);var u=[];e.Attribution&&(u=[new ol.Attribution({html:'<a href="'+e.Attribution.OnlineResource+'">'+e.Attribution.Title+"</a>"})]);var m=ol.layer.Tile,d=ol.source.TileWMS;i.use_tiles||(m=ol.layer.Image,d=ol.source.ImageWMS);var g=e.BoundingBox;angular.isDefined(p)?(tmpbox=e.EX_GeographicBoundingBox,angular.isDefined(e.EX_GeographicBoundingBox)&&(g=e.EX_GeographicBoundingBox)):i.map_projection!=srs&&(g=e.LatLonBoundingBox);var f={};angular.forEach(e.Dimension,function(e){f[e.name]=e});var y=[];e.Style&&e.Style[0].LegendURL&&y.push(e.Style[0].LegendURL[0].OnlineResource);var h=new m({title:t,source:new d({url:a.getUrl(i.getMapUrl,!a.currentProjectionSupported(i.srss)),attributions:u,projection:i.crs||i.srs,styles:e.Style&&e.Style.length>0?e.Style[0].Name:void 0,params:{LAYERS:e.Name,INFO_FORMAT:e.queryable?n:void 0,FORMAT:i.image_format,FROMCRS:i.srs,VERSION:i.version},crossOrigin:"anonymous"}),minResolution:e.MinScaleDenominator,maxResolution:e.MaxScaleDenominator,saveState:!0,removable:!0,abstract:e.Abstract,MetadataURL:e.MetadataURL,BoundingBox:g,path:i.path,dimensions:f,legends:y});r.proxifyLayerLoader(h,i.use_tiles),r.map.addLayer(h)};i.hasNestedLayers=function(e){return void 0!==e.Layer}}])});