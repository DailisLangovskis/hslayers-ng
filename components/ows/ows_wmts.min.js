define(["angular","ol","utils"],function(angular,ol){var e=function(e,t){for(i=0;i<t.length;i++)if(e.indexOf(t[i])>-1)return t[i];return e[0]},t=function(e){if(!e)return null;var t=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return e.replace(t,"<a href='$1'>$1</a>")};angular.module("hs.ows.wmts",["hs.utils"]).directive("hs.ows.wmts.resampleDialogDirective",function(){return{templateUrl:hsl_path+"components/ows/partials/dialog_proxyconfirm.html?bust="+gitsha,link:function(e,t,i){$("#ows-wmts-resample-dialog").modal("show")}}}).directive("hs.ows.wmts.capabilitiesErrorDirective",function(){return{templateUrl:hsl_path+"components/ows/partials/dialog_getcapabilities_error.html?bust="+gitsha,link:function(e,t,i){$("#ows-wmts-capabilities-error").modal("show")}}}).service("hs.ows.wmts.service_capabilities",["$http","hs.map.service","hs.utils.service",function(t,i,r){var a=this;this.getPathFromUrl=function(e){return e.indexOf("?")>-1?e.substring(0,e.indexOf("?")):e},this.params2String=function(e){return e?Object.keys(e).map(function(t){var i=e[t];return Array.isArray(i)?i.map(function(e){return encodeURIComponent(t)+"="+encodeURIComponent(e)}).join("&"):encodeURIComponent(t)+"="+encodeURIComponent(i)}).join("&"):""},this.requestGetCapabilities=function(e){e=e.replace("&amp;","&");var i=r.getParamsFromUrl(e),n=this.getPathFromUrl(e);angular.isUndefined(i.request)&&angular.isUndefined(i.REQUEST)?i.request="GetCapabilities":angular.isDefined(i.request)?i.request="GetCapabilities":angular.isDefined(i.REQUEST)&&(i.REQUEST="GetCapabilities"),angular.isUndefined(i.service)&&angular.isUndefined(i.SERVICE)&&(i.service="wmts"),angular.isUndefined(i.version)&&angular.isUndefined(i.VERSION)&&(i.version="1.3.0");var s=[n,a.params2String(i)].join("?");s=r.proxify(s);var o=t.get(s);return o.then(function(e){$rootScope.$broadcast("ows_wmts.capabilities_received",e)}),o},this.service2layers=function(t){var i=(new ol.format.wmtsCapabilities).read(t),r=i.Capability.Layer,a=(i.Capability.Layer.CRS,i.Capability.Request.GetMap.Format),n=i.Capability.Request.GetFeatureInfo?i.Capability.Request.GetFeatureInfo.Format:[],s=e(a,["image/png; mode=8bit","image/png","image/gif","image/jpeg"]),o=e(n,["application/vnd.esri.wmts_featureinfo_xml","application/vnd.ogc.gml","application/vnd.ogc.wmts_xml","text/plain","text/html"]),l=[];return $(r).each(function(){console&&console.log("Load service",this),$(this.Layer).each(function(){layer=this;var e=[];layer.Attribution&&(e=[new ol.Attribution({html:'<a href="'+layer.Attribution.OnlineResource+'">'+layer.Attribution.Title+"</a>"})]);var t=new ol.layer.Tile({title:layer.Title.replace(/\//g,"&#47;"),source:new ol.source.Tilewmts({url:i.Capability.Request.GetMap.DCPType[0].HTTP.Get.OnlineResource,attributions:e,styles:layer.Style&&layer.Style.length>0?layer.Style[0].Name:void 0,params:{LAYERS:layer.Name,INFO_FORMAT:layer.queryable?o:void 0,FORMAT:s},crossOrigin:"anonymous"}),abstract:layer.Abstract,useInterimTilesOnError:!1,MetadataURL:layer.MetadataURL,BoundingBox:layer.BoundingBox});l.push(t)})}),l},this.getUrl=function(e,t){return void 0!==t&&t?"/cgi-bin/proxy4ows.cgi?OWSURL="+encodeURIComponent(e)+"&owsService=wmts":e},this.currentProjectionSupported=function(e){var t=!1;return angular.forEach(e,function(e){i.map.getView().getProjection().getCode().toUpperCase()==e.toUpperCase()&&(t=!0)}),t}}]).service("hs.ows.wmts.service_layer_producer",["hs.map.service","hs.ows.wmts.service_capabilities",function(e,t){this.addService=function(i,r){t.requestGetCapabilities(i,function(i){var a=t.service2layers(i);$(a).each(function(){void 0!==r&&r.get("layers").push(this),e.map.addLayer(this)})})}}]).controller("hs.ows.wmts.controller",["$scope","hs.map.service","hs.ows.wmts.service_capabilities","Core","$compile","$rootScope",function(e,i,r,a,n,s){e.map_projection=i.map.getView().getProjection().getCode().toUpperCase(),e.style="",e.tileMatrixSet="",e.image_format="",e.capabilitiesReceived=function(i){try{var r=new ol.format.WMTSCapabilities;e.capabilities=r.read(i);var a=e.capabilities;e.title=a.ServiceIdentification.Title,e.tileURL=a.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href;for(var s=0;s<a.OperationsMetadata.GetTile.DCP.HTTP.Get.length;s++)if("KVP"==a.OperationsMetadata.GetTile.DCP.HTTP.Get[s].Constraint[0].AllowedValues.Value[0]){e.tileURL=a.OperationsMetadata.GetTile.DCP.HTTP.Get[s].href;break}e.description=t(a.ServiceIdentification.Abstract),e.version=a.Version||a.version,e.services=a.Contents}catch(t){console&&console.log(t),e.error=t.toString(),$("#hs-dialog-area #ows-wmts-capabilities-error").remove();var o=angular.element("<div hs.ows.wmts.capabilities_error_directive></span>");$("#hs-dialog-area").append(o),n(o)(e)}},e.$on("ows_wmts.capabilities_received",function(t,i){e.capabilitiesReceived(i.data)}),e.setCurrentLayer=function(t,i){return e.currentlayer==t?e.currentlayer=null:(e.currentlayer=t,$(".wmtslayerpanel").insertAfter($("#wmtslayer-"+i))),!1},e.addLayer=function(t){for(var r=ol.proj.get(e.map_projection),a=r.getExtent(),n=0;n<e.services.TileMatrixSet.length;n++)e.services.TileMatrixSet[n].Identifier==e.tileMatrixSet&&(e.layerTileMatrix=e.services.TileMatrixSet[n]);for(var s=ol.extent.getWidth(a)/e.layerTileMatrix.TileMatrix[0].TileWidth,o=new Array(e.layerTileMatrix.TileMatrix.length),l=new Array(e.layerTileMatrix.TileMatrix.length),c=0;c<e.layerTileMatrix.TileMatrix.length;++c)o[c]=s/Math.pow(2,c),l[c]=c;var p={};angular.forEach(t.Dimension,function(e){p[e.name]=e});var u=new ol.layer.Tile({title:t.Title,source:new ol.source.WMTS({url:e.tileURL,layer:t.Identifier,projection:r,matrixSet:"EPSG:3857",format:e.image_format,tileGrid:new ol.tilegrid.WMTS({origin:ol.extent.getTopLeft(a),resolutions:o,matrixIds:l}),style:e.style,wrapX:!0}),saveState:!0,removable:!0,dimensions:p});i.map.addLayer(u)}}])});