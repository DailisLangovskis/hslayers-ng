define(["angular","ol","SparqlJson","WfsSource","styles"],function(angular,ol,e,t){angular.module("hs.ows.nonwms",["hs.styles"]).service("hs.ows.nonwms.service",["config","$rootScope","hs.map.service","hs.styles.service","hs.utils.service","$http",function(a,o,r,s,n,i){me=this,me.add=function(a,s,i,c,l,m,f){var d,u,p={};if(p.url=s,angular.isUndefined(f))var f={};switch("sparql"!=a.toLowerCase()&&angular.isDefined(s)&&(s=n.proxify(s)),a.toLowerCase()){case"kml":d=new ol.format.KML({extractStyles:l}),p.format="ol.format.KML";break;case"gpx":d=new ol.format.GPX,p.format="ol.format.GPX";break;case"geojson":d=new ol.format.GeoJSON,p.format="ol.format.GeoJSON";break;case"wfs":p.format="hs.format.WFS";break;case"sparql":p.format="hs.format.Sparql"}"hs.format.Sparql"==p.format?u=new e({geom_attribute:"?geom",url:s,category_field:"http://www.openvoc.eu/poi#categoryWaze",projection:"EPSG:3857",minResolution:1,maxResolution:38}):"hs.format.WFS"==p.format?u=new t(f.defOptions):angular.isDefined(f.features)?((u=new ol.source.Vector({projection:m,features:f.features})).hasLine=!1,u.hasPoly=!1,u.hasPoint=!1,angular.forEach(u.getFeatures(),function(e){if(e.getGeometry())switch(e.getGeometry().getType()){case"LineString":u.hasLine=!0;break;case"Polygon":u.hasPoly=!0;break;case"Point":u.hasPoint=!0}}),(u.hasLine||u.hasPoly||u.hasPoint)&&(u.styleAble=!0),r.map.getView().fit(u.getExtent(),r.map.getSize())):u=new ol.source.Vector({format:d,url:s,projection:ol.proj.get(m),extractStyles:l,loader:function(e,t,a){this.set("loaded",!1),$.ajax({url:s,context:this,success:function(e){"GeometryCollection"==e.type&&(e={type:"Feature",geometry:e}),this.addFeatures(d.readFeatures(e,{dataProjection:m,featureProjection:r.map.getView().getProjection().getCode()})),u.hasLine=!1,u.hasPoly=!1,u.hasPoint=!1,angular.forEach(u.getFeatures(),function(e){if(e.getGeometry())switch(e.getGeometry().getType()){case"LineString":u.hasLine=!0;break;case"Polygon":u.hasPoly=!0;break;case"Point":u.hasPoint=!0}}),(u.hasLine||u.hasPoly||u.hasPoint)&&(u.styleAble=!0),this.set("loaded",!0)},error:function(e,t,a){this.error=!0,this.errorMessage=e.status,this.set("loaded",!0)}})},strategy:ol.loadingstrategy.all}),u.set("loaded",!0),u.set("from_composition",f.from_composition||!1);var h=new ol.layer.Vector({abstract:c,definition:p,from_composition:f.from_composition||!1,opacity:f.opacity||1,saveState:!0,source:u,style:f.style,title:i}),g=(u.on("propertychange",function(e){"loaded"==e.key&&(0==e.oldValue?o.$broadcast("layermanager.layer_loaded",h):o.$broadcast("layermanager.layer_loading",h))}),u.on("change",function(){if("ready"==u.getState()&&(angular.isUndefined(u.get("from_composition"))||!u.get("from_composition"))){if(0==u.getFeatures().length)return;var e=u.getExtent();u.unByKey(g),isNaN(e[0])||isNaN(e[1])||isNaN(e[2])||isNaN(e[3])||r.map.getView().fit(e,r.map.getSize())}}));return 1!=f.from_composition&&r.map.addLayer(h),h};var c=new ol.interaction.DragAndDrop({formatConstructors:[ol.format.GPX,ol.format.GeoJSON,ol.format.IGC,ol.format.KML,ol.format.TopoJSON]});o.$on("map.loaded",function(){r.map.addInteraction(c)}),c.on("addfeatures",function(e){var t=new ol.format.GeoJSON,o="";try{o=(a.hostname.user?a.hostname.user.url:a.hostname.status_manager?a.hostname.status_manager.url:a.hostname.default.url)+(a.status_manager_url||"/wwwlibs/statusmanager2/index.php")}catch(e){}console&&console.info(o,a);var s={};s.features=e.features,i({url:o,method:"POST",data:JSON.stringify({project:a.project_name,title:e.file.name,request:"saveData",dataType:"json",data:t.writeFeatures(e.features,{dataProjection:"EPSG:4326",featureProjection:r.map.getView().getProjection().getCode()})})}).success(function(t){data={},data.url=o+"?request=loadData&id="+t.id,console&&console.info(data.url,t),data.title=e.file.name,data.projection=e.projection;me.add("geojson",decodeURIComponent(data.url),data.title||"Layer","",!0,data.projection,s)}).error(function(t){console&&console.warn(t),data={},data.title=e.file.name,data.projection=e.projection;me.add("geojson",void 0,data.title||"Layer","",!0,data.projection,s)})})}]).controller("hs.ows.nonwms.controller",["$scope","hs.map.service","hs.styles.service","hs.ows.nonwms.service","Core",function(e,t,a,o,r){e.srs="EPSG:3857",e.title="",e.extract_styles=!1,e.add=function(){o.add(e.type,e.url,e.title,e.abstract,e.extract_styles,e.srs),r.setMainPanel("layermanager")}}])});