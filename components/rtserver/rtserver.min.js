define(["angular","ol","socketio","utils","map"],function(angular,ol,e){angular.module("hs.rtserver",["hs.map","hs.utils"]).service("hs.rtserver.service",["hs.utils.service","$rootScope","hs.map.service","hs.compositions.service_parser",function(a,t,r,n){function o(e,a){d.socket.emit("sync",s(e.name,a))}function s(e,a){return{sender:d.uuid,event:e,data:a}}var i=r.map;this.init=function(){d.uuid=a.generateUuid();var s=e("localhost:3000");s.on("connect",function(){d.socket=s}),s.on("sync",function(e){switch(e.event){case"feature_drawn":var a=(new ol.format.GeoJSON).readFeatures(e.data.features);(o=r.findLayerByTitle(e.data.layer)).getSource().addFeatures(a),angular.forEach(a,function(e){e.setId(e.get("hs_id"))});break;case"feature_deleted":new ol.format.GeoJSON;var o=r.findLayerByTitle(e.data.layer);o.getSource().removeFeature(o.getSource().getFeatureById(e.data.feature_id));break;case"layer_added":i.addLayer(n.jsonToLayer(e.data.layer)),t.$$phase||t.$digest()}}),s.on("disconnect",function(){}),t.$on("feature_drawn",o),t.$on("feature_deleted",o),t.$on("layer_added",o)};var d=this}])});