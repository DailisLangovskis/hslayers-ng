define(["angular","ol","SparqlJson","angularjs-socialshare","map","ows.nonwms"],function(angular,ol,e,t){angular.module("hs.compositions.config_parsers",["720kb.socialshare","hs.map","hs.core","hs.ows.nonwms"]).service("hs.compositions.config_parsers.service",["hs.map.service","config","Core","$rootScope","hs.utils.service","hs.ows.nonwms.service",function(t,i,o,r,a,s){var n={createWmsLayer:function(e){var i=e.singleTile?ol.source.ImageWMS:ol.source.TileWMS,o=e.singleTile?ol.layer.Image:ol.layer.Tile,r=e.params,a=[];if(delete r.REQUEST,delete r.FORMAT,angular.isDefined(e.legends))for(var s=0;s<e.legends.length;s++)a.push(decodeURIComponent(e.legends[s]));var n=new o({title:e.title,from_composition:!0,maxResolution:e.maxResolution||Number.Infinity,minResolution:e.minResolution||0,minScale:e.minScale||Number.Infinity,maxScale:e.maxScale||0,show_in_manager:e.displayInLayerSwitcher,abstract:e.name,metadata:e.metadata,dimensions:e.dimensions,legends:a,saveState:!0,path:e.path,opacity:e.opacity||1,source:new i({url:decodeURIComponent(e.url),attributions:e.attribution?[new ol.Attribution({html:'<a href="'+e.attribution.OnlineResource+'">'+e.attribution.Title+"</a>"})]:void 0,styles:e.metadata.styles,params:r,crossOrigin:"anonymous",projection:e.projection,ratio:e.ratio})});return n.setVisible(e.visibility),t.proxifyLayerLoader(n,!e.singleTile),n},createSparqlLayer:function(t){var i=decodeURIComponent(t.protocol.url),o={};o.url=i,o.format="hs.format.Sparql";var r=null;angular.isDefined(t.style)&&(r=n.parseStyle(t.style));var a=new e({geom_attribute:"?geom",url:i,category_field:"http://www.openvoc.eu/poi#categoryWaze",projection:"EPSG:3857"});new ol.layer.Vector({from_composition:!0,definition:o,source:a,opacity:t.opacity||1,style:r,title:t.title}).setVisible(t.visibility)},parseStyle:function(e){var t={};if(angular.isDefined(e.fill)&&(t.fill=new ol.style.Fill({color:e.fill})),angular.isDefined(e.stroke)&&(t.stroke=new ol.style.Stroke({color:e.stroke.color,width:e.stroke.width})),angular.isDefined(e.image)){if("circle"==e.image.type){var i={};angular.isDefined(e.image.radius)&&(i.radius=e.image.radius),angular.isDefined(e.image.fill)&&(i.fill=new ol.style.Fill({color:e.image.fill})),angular.isDefined(e.image.stroke)&&(i.stroke=new ol.style.Stroke({color:e.image.stroke.color,width:e.image.stroke.width})),t.image=new ol.style.Circle(i)}if("icon"==e.image.type){var o=new Image;o.src=e.image.src,0==o.width&&(o.width=43),0==o.height&&(o.height=41);var r={img:o,imgSize:[o.width,o.height],crossOrigin:"anonymous"};t.image=new ol.style.Icon(r)}}return new ol.style.Style(t)},createVectorLayer:function(e){o="";angular.isDefined(e.protocol)&&(o=e.protocol.format);var t={};t.opacity=e.opacity||1,t.from_composition=!0;var i=!0;switch(angular.isDefined(e.style)&&(t.style=n.parseStyle(e.style),i=!1),o){case"ol.format.KML":return l=s.add("kml",decodeURIComponent(e.protocol.url),e.title||"Layer",e.abstract,i,e.projection.toUpperCase(),t);case"ol.format.GeoJSON":return l=s.add("geojson",decodeURIComponent(e.protocol.url),e.title||"Layer",e.abstract,i,e.projection.toUpperCase(),t);case"hs.format.WFS":return t.defOptions=e.defOptions,l=s.add("wfs",decodeURIComponent(e.protocol.url),e.title||"Layer",e.abstract,i,e.projection.toUpperCase(),t);case"hs.format.Sparql":return n.createSparqlLayer(e);default:if(angular.isDefined(e.features))var o=new ol.format.GeoJSON,r=new ol.source.Vector({features:o.readFeatures(e.features),projection:ol.proj.get(e.projection)});var a=void 0;angular.isDefined(e.style)&&(a=n.parseStyle(e.style));var l=new ol.layer.Vector({from_composition:!0,source:r,opacity:e.opacity||1,title:e.title,style:a});return l.setVisible(e.visibility),l}}};return n}])});