define(["angular","ol","SparqlJson","angularjs-socialshare","map","ows.nonwms","config_parsers"],function(angular,ol,o,e){angular.module("hs.compositions",["720kb.socialshare","hs.map","hs.core","hs.ows.nonwms","hs.compositions.config_parsers"]).directive("hs.compositions.directive",function(){return{templateUrl:hsl_path+"components/compositions/partials/compositions.html?bust="+gitsha,link:function(o,e){$(".mid-pane").css("margin-top","0px"),$(".keywords-panel").hide()}}}).directive("hs.compositions.overwriteDialogDirective",function(){return{templateUrl:hsl_path+"components/compositions/partials/dialog_overwriteconfirm.html?bust="+gitsha,link:function(o,e,t){$("#composition-overwrite-dialog").modal("show")}}}).directive("hs.compositions.deleteDialogDirective",function(){return{templateUrl:hsl_path+"components/compositions/partials/dialog_delete.html?bust="+gitsha,link:function(o,e,t){$("#composition-delete-dialog").modal("show")}}}).directive("hs.compositions.shareDialogDirective",function(){return{templateUrl:hsl_path+"components/compositions/partials/dialog_share.html?bust="+gitsha,link:function(o,e,t){$("#composition-share-dialog").modal("show")}}}).directive("hs.compositions.infoDialogDirective",function(){return{templateUrl:hsl_path+"components/compositions/partials/dialog_info.html?bust="+gitsha,link:function(o,e,t){$("#composition-info-dialog").modal("show")}}}).service("hs.compositions.service_parser",["hs.map.service","config","Core","$rootScope","hs.utils.service","hs.ows.nonwms.service","hs.compositions.config_parsers.service",function(o,e,t,i,a,n,s){var r={composition_loaded:null,composition_edited:!1,utils:a,current_composition_title:"",load:function(n,s,l,c){r.current_composition_url=n,n=n.replace("&amp;","&"),n=a.proxify(n),$.ajax({url:n}).done(function(a){if(1==a.success){r.composition_loaded=n,void 0!==c&&(a=c(a)),i.$broadcast("compositions.composition_loading",a),(angular.isUndefined(s)||1==s)&&r.removeCompositionLayers(),r.current_composition=a.data||a,r.current_composition_title=a.title||a.data.title,o.map.getView().fit(r.parseExtent(a.extent||a.data.extent),o.map.getSize());for(var m=r.jsonToLayers(a),d=0;d<m.length;d++)o.map.addLayer(m[d]);angular.isObject(a.data.current_base_layer)&&o.map.getLayers().forEach(function(o){o.get("title")==a.data.current_base_layer.title&&o.setVisible(!0)}),e.open_lm_after_comp_loaded&&t.setMainPanel("layermanager"),r.composition_edited=!1,i.$broadcast("compositions.composition_loaded",a),void 0!==l&&null!==l&&l()}else{var p={};switch(p.error=a.error,a.error){case"no data":p.title="Composition not found",p.abstract="Sorry but composition was deleted or incorrectly saved"}i.$broadcast("compositions.composition_loaded",p)}})},removeCompositionLayers:function(){var e=[];for(o.map.getLayers().forEach(function(o){o.get("from_composition")&&e.push(o)});e.length>0;)o.map.removeLayer(e.shift())},loadInfo:function(o){var e={};return o=o.replace("&amp;","&"),o=a.proxify(o),$.ajax({url:o,async:!1}).done(function(o){e=o.data||o,i.$broadcast("compositions.composition_info_loaded",o)}),e},parseExtent:function(e){"string"==typeof e&&(e=e.split(" "));var t=[parseFloat(e[0]),parseFloat(e[1])],i=[parseFloat(e[2]),parseFloat(e[3])];return t=ol.proj.transform(t,"EPSG:4326",o.map.getView().getProjection()),i=ol.proj.transform(i,"EPSG:4326",o.map.getView().getProjection()),[t[0],t[1],i[0],i[1]]},jsonToLayers:function(o){var e=[];o.data&&(o=o.data);for(var t=0;t<o.layers.length;t++){var i=o.layers[t];e.push(r.jsonToLayer(i))}return e}};return r.jsonToLayer=function(o){switch(o.className){case"HSLayers.Layer.WMS":return s.createWmsLayer(o);case"OpenLayers.Layer.Vector":return s.createVectorLayer(o)}},r}]).service("hs.compositions.service",["$rootScope","$location","$http","hs.map.service","Core","hs.compositions.service_parser","config","hs.permalink.service_url","$compile","$cookies","hs.utils.service",function(o,e,t,i,a,n,s,r,l,c,m){function d(o){var e={bbox:'[{"property":"bbox","direction":"ASC"}]',title:'[{"property":"title","direction":"ASC"}]',date:'[{"property":"date","direction":"ASC"}]'};return encodeURIComponent(e[o])}function p(){a.openStatusCreator()}function u(){if(g=new ol.layer.Vector({title:"Composition extents",show_in_manager:!1,source:new ol.source.Vector,removable:!1,style:function(o,e){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#005CB6",width:o.get("highlighted")?4:1}),fill:new ol.style.Fill({color:"rgba(0, 0, 255, 0.01)"})})]}}),i.map.on("pointermove",function(e){var t=g.getSource().getFeaturesAtCoordinate(e.coordinate),i=!1;angular.forEach(g.getSource().getFeatures(),function(o){o.get("record").highlighted&&(o.get("record").highlighted=!1,i=!0)}),t.length&&angular.forEach(t,function(o){o.get("record").highlighted||(o.get("record").highlighted=!0,i=!0)}),i&&!o.$$phase&&o.$digest()}),angular.isDefined(c.get("hs_layers"))&&1!=window.permalinkApp){for(var e=c.get("hs_layers"),t=n.jsonToLayers(JSON.parse(e)),a=0;a<t.length;a++)i.map.addLayer(t[a]);c.remove("hs_layers")}if(i.map.addLayer(g),r.getParamValue("composition")){var l=r.getParamValue("composition");-1==l.indexOf("http")&&-1==l.indexOf(s.status_manager_url)&&(l=(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+(s.status_manager_url||"/wwwlibs/statusmanager2/index.php")+"?request=load&id="+l),n.load(l)}}var h=this;h.data={},h.data.start=0,h.data.limit=20,h.data.next=20,h.data.useCallbackForEdit=!1;var g,f;return h.loadCompositions=function(e){angular.isUndefined(e.sortBy)&&(e.sortBy="bbox"),angular.isUndefined(e.start)&&(e.start=h.data.start),angular.isUndefined(e.limit)&&(e.limit=h.data.limit);var t=i.map.getSize(),a=angular.isDefined(t)?i.map.getView().calculateExtent(t):[0,0,100,100],r=ol.proj.transformExtent(a,i.map.getView().getProjection(),"EPSG:4326");if(angular.isDefined(s.compositions_catalogue_url)){g.getSource().clear();var l=e.query,c=l&&angular.isDefined(l.title)&&""!=l.title?encodeURIComponent(" AND title like '*"+l.title+"*' OR abstract like '*"+l.title+"*'"):"",d="",p=[];angular.forEach(e.keywords,function(o,e){o&&p.push("subject='"+e+"'")}),p.length>0&&(d=encodeURIComponent(" AND ("+p.join(" OR ")+")"));var u=s.compositions_catalogue_url.indexOf("cswClientRun.php")>0?",":" ",_=s.compositions_catalogue_url.indexOf("cswClientRun.php")>0?"serviceName=p4b&":"",v=e.filterExtent?encodeURIComponent(" and BBOX='"+r.join(u)+"'"):"",y=(s.hostname.user?s.hostname.user.url:s.hostname.compositions_catalogue?s.hostname.compositions_catalogue.url:s.hostname.default.url)+s.compositions_catalogue_url+"?format=json&"+_+"query=type%3Dapplication"+v+c+d+"&lang=eng&sortBy="+e.sortBy+"&detail=summary&start="+e.start+"&limit="+e.limit;y=m.proxify(y),null!=f&&f.abort(),f=$.ajax({url:y}).done(function(t){f=null,h.data.compositions=t.records,t.records&&t.records.length>0?h.data.compositionsCount=t.matched:h.data.compositionsCount=0,h.data.next=t.next,angular.forEach(h.data.compositions,function(o){var e={record:o,hs_notqueryable:!0,highlighted:!1};o.editable=!1,angular.isUndefined(o.thumbnail)&&(o.thumbnail=(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+s.status_manager_url+"?request=loadthumb&id="+o.id);var t=n.parseExtent(o.bbox);if(!(t[0]<a[0]&&t[2]>a[2]||t[1]<a[1]&&t[3]>a[3])){e.geometry=ol.geom.Polygon.fromExtent(t),e.is_hs_composition_extent=!0;var i=new ol.Feature(e);o.feature=i,g.getSource().addFeatures([i])}}),o.$$phase||o.$digest(),o.$broadcast("CompositionsLoaded"),h.loadStatusManagerCompositions(e,r)})}else h.loadStatusManagerCompositions(e,r)},h.loadStatusManagerCompositions=function(e,t){var i=(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+s.status_manager_url,a=e.query,r=a&&angular.isDefined(a.title)&&""!=a.title?"&q="+encodeURIComponent("*"+a.title+"*"):"";i+="?request=list&project="+encodeURIComponent(s.project_name)+"&extent="+t.join(",")+r+"&start=0&limit=1000&sort="+d(e.sortBy),i=m.proxify(i),f=$.ajax({url:i,cache:!1}).done(function(e){angular.isUndefined(h.data.compositions)&&(h.data.compositions=[],h.data.compositionsCount=0),f=null,angular.forEach(e.results,function(o){var e=!1;if(angular.forEach(h.data.compositions,function(t){t.id==o.id&&(angular.isDefined(o.edit)&&(t.editable=o.edit),e=!0)}),!e){o.editable=!1,angular.isDefined(o.edit)&&(o.editable=o.edit),angular.isUndefined(o.link)&&(o.link=(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+s.status_manager_url+"?request=load&id="+o.id),angular.isUndefined(o.thumbnail)&&(o.thumbnail=(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+s.status_manager_url+"?request=loadthumb&id="+o.id);var t={record:o,hs_notqueryable:!0,highlighted:!1};t.geometry=ol.geom.Polygon.fromExtent(n.parseExtent(o.extent)),o.feature=new ol.Feature(t),g.getSource().addFeatures([o.feature]),o&&(h.data.compositions.push(o),h.data.compositionsCount=h.data.compositionsCount+1)}}),o.$$phase||o.$digest()})},h.resetCompositionCounter=function(){h.data.start=0,h.data.next=h.data.limit},h.deleteComposition=function(e){var t=(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+s.status_manager_url+"?request=delete&id="+e.id+"&project="+encodeURIComponent(s.project_name);t=m.proxify(t),f=$.ajax({url:t}).done(function(t){o.$broadcast("compositions.composition_deleted",e.id),h.loadCompositions()})},h.highlightComposition=function(o,e){angular.isDefined(o.feature)&&o.feature.set("highlighted",e)},angular.isDefined(i.map)?u():o.$on("map.loaded",function(){u()}),o.$on("compositions.composition_edited",function(o){n.composition_edited=!0}),o.$on("compositions.load_composition",function(o,e){e=(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+(s.status_manager_url||"/wwwlibs/statusmanager2/index.php")+"?request=load&id="+e,n.load(e)}),o.$on("infopanel.feature_selected",function(o,e,t){if(angular.isDefined(e.get("is_hs_composition_extent"))&&angular.isDefined(e.get("record"))){var i=e.get("record");h.data.useCallbackForEdit=!1,e.set("highlighted",!1),t.getFeatures().clear(),h.loadComposition(i)}}),h.shareComposition=function(i){var n=(a.isMobile()&&s.permalinkLocation?s.permalinkLocation.origin+s.permalinkLocation.pathname:e.protocol()+"://"+location.host+location.pathname)+"?composition="+encodeURIComponent(i.link),r=m.generateUuid();$.ajax({url:(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+s.status_manager_url,cache:!1,method:"POST",async:!1,data:JSON.stringify({request:"socialShare",id:r,url:encodeURIComponent(n),title:i.title,description:i.abstract,image:i.thumbnail||"https://ng.hslayers.org/img/logo.jpg"}),success:function(o){t.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:(s.hostname.user?s.hostname.user.url:s.hostname.status_manager?s.hostname.status_manager.url:s.hostname.default.url)+s.status_manager_url+"?request=socialshare&id="+r}).success(function(o,e,t,i){h.data.shareUrl=o.id}).error(function(o,e,t,i){console.log("Error creating short Url")})}}),h.data.shareTitle=i.title,s.social_hashtag&&h.data.shareTitle.indexOf(s.social_hashtag)<=0&&(h.data.shareTitle+=" "+s.social_hashtag),h.data.shareDescription=i.abstract,o.$$phase||o.$digest(),o.$broadcast("composition.shareCreated",h.data)},h.getCompositionInfo=function(o){return h.data.info=n.loadInfo(o.link),h.data.info.thumbnail=o.thumbnail,h.data.info},h.loadCompositionParser=function(e){var t=e.link;e.title;1==n.composition_edited?o.$broadcast("loadComposition.notSaved",e):h.loadComposition(t,!0)},h.loadComposition=function(o,e){n.load(o,e,h.data.useCallbackForEdit?p:null)},o.$on("core.map_reset",function(o,e){n.composition_loaded=null,n.composition_edited=!1}),o.$on("core.mainpanel_changed",function(o){angular.isDefined(g)&&("composition_browser"===a.mainpanel||"composition"===a.mainpanel?g.setVisible(!0):g.setVisible(!1))}),h}]).controller("hs.compositions.controller",["$scope","$rootScope","$location","$http","hs.map.service","Core","hs.compositions.service_parser","config","hs.permalink.service_url","$compile","$cookies","hs.utils.service","hs.compositions.service",function(o,e,t,i,a,n,s,r,l,c,m,d,p){o.data=p.data,o.pageSize=15,o.compStart=0,o.compNext=o.pageSize,o.panel_name="composition_browser",o.keywords={Basemap:!1,Borders:!1,PhysicalGeography:!1,Demographics:!1,Economics:!1,SocioPoliticalConditions:!1,Culture:!1,Transport:!1,LandUse:!1,Environment:!1,Water:!1,Hazards:!1,Cadastre:!1,Infrastructure:!1,RealEstate:!1,Planning:!1,ComplexInformation:!1},o.sortBy="bbox",o.filter_by_extent=!0,o.getPreviousCompositions=function(){o.compStart-o.pageSize<0?(o.compStart=0,o.compNext=o.pageSize):(o.compStart-=o.pageSize,o.compNext=o.compStart+o.pageSize),o.loadCompositions()},o.getNextCompositions=function(){0!=o.compNext&&(o.compStart=Math.floor(o.compNext/o.pageSize)*o.pageSize,o.compNext+o.pageSize>o.compositionsCount?o.compNext=o.compositionsCount:o.compNext+=o.pageSize,o.loadCompositions())},o.loadCompositions=function(){p.loadCompositions({query:o.query,sortBy:o.sortBy,filterExtent:o.filter_by_extent,keywords:o.keywords,start:o.compStart,limit:o.pageSize})},o.$watch("data.next",function(){o.compNext=o.data.next}),o.mineFilterChanged=function(){angular.isDefined(o.query.editable)&&0==o.query.editable&&delete o.query.editable},o.filterChanged=function(){p.resetCompositionCounter(),o.compStart=0,o.compNext=o.pageSize,o.loadCompositions()},o.confirmDelete=function(e){o.compositionToDelete=e,o.$$phase||o.$digest(),$("#hs-dialog-area #composition-delete-dialog").remove();var t=angular.element("<div hs.compositions.delete_dialog_directive></span>");$("#hs-dialog-area").append(t),c(t)(o)},o.delete=function(o){p.deleteComposition(o)},o.edit=function(e){o.data.useCallbackForEdit=!0,p.loadComposition(e)},o.highlightComposition=function(o,e){p.highlightComposition(o,e)},o.$on("map.extent_changed",function(e,t,i){"composition_browser"!=n.mainpanel&&"composition"!=n.mainpanel||o.filter_by_extent&&o.loadCompositions()}),o.shareComposition=function(e){p.shareComposition(e),$("#hs-dialog-area #composition-share-dialog").remove();var t=angular.element("<div hs.compositions.share_dialog_directive></div>");$("#hs-dialog-area").append(t),c(t)(o)},o.detailComposition=function(e){o.info=p.getCompositionInfo(e),o.$$phase||o.$digest(),$("#hs-dialog-area #composition-info-dialog").remove();var t=angular.element("<div hs.compositions.info_dialog_directive></span>");$("#hs-dialog-area").append(t),c(t)(o)},o.loadComposition=function(o){p.loadCompositionParser(o)},o.overwrite=function(){p.loadComposition(o.composition_to_be_loaded,!0)},o.add=function(){p.loadComposition(o.composition_to_be_loaded,!1)},o.save=function(){n.openStatusCreator()},o.setSortAttribute=function(e){o.sortBy=e,o.loadCompositions()},o.toggleKeywords=function(){$(".keywords-panel").slideToggle()},o.$on("CompositionLoaded",function(){$(".tooltip").remove(),$('[data-toggle="tooltip"]').tooltip()}),o.$on("compositions.composition_deleted",function(){$("#hs-dialog-area #composition-delete-dialog").remove()}),o.$on("loadComposition.notSaved",function(e,t){var i="#composition-overwrite-dialog";if(o.composition_to_be_loaded=t.link,o.composition_name_to_be_loaded=t.title,0==$("#hs-dialog-area "+i).length){var a=angular.element("<div hs.compositions.overwrite_dialog_directive></span>");$("#hs-dialog-area").append(a),c(a)(o)}else $(i).modal("show")}),o.$on("core.mainpanel_changed",function(e){"composition_browser"!==n.mainpanel&&"composition"!==n.mainpanel||o.loadCompositions()}),o.$emit("scope_loaded","Compositions")}])});