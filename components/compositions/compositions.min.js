define(["angular","ol","SparqlJson","angularjs-socialshare","map","ows.nonwms","config_parsers"],function(angular,ol,e,o){angular.module("hs.compositions",["720kb.socialshare","hs.map","hs.core","hs.ows.nonwms","hs.compositions.config_parsers"]).directive("hs.compositions.directive",function(){return{templateUrl:hsl_path+"components/compositions/partials/compositions.html?bust="+gitsha,link:function(e,o){$(".mid-pane").css("margin-top","0px"),$(".keywords-panel").hide()}}}).directive("hs.compositions.overwriteDialogDirective",function(){return{templateUrl:hsl_path+"components/compositions/partials/dialog_overwriteconfirm.html?bust="+gitsha,link:function(e,o,t){$("#composition-overwrite-dialog").modal("show")}}}).directive("hs.compositions.deleteDialogDirective",function(){return{templateUrl:hsl_path+"components/compositions/partials/dialog_delete.html?bust="+gitsha,link:function(e,o,t){$("#composition-delete-dialog").modal("show")}}}).directive("hs.compositions.shareDialogDirective",function(){return{templateUrl:hsl_path+"components/compositions/partials/dialog_share.html?bust="+gitsha,link:function(e,o,t){$("#composition-share-dialog").modal("show")}}}).directive("hs.compositions.infoDialogDirective",function(){return{templateUrl:hsl_path+"components/compositions/partials/dialog_info.html?bust="+gitsha,link:function(e,o,t){$("#composition-info-dialog").modal("show")}}}).service("hs.compositions.service_parser",["hs.map.service","config","Core","$rootScope","hs.utils.service","hs.ows.nonwms.service","hs.compositions.config_parsers.service",function(e,o,t,i,a,s,n){var r={composition_loaded:null,composition_edited:!1,utils:a,current_composition_title:"",load:function(s,n,l,c){r.current_composition_url=s,s=s.replace("&amp;","&"),s=a.proxify(s),$.ajax({url:s}).done(function(a){if(1==a.success){r.composition_loaded=s,void 0!==c&&(a=c(a)),i.$broadcast("compositions.composition_loading",a),(angular.isUndefined(n)||1==n)&&r.removeCompositionLayers(),r.current_composition=a.data||a,r.current_composition_title=a.title||a.data.title,e.map.getView().fit(r.parseExtent(a.extent||a.data.extent),e.map.getSize());for(var m=r.jsonToLayers(a),u=0;u<m.length;u++)e.map.addLayer(m[u]);angular.isObject(a.data.current_base_layer)&&e.map.getLayers().forEach(function(e){e.get("title")==a.data.current_base_layer.title&&e.setVisible(!0)}),o.open_lm_after_comp_loaded&&t.setMainPanel("layermanager"),r.composition_edited=!1,i.$broadcast("compositions.composition_loaded",a),void 0!==l&&null!==l&&l()}else{var p={};switch(p.error=a.error,a.error){case"no data":p.title="Composition not found",p.abstract="Sorry but composition was deleted or incorrectly saved"}i.$broadcast("compositions.composition_loaded",p)}})},removeCompositionLayers:function(){var o=[];for(e.map.getLayers().forEach(function(e){e.get("from_composition")&&o.push(e)});o.length>0;)e.map.removeLayer(o.shift())},loadInfo:function(e){var o={};return e=e.replace("&amp;","&"),e=a.proxify(e),$.ajax({url:e,async:!1}).done(function(e){o=e.data||e,i.$broadcast("compositions.composition_info_loaded",e)}),o},parseExtent:function(o){"string"==typeof o&&(o=o.split(" "));var t=[parseFloat(o[0]),parseFloat(o[1])],i=[parseFloat(o[2]),parseFloat(o[3])];return t=ol.proj.transform(t,"EPSG:4326",e.map.getView().getProjection()),i=ol.proj.transform(i,"EPSG:4326",e.map.getView().getProjection()),[t[0],t[1],i[0],i[1]]},jsonToLayers:function(e){var o=[];e.data&&(e=e.data);for(var t=0;t<e.layers.length;t++){var i=e.layers[t];o.push(r.jsonToLayer(i))}return o}};return r.jsonToLayer=function(e){switch(e.className){case"HSLayers.Layer.WMS":return n.createWmsLayer(e);case"OpenLayers.Layer.Vector":return n.createVectorLayer(e)}},r}]).controller("hs.compositions.controller",["$scope","$rootScope","$location","$http","hs.map.service","Core","hs.compositions.service_parser","config","hs.permalink.service_url","$compile","$cookies","hs.utils.service",function(e,o,t,i,a,s,n,r,l,c,m,u){function p(){s.openStatusCreator()}function d(){if(g=new ol.layer.Vector({title:"Composition extents",show_in_manager:!1,source:new ol.source.Vector,style:function(e,o){return[new ol.style.Style({stroke:new ol.style.Stroke({color:"#005CB6",width:e.get("highlighted")?4:1}),fill:new ol.style.Fill({color:"rgba(0, 0, 255, 0.01)"})})]}}),a.map.on("pointermove",function(o){var t=g.getSource().getFeaturesAtCoordinate(o.coordinate),i=!1;$(g.getSource().getFeatures()).each(function(){this.get("record").highlighted&&(this.get("record").highlighted=!1,i=!0)}),t.length&&$(t).each(function(){this.get("record").highlighted||(this.get("record").highlighted=!0,i=!0)}),i&&!e.$$phase&&e.$digest()}),angular.isDefined(m.get("hs_layers"))&&1!=window.permalinkApp){for(var o=m.get("hs_layers"),t=n.jsonToLayers(JSON.parse(o)),i=0;i<t.length;i++)a.map.addLayer(t[i]);m.remove("hs_layers")}a.map.addLayer(g)}e.page_size=15,e.panel_name="composition_browser",e.keywords={Basemap:!1,Borders:!1,PhysicalGeography:!1,Demographics:!1,Economics:!1,SocioPoliticalConditions:!1,Culture:!1,Transport:!1,LandUse:!1,Environment:!1,Water:!1,Hazards:!1,Cadastre:!1,Infrastructure:!1,RealEstate:!1,Planning:!1,ComplexInformation:!1},e.sort_by="bbox",e.sort_by_attr_for_statusmanager=encodeURIComponent('[{"property":"bbox","direction":"ASC"}]'),e.filter_by_extent=!0,e.use_callback_for_edit=!1,e.getPreviousCompositions=function(){e.compStart-e.page_size<0?(e.compStart=0,e.compNext=e.page_size):(e.compStart-=e.page_size,e.compNext=e.compStart+e.page_size),e.loadCompositions()},e.getNextCompositions=function(){0!=e.compNext&&(e.compStart=Math.floor(e.compNext/e.page_size)*e.page_size,e.compNext+e.page_size>e.compositionsCount?e.compNext=e.compositionsCount:e.compNext+=e.page_size,e.loadCompositions())};var h=null;e.loadCompositions=function(){var o=a.map.getSize(),t=angular.isDefined(o)?a.map.getView().calculateExtent(o):[0,0,100,100],i=ol.proj.transformExtent(t,a.map.getView().getProjection(),"EPSG:4326");if(angular.isDefined(r.compositions_catalogue_url)){g.getSource().clear();var s=e.query&&angular.isDefined(e.query.title)&&""!=e.query.title?encodeURIComponent(" AND title like '*"+e.query.title+"*' OR abstract like '*"+e.query.title+"*'"):"",l="",c=[];angular.forEach(e.keywords,function(e,o){e&&c.push("subject='"+o+"'")}),c.length>0&&(l=encodeURIComponent(" AND ("+c.join(" OR ")+")"));var m=r.compositions_catalogue_url.indexOf("cswClientRun.php")>0?",":" ",p=r.compositions_catalogue_url.indexOf("cswClientRun.php")>0?"serviceName=p4b&":"",d=e.filter_by_extent?encodeURIComponent(" and BBOX='"+i.join(m)+"'"):"",_=(r.hostname.user?r.hostname.user.url:r.hostname.compositions_catalogue?r.hostname.compositions_catalogue.url:r.hostname.default.url)+r.compositions_catalogue_url+"?format=json&"+p+"query=type%3Dapplication"+d+s+l+"&lang=eng&sortBy="+e.sort_by+"&detail=summary&start="+e.compStart+"&limit="+e.page_size;_=u.proxify(_),null!=h&&h.abort(),h=$.ajax({url:_}).done(function(o){h=null,$(".tooltip").remove(),e.compositions=o.records,o.records&&o.records.length>0?e.compositionsCount=o.matched:e.compositionsCount=0,e.compNext=o.next,angular.forEach(e.compositions,function(e){var o={record:e,hs_notqueryable:!0,highlighted:!1};e.editable=!1,angular.isUndefined(e.thumbnail)&&(e.thumbnail=(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+r.status_manager_url+"?request=loadthumb&id="+e.id);var i=n.parseExtent(e.bbox);if(!(i[0]<t[0]&&i[2]>t[2]||i[1]<t[1]&&i[3]>t[3])){o.geometry=ol.geom.Polygon.fromExtent(i),o.is_hs_composition_extent=!0;var a=new ol.Feature(o);e.feature=a,g.getSource().addFeatures([a])}}),e.$$phase||e.$digest(),$('[data-toggle="tooltip"]').tooltip(),e.loadStatusManagerCompositions(i)})}else e.loadStatusManagerCompositions(i)},e.loadStatusManagerCompositions=function(o){var t=(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+r.status_manager_url,i=e.query&&angular.isDefined(e.query.title)&&""!=e.query.title?"&q="+encodeURIComponent("*"+e.query.title+"*"):"";t+="?request=list&project="+encodeURIComponent(r.project_name)+"&extent="+o.join(",")+i+"&start=0&limit=1000&sort="+e.sort_by_attr_for_statusmanager,t=u.proxify(t),h=$.ajax({url:t,cache:!1}).done(function(o){angular.isUndefined(e.compositions)&&(e.compositions=[],e.compositionsCount=0),h=null,angular.forEach(o.results,function(o){var t=!1;if(angular.forEach(e.compositions,function(e){e.id==o.id&&(angular.isDefined(o.edit)&&(e.editable=o.edit),t=!0)}),!t){o.editable=!1,angular.isDefined(o.edit)&&(o.editable=o.edit),angular.isUndefined(o.link)&&(o.link=(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+r.status_manager_url+"?request=load&id="+o.id),angular.isUndefined(o.thumbnail)&&(o.thumbnail=(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+r.status_manager_url+"?request=loadthumb&id="+o.id);var i={record:o,hs_notqueryable:!0,highlighted:!1};i.geometry=ol.geom.Polygon.fromExtent(n.parseExtent(o.extent)),o.feature=new ol.Feature(i),g.getSource().addFeatures([o.feature]),o&&(e.compositions.push(o),e.compositionsCount=e.compositionsCount+1)}}),e.$$phase||e.$digest()})},e.mineFilterChanged=function(){angular.isDefined(e.query.editable)&&0==e.query.editable&&delete e.query.editable},e.filterChanged=function(){e.compStart=0,e.compNext=e.page_size,e.loadCompositions()},e.confirmDelete=function(o){e.compositionToDelete=o,e.$$phase||e.$digest(),$("#hs-dialog-area #composition-delete-dialog").remove();var t=angular.element("<div hs.compositions.delete_dialog_directive></span>");$("#hs-dialog-area").append(t),c(t)(e)},e.delete=function(t){var i=(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+r.status_manager_url+"?request=delete&id="+t.id+"&project="+encodeURIComponent(r.project_name);i=u.proxify(i),h=$.ajax({url:i}).done(function(i){o.$broadcast("compositions.composition_deleted",t.id),e.loadCompositions(),$("#hs-dialog-area #composition-delete-dialog").remove()})},e.edit=function(o){e.use_callback_for_edit=!0,e.loadComposition(o)},e.highlightComposition=function(e,o){angular.isDefined(e.feature)&&e.feature.set("highlighted",o)};var g;if(angular.isDefined(a.map)?d():o.$on("map.loaded",function(){d()}),o.$on("compositions.composition_edited",function(e){n.composition_edited=!0}),o.$on("compositions.load_composition",function(e,o){o=(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+(r.status_manager_url||"/wwwlibs/statusmanager2/index.php")+"?request=load&id="+o,n.load(o)}),o.$on("infopanel.feature_selected",function(o,t,i){if(angular.isDefined(t.get("is_hs_composition_extent"))&&angular.isDefined(t.get("record"))){var a=t.get("record");e.use_callback_for_edit=!1,t.set("highlighted",!1),i.getFeatures().clear(),e.loadComposition(a)}}),e.$on("map.extent_changed",function(o,t,i){"composition_browser"==e.Core.mainpanel&&e.filter_by_extent&&e.loadCompositions()}),e.shareComposition=function(o){var a=(s.isMobile()&&r.permalinkLocation?r.permalinkLocation.origin+r.permalinkLocation.pathname:t.protocol()+"://"+location.host+location.pathname)+"?composition="+encodeURIComponent(o.link),n=u.generateUuid();$.ajax({url:(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+r.status_manager_url,cache:!1,method:"POST",async:!1,data:JSON.stringify({request:"socialShare",id:n,url:encodeURIComponent(a),title:o.title,description:o.abstract,image:o.thumbnail||"https://ng.hslayers.org/img/logo.jpg"}),success:function(o){i.post("https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDn5HGT6LDjLX-K4jbcKw8Y29TRgbslfBw",{longUrl:(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+r.status_manager_url+"?request=socialshare&id="+n}).success(function(o,t,i,a){e.shareUrl=o.id}).error(function(e,o,t,i){console.log("Error creating short Url")})}}),e.shareTitle=o.title,r.social_hashtag&&e.shareTitle.indexOf(r.social_hashtag)<=0&&(e.shareTitle+=" "+r.social_hashtag),e.shareDescription=o.abstract,e.$$phase||e.$digest(),$("#hs-dialog-area #composition-share-dialog").remove();var l=angular.element("<div hs.compositions.share_dialog_directive></div>");$("#hs-dialog-area").append(l),c(l)(e)},e.detailComposition=function(o){e.info=n.loadInfo(o.link),e.info.thumbnail=o.thumbnail,e.$$phase||e.$digest(),$("#hs-dialog-area #composition-info-dialog").remove();var t=angular.element("<div hs.compositions.info_dialog_directive></span>");$("#hs-dialog-area").append(t),c(t)(e)},e.loadComposition=function(o){var t=o.link,i=o.title;if(1==n.composition_edited){var a="#composition-overwrite-dialog";if(e.composition_to_be_loaded=t,e.composition_name_to_be_loaded=i,0==$("#hs-dialog-area "+a).length){var s=angular.element("<div hs.compositions.overwrite_dialog_directive></span>");$("#hs-dialog-area").append(s),c(s)(e)}else $(a).modal("show")}else n.load(t,!0,e.use_callback_for_edit?p:null)},e.overwrite=function(){n.load(e.composition_to_be_loaded,!0,e.use_callback_for_edit?p:null)},e.add=function(){n.load(e.composition_to_be_loaded,!1,e.use_callback_for_edit?p:null)},e.save=function(){s.openStatusCreator()},e.setSortAttribute=function(o){e.sort_by=o;var t={bbox:'[{"property":"bbox","direction":"ASC"}]',title:'[{"property":"title","direction":"ASC"}]',date:'[{"property":"date","direction":"ASC"}]'};e.sort_by_attr_for_statusmanager=encodeURIComponent(t[o]),e.loadCompositions()},e.toggleKeywords=function(){$(".keywords-panel").slideToggle()},l.getParamValue("composition")){var _=l.getParamValue("composition");-1==_.indexOf("http")&&-1==_.indexOf(r.status_manager_url)&&(_=(r.hostname.user?r.hostname.user.url:r.hostname.status_manager?r.hostname.status_manager.url:r.hostname.default.url)+(r.status_manager_url||"/wwwlibs/statusmanager2/index.php")+"?request=load&id="+_),n.load(_)}e.$on("core.map_reset",function(e,o){n.composition_loaded=null,n.composition_edited=!1}),e.$emit("scope_loaded","Compositions"),o.$on("core.mainpanel_changed",function(o){angular.isDefined(g)&&(g.setVisible(s.panelVisible(e.panel_name,e)),"composition_browser"==s.mainpanel&&e.loadCompositions())})}])});